/*
 * Пример программы для AT89S4051: Мигание светодиодом
 * 
 * Эта программа демонстрирует основные возможности HCL компилятора:
 * - Использование расширений для 8051 (sbit, sfr)
 * - Обработчики прерываний
 * - Работа с портами ввода-вывода
 * - Циклы и условные операторы
 */

#include <at89s4051.h>

// Определения портов и битов
sfr P1 = 0x90;          // Порт P1
sbit LED = P1^0;        // Светодиод на P1.0
sbit BUTTON = P1^1;     // Кнопка на P1.1

// Глобальные переменные
volatile unsigned char timer_count = 0;
volatile bit blink_enable = 1;

/*
 * Обработчик прерывания от таймера 0
 * Вызывается каждые 50мс для создания задержки
 */
void timer0_isr() interrupt 1 using 2 {
    // Перезагружаем таймер для получения интервала 50мс
    TH0 = 0x3C;    // Старший байт
    TL0 = 0xB0;    // Младший байт
    
    timer_count++;
    
    // Переключаем светодиод каждые 500мс (10 * 50мс)
    if (timer_count >= 10) {
        if (blink_enable) {
            LED = !LED;
        }
        timer_count = 0;
    }
}

/*
 * Инициализация таймера 0
 */
void init_timer0() {
    // Настройка таймера 0 в режиме 1 (16-битный)
    TMOD = 0x01;
    
    // Загружаем начальное значение для получения интервала 50мс
    // При частоте 12МГц: 65536 - 50000 = 15536 = 0x3CB0
    TH0 = 0x3C;
    TL0 = 0xB0;
    
    // Разрешаем прерывание от таймера 0
    ET0 = 1;
    EA = 1;
    
    // Запускаем таймер
    TR0 = 1;
}

/*
 * Инициализация портов
 */
void init_ports() {
    // Настраиваем P1.0 как выход (LED)
    // P1.1 как вход (BUTTON) - по умолчанию
    LED = 0;  // Выключаем светодиод
}

/*
 * Функция задержки (программная)
 */
void delay_ms(unsigned int ms) {
    unsigned int i, j;
    for (i = 0; i < ms; i++) {
        for (j = 0; j < 120; j++) {
            // Пустой цикл для создания задержки
            // Примерно 1мс при частоте 12МГц
        }
    }
}

/*
 * Проверка состояния кнопки
 */
bit is_button_pressed() {
    static bit last_state = 1;  // Кнопка подтянута к VCC
    bit current_state = BUTTON;
    
    // Детектируем нажатие (переход от 1 к 0)
    if (last_state == 1 && current_state == 0) {
        delay_ms(50);  // Антидребезг
        last_state = current_state;
        return 1;
    }
    
    last_state = current_state;
    return 0;
}

/*
 * Главная функция
 */
int main() {
    // Инициализация системы
    init_ports();
    init_timer0();
    
    // Основной цикл программы
    while (1) {
        // Проверяем нажатие кнопки
        if (is_button_pressed()) {
            // Переключаем режим мигания
            blink_enable = !blink_enable;
            
            // Если мигание отключено, выключаем светодиод
            if (!blink_enable) {
                LED = 0;
            }
        }
        
        // Небольшая задержка для экономии энергии
        delay_ms(10);
    }
    
    return 0;  // Никогда не достигается
} 