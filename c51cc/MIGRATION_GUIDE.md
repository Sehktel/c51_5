# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ C51

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

**–í–ê–ñ–ù–û**: –ù–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä v2 –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–ü–û–õ–ù–£–Æ –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å–æ —Å—Ç–∞—Ä—ã–º API. –í–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π!

## üìã –°—Ä–∞–≤–Ω–µ–Ω–∏–µ API

### –°—Ç–∞—Ä—ã–π API (v1)
```clojure
;; –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
(require '[c51cc.preprocessor :as pp])

(def result (pp/preprocess code options))
;; result ‚Üí String
```

### –ù–æ–≤—ã–π API (v2)
```clojure
;; –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
(require '[c51cc.preprocessor-v2 :as pp2])

(def result (pp2/preprocess-v2 code options))
;; result ‚Üí {:result String, :errors [], :success Boolean, :final-state State}
```

## üîß –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–§—É–Ω–∫—Ü–∏—è `preprocess` –≤ `c51cc.preprocessor` —è–≤–ª—è–µ—Ç—Å—è **wrapper'–æ–º** –≤–æ–∫—Ä—É–≥ –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞:

```clojure
(defn preprocess [code options]
  ;; –í—ã–∑—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
  (let [result (pp2/preprocess-v2 code options)]
    (if (:success result)
      ;; –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
      (:result result)
      ;; –í —Å–ª—É—á–∞–µ –æ—à–∏–±–æ–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      (str (:result result) 
           "\n// –û–®–ò–ë–ö–ò –ü–†–ï–ü–†–û–¶–ï–°–°–û–†–ê:\n"
           (str/join "\n" (map #(str "// " (:message %)) (:errors result)))))))
```

## üöÄ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

### 1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤)

```clojure
;; –ë—ã–ª–æ:
(def processed-code (preprocess source-code {:defines {"DEBUG" "1"}}))

;; –°—Ç–∞–ª–æ:
(let [result (preprocess-v2 source-code {:defines {"DEBUG" "1"}})]
  (if (:success result)
    (def processed-code (:result result))
    (handle-errors (:errors result))))
```

### 2. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

```clojure
;; –≠—Ç–∞–ø 1: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞—Ä—ã–π API (—Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ wrapper)
(def result (preprocess code options))

;; –≠—Ç–∞–ø 2: –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
(let [v2-result (preprocess-v2 code options)]
  (when-not (:success v2-result)
    (log-errors (:errors v2-result)))
  (def result (:result v2-result)))

;; –≠—Ç–∞–ø 3: –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–æ–≤—ã–π API
(def result (preprocess-v2 code options))
```

### 3. –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥

```clojure
(defn smart-preprocess [code options]
  (let [result (preprocess-v2 code options)]
    (if (:success result)
      ;; –£—Å–ø–µ—Ö - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      (:result result)
      ;; –û—à–∏–±–∫–∏ - –ª–æ–≥–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —á–∞—Å—Ç–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      (do
        (log/error "–û—à–∏–±–∫–∏ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞:" (:errors result))
        (:result result)))))
```

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ API

### 1. –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
```clojure
{:errors [{:message "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: missing.h"
           :line 5
           :file "main.c"
           :type :include-error}]}
```

### 2. –ö–æ–Ω—Ç—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
```clojure
(let [result (preprocess-v2 code options)]
  (if (:success result)
    (compile (:result result))
    (show-errors (:errors result))))
```

### 3. –î–æ—Å—Ç—É–ø –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
```clojure
(let [result (preprocess-v2 code options)
      final-defines (:defines (:final-state result))]
  (println "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã:" final-defines))
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:

```bash
# –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç
clojure -M test_compatibility.clj

# –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç
clojure -M test_comprehensive_compatibility.clj
```

## üîç –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–¥ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–ø—Ü–∏–∏**: –ù–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥ –∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–æ–≤—ã–π API**: –ü–æ–ª—É—á–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–∞—Ö

```clojure
;; –û—Ç–ª–∞–¥–∫–∞ —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π API
(let [result (preprocess-v2 problematic-code options)]
  (println "–£—Å–ø–µ—Ö:" (:success result))
  (println "–û—à–∏–±–∫–∏:" (:errors result))
  (println "–†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result)))
```

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

–ù–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **transducers** –∏ **protocols**, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- ‚ö° –õ—É—á—à—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- üß© –ú–æ–¥—É–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É  
- üîß –õ–µ–≥–∫—É—é —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
- ‚úÖ –õ—É—á—à—É—é —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤:
- ‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `preprocess` - –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ wrapper
- ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ `preprocess-v2` –¥–ª—è –ª—É—á—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

### –î–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤:
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `preprocess-v2` —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ `:errors` –∏ `:success`

## üîó –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ v2](docs/preprocessor-v2-architecture.md)
- [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](examples/)
- [–¢–µ—Å—Ç—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏](test_comprehensive_compatibility.clj)

---

**–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**: –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–µ—Å–ø–µ—á–µ–Ω–∞. –í–∞—à –∫–æ–¥ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –Ω–æ–≤—ã–π API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –ª—É—á—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∏ –æ—Ç–ª–∞–¥–∫–∏. 