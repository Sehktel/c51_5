# üî¨ –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ FSM + Spec –≤ Clojure

## üéì –ú–µ—Ç–æ–¥–∏–∫–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ FSM + Spec

### –£—Ä–æ–≤–µ–Ω—å 1: –ë–∞–∑–æ–≤–æ–µ –≤–≤–µ–¥–µ–Ω–∏–µ

–ê–Ω–∞–ª–æ–≥–∏—è: 
- FSM (–ö–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç) - –∫–∞–∫ –∫–æ–Ω–≤–µ–π–µ—Ä –Ω–∞ –∑–∞–≤–æ–¥–µ
- Spec - –∫–∞–∫ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –∫–∞—á–µ—Å—Ç–≤–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

```clojure
(def factory-fsm 
  {:stages 
   [:raw-material   ; –í—Ö–æ–¥—è—â–µ–µ —Å—ã—Ä—å–µ
    :processing     ; –û–±—Ä–∞–±–æ—Ç–∫–∞
    :quality-check  ; –ü—Ä–æ–≤–µ—Ä–∫–∞
    :packaging      ; –£–ø–∞–∫–æ–≤–∫–∞
    :shipping]})    ; –û—Ç–ø—Ä–∞–≤–∫–∞
```

### –£—Ä–æ–≤–µ–Ω—å 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫

```clojure
(ns learning.hybrid-parsing)

;; 1. –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ - "–ø–∞—Å–ø–æ—Ä—Ç" –æ–±—ä–µ–∫—Ç–∞
(s/def ::raw-material 
  (s/and 
   vector?                ; –î–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–µ–∫—Ç–æ—Ä–æ–º
   #(every? number? %)    ; –°–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–∞
   #(> (count %) 2)))     ; –ë–æ–ª—å—à–µ 2 —ç–ª–µ–º–µ–Ω—Ç–æ–≤

(s/def ::processed-item 
  (s/keys :req-un [::weight ::quality]))

;; 2. FSM —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
(def production-fsm 
  {:initial-state :raw-material
   :states 
   {:raw-material 
    {:transitions 
     [{:next-state :processing
       ;; –í—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
       :validation 
       (fn [material]
         (s/valid? ::raw-material material))}]}
    
    :processing 
    {:transitions 
     [{:next-state :quality-check
       :validation 
       (fn [item]
         (s/valid? ::processed-item item))}]}
    
    :quality-check 
    {:transitions 
     [{:next-state :packaging
       :validation 
       (fn [item]
         (and 
          (> (:quality item) 0.7)  ; –°–≤–æ—è –ª–æ–≥–∏–∫–∞
          (s/valid? ::processed-item item)))}]}}})

;; 3. –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –ø–æ FSM
(defn process-item [item]
  (let [fsm production-fsm]
    (reduce 
     (fn [current-state next-stage]
       (let [stage-config (get-in fsm [:states current-state])
             valid-transition 
             (first 
              (filter 
               #((:validation %) item) 
               (:transitions stage-config)))]
         (if valid-transition
           (:next-state valid-transition)
           (throw (ex-info "–ù–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É" 
                            {:item item 
                             :stage current-state})))))
     (:initial-state fsm)
     (keys (:states fsm)))))
```

## üîç –ú–µ—Ç–æ–¥–∏–∫–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞–º

### –≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è
1. FSM - —ç—Ç–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–π
2. Spec - —ç—Ç–æ "–ø–∞—Å–ø–æ—Ä—Ç" –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
3. –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ = FSM + –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

### –≠—Ç–∞–ø 2: –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è

```clojure
;; –ü—Ä–∏–º–µ—Ä –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è
(def sample-material [1 2 3])
(def processed-item 
  {:weight 10 
   :quality 0.8})

;; –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
(process-item sample-material)
;; => :processing –∏–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
```

## üöÄ –ì–¥–µ –∏ –∫–∞–∫ –≤—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏

### 1. –í –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö –º–µ–∂–¥—É —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
- `:validation` —Ñ—É–Ω–∫—Ü–∏—è
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true/false`
- –†–µ—à–∞–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–π—Ç–∏ –≤ —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### 2. –¢–∏–ø—ã –ø—Ä–æ–≤–µ—Ä–æ–∫
```clojure
;; –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
(s/valid? ::spec-name data)

;; –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞
(and 
 (s/valid? ::spec-name data)
 (custom-check data))
```

### 3. –£—Ä–æ–≤–Ω–∏ –ø—Ä–æ–≤–µ—Ä–æ–∫
- –í—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ
- –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

## üí° –ü–µ–¥–∞–≥–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã

1. –†–∏—Å—É–π—Ç–µ —Å—Ö–µ–º—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–Ω–∞–ª–æ–≥–∏–∏ (–∫–æ–Ω–≤–µ–π–µ—Ä, –∑–∞–≤–æ–¥)
3. –ü–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã
4. –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–π—Ç–µ —ç–≤–æ–ª—é—Ü–∏—é –ø–æ–¥—Ö–æ–¥–∞

## üé≤ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤

```clojure
;; –ó–∞–¥–∞–Ω–∏–µ: –°–æ–∑–¥–∞—Ç—å FSM –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
(s/def ::username string?)
(s/def ::age int?)
(s/def ::user 
  (s/keys :req-un [::username ::age]))

;; Homework: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å FSM —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
;; - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏
;; - –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞
;; - –§–∏–Ω–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
```

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
1. –ó–∞—á–µ–º –Ω—É–∂–Ω—ã —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏?
2. –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω –∫–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç?
3. –ì–¥–µ –≤—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∏?
4. –ö–∞–∫–∏–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞?

## üåü –†–µ–∑—é–º–µ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤

–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ FSM + Spec - —ç—Ç–æ:
- –ì–∏–±–∫–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–π
- –°—Ç—Ä–æ–≥–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–æ–∫
- –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è
- –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞**: 1.0.0
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è**: [–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞] 