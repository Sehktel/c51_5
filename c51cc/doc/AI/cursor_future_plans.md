# –ü–ª–∞–Ω—ã –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞
_Exported on 5/27/2025 at 20:46:59 GMT+3 from Cursor (0.50.5)_

---

**User**

–ü–ª–∞–Ω—ã –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞, –∫–∞–∫–∏–µ –æ–Ω–∏?
–°–µ–π—á–∞—Å –ø–æ–∫–∞ —Å—Ç–æ–∏—Ç –≤–æ–ø—Ä–æ—Å —Å –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º –∏ –µ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥ –≤ –º–æ–Ω–æ–∏–¥–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ø–∞—Ä—Å–µ—Ä–∞.
–î–æ–ø—É—Å—Ç–∏—Ç–º —ç—Ç–æ –µ—Å—Ç—å. –ß—Ç–æ –¥–∞–ª—å—à–µ?
AST –∏ IR –ß—Ç–æ —Å –Ω–∏–º–∏? 

---

**Cursor**

–î–∞–≤–∞–π—Ç–µ —Å–Ω–∞—á–∞–ª–∞ –∏–∑—É—á–∏–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –ø–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è.

–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –ò–∑—É—á–∏–≤ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ C51, —è –≤–∏–∂—É –≤–ø–µ—á–∞—Ç–ª—è—é—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –º–æ–≥—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è. –ü–æ–∑–≤–æ–ª—å—Ç–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

–í–∞—à –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä —É–∂–µ –∏–º–µ–µ—Ç —Å–æ–ª–∏–¥–Ω—É—é –æ—Å–Ω–æ–≤—É:
- ‚úÖ **–ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä**: –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π C89
- ‚úÖ **–õ–µ–∫—Å–µ—Ä**: –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π C51-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π  
- ‚úÖ **–ü–∞—Ä—Å–µ—Ä**: –ú–æ–Ω–∞–¥–∏—á–µ—Å–∫–∏–µ –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä—ã —Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º
- ‚úÖ **AST**: –ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤ —Å visitor pattern
- ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: –î–µ—Ç–∞–ª—å–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è ABI –¥–ª—è AT89S4051

## ü§î –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–æ–≤

### –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä ‚Üí –ú–æ–Ω–æ–∏–¥–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

**–í–∞—à –ø–ª–∞–Ω**: –ü–µ—Ä–µ—Ö–æ–¥ –∫ –º–æ–Ω–æ–∏–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ  
**–ú–æ–π –∞–Ω–∞–ª–∏–∑**: –Ø –≤–∏–∂—É, —á—Ç–æ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –º–æ–Ω–∞–¥–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞! –ù–æ –ø–æ–∑–≤–æ–ª—å—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å **–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É**:

#### üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ 1: Transducer-based –ø–æ–¥—Ö–æ–¥
```clojure
;; –í–º–µ—Å—Ç–æ –º–æ–Ω–∞–¥ - –∫–æ–º–ø–æ–∑–∏—Ä—É–µ–º—ã–µ —Ç—Ä–∞–Ω—Å–¥—å—é—Å–µ—Ä—ã
(def preprocess-pipeline
  (comp
    (map remove-comments)
    (map expand-macros)
    (filter should-include?)
    (map resolve-includes)))

;; –ë–æ–ª–µ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
(defn preprocess [source]
  (transduce preprocess-pipeline conj [] (str/split-lines source)))
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**:
- üöÄ –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (lazy evaluation)
- üß© –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ä—É–µ–º–æ—Å—Ç—å
- üìñ –ü—Ä–æ—â–µ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã
- üîß –õ–µ–≥—á–µ –æ—Ç–ª–∞–¥–∫–∞

#### üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ 2: Protocol-based –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```clojure
(defprotocol PreprocessorStage
  (process-stage [stage input state])
  (stage-name [stage])
  (can-handle? [stage directive]))

;; –†–∞—Å—à–∏—Ä—è–µ–º–∞—è —Å–∏—Å—Ç–µ–º–∞ —ç—Ç–∞–ø–æ–≤
(defrecord MacroExpander []
  PreprocessorStage
  (process-stage [_ input state] ...)
  (stage-name [_] "macro-expansion")
  (can-handle? [_ directive] (= directive :define)))
```

### –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –ø–∞—Ä—Å–µ—Ä–∞

**–í–∞—à –ø–ª–∞–Ω**: –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥  
**–ú–æ–π –≤–æ–ø—Ä–æ—Å**: –ê –Ω—É–∂–Ω–æ –ª–∏? –¢–µ–∫—É—â–∏–π –ø–∞—Ä—Å–µ—Ä —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ–Ω–∞–¥–∏—á–µ—Å–∫–∏–µ –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä—ã!

#### üéØ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: –§–æ–∫—É—Å –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
–í–º–µ—Å—Ç–æ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ:

```clojure
;; –ú–µ–º–æ–∏–∑–∞—Ü–∏—è –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–∞—Ä—Å–µ—Ä–æ–≤
(def memoized-parse-expression 
  (memoize parse-expression))

;; –õ–µ–Ω–∏–≤—ã–µ –ø–∞—Ä—Å–µ—Ä—ã –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
(defn lazy-parse [tokens]
  (lazy-seq
    (when-let [token (first tokens)]
      (cons (parse-statement token) 
            (lazy-parse (rest tokens))))))
```

## üöÄ AST –∏ IR: –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω

### –¢–µ–∫—É—â–∏–π AST ‚Üí –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (IR)

–í–∞—à AST —É–∂–µ –æ—Ç–ª–∏—á–Ω—ã–π! –ù–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞ –Ω—É–∂–µ–Ω IR. –ü—Ä–µ–¥–ª–∞–≥–∞—é **—Ç—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É**:

#### 1Ô∏è‚É£ High-level IR (HIR) - –ë–ª–∏–∑–∫–æ –∫ AST
```clojure
(defrecord HIR-Node [op args type metadata])

;; –ü—Ä–∏–º–µ—Ä: for-loop ‚Üí while-loop —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è
(defn lower-for-to-while [for-node]
  (hir-node :block
    [(hir-node :assign (:init for-node))
     (hir-node :while (:condition for-node)
       [(hir-node :block (:body for-node))
        (hir-node :assign (:update for-node))])]))
```

#### 2Ô∏è‚É£ Mid-level IR (MIR) - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```clojure
;; –¢—Ä—ë—Ö–∞–¥—Ä–µ—Å–Ω—ã–π –∫–æ–¥ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
(defrecord MIR-Instruction [op dest src1 src2])

;; –ü—Ä–∏–º–µ—Ä –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: constant folding
(defn constant-fold [instructions]
  (map (fn [instr]
         (if (and (= (:op instr) :add)
                  (constant? (:src1 instr))
                  (constant? (:src2 instr)))
           (mir-instruction :load (:dest instr) 
                           (+ (:src1 instr) (:src2 instr)))
           instr))
       instructions))
```

#### 3Ô∏è‚É£ Low-level IR (LIR) - –ë–ª–∏–∑–∫–æ –∫ –∞—Å—Å–µ–º–±–ª–µ—Ä—É
```clojure
;; –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ –¥–ª—è AT89S4051
(defrecord AT89S4051-Instruction [mnemonic operands])

(defn generate-at89s4051 [mir-instructions]
  (mapcat (fn [instr]
            (case (:op instr)
              :load [(at89s4051-instr "MOV" ["A" (:src1 instr)])]
              :add  [(at89s4051-instr "ADD" ["A" (:src1 instr)])]
              :store [(at89s4051-instr "MOV" [(:dest instr) "A"])]))
          mir-instructions))
```

### üéØ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥: LLVM-inspired

**–í–º–µ—Å—Ç–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ IR**, —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∞–¥–∞–ø—Ç–∞—Ü–∏—é LLVM-–ø–æ–¥–æ–±–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞:

```clojure
;; SSA —Ñ–æ—Ä–º–∞ –¥–ª—è AT89S4051
(defrecord SSA-Value [id type])
(defrecord SSA-Block [label instructions])

(defn to-ssa [ast]
  ;; –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ Static Single Assignment
  ;; –ö–∞–∂–¥–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
  )

;; –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞ SSA
(defn dead-code-elimination [ssa-blocks]
  ;; –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
  )

(defn register-allocation [ssa-blocks]
  ;; –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ AT89S4051
  ;; R0-R7, A, B, DPTR
  )
```

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞

```clojure
;; –û—Å–Ω–æ–≤–Ω–æ–π pipeline
(defn compile-c51 [source-file target-file]
  (-> source-file
      slurp
      preprocess           ; –í–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
      tokenize            ; –í–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–µ–∫—Å–µ—Ä  
      parse               ; –í–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ä—Å–µ—Ä
      validate-semantics  ; –ù–û–í–´–ô: —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
      optimize-ast        ; –ù–û–í–´–ô: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ AST
      lower-to-hir        ; –ù–û–í–´–ô: –ø–æ–Ω–∏–∂–µ–Ω–∏–µ –¥–æ HIR
      optimize-hir        ; –ù–û–í–´–ô: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ HIR
      lower-to-mir        ; –ù–û–í–´–ô: –ø–æ–Ω–∏–∂–µ–Ω–∏–µ –¥–æ MIR
      optimize-mir        ; –ù–û–í–´–ô: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ MIR
      allocate-registers  ; –ù–û–í–´–ô: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
      generate-asm        ; –ù–û–í–´–ô: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—Å—Å–µ–º–±–ª–µ—Ä–∞
      assemble            ; –ù–û–í–´–ô: –∞—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
      link                ; –ù–û–í–´–ô: –ª–∏–Ω–∫–æ–≤–∫–∞
      (spit target-file)))
```

### 2. –°–∏—Å—Ç–µ–º–∞ —Ç–∏–ø–æ–≤ –¥–ª—è AT89S4051

```clojure
(defprotocol AT89S4051-Type
  (size-bytes [type])
  (alignment [type])
  (register-class [type]))

(defrecord C51-UInt8 []
  AT89S4051-Type
  (size-bytes [_] 1)
  (alignment [_] 1)
  (register-class [_] :accumulator))

(defrecord C51-UInt16 []
  AT89S4051-Type
  (size-bytes [_] 2)
  (alignment [_] 1)
  (register-class [_] :dptr))
```

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è AT89S4051

```clojure
;; –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏
(defn optimize-for-memory [ast]
  (-> ast
      inline-small-functions    ; –ò–Ω–ª–∞–π–Ω–∏–Ω–≥ —Ñ—É–Ω–∫—Ü–∏–π < 10 –±–∞–π—Ç
      eliminate-dead-variables  ; –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
      pack-bit-fields          ; –£–ø–∞–∫–æ–≤–∫–∞ –±–∏—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
      optimize-stack-usage))   ; –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–µ–∫–∞

;; –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
(defn optimize-for-speed [mir]
  (-> mir
      strength-reduction       ; a*2 ‚Üí a<<1
      loop-unrolling          ; –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ü–∏–∫–ª–æ–≤
      peephole-optimization)) ; –õ–æ–∫–∞–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```

## üéØ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –§–∞–∑–∞ 1: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö —Ä–∞–±–æ—Ç (1-2 –Ω–µ–¥–µ–ª–∏)
1. ‚úÖ –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä: –û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å –∏–ª–∏ —Å–¥–µ–ª–∞—Ç—å transducer-based —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥
2. ‚úÖ –ü–∞—Ä—Å–µ—Ä: –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
3. üÜï –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤, –æ–±–ª–∞—Å—Ç–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏

### –§–∞–∑–∞ 2: IR –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (2-3 –Ω–µ–¥–µ–ª–∏)  
1. üÜï HIR: –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
2. üÜï –ë–∞–∑–æ–≤—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: constant folding, dead code elimination
3. üÜï MIR: –°—Ä–µ–¥–Ω–µ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ

### –§–∞–∑–∞ 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ (2-3 –Ω–µ–¥–µ–ª–∏)
1. üÜï LIR: –ù–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è AT89S4051
2. üÜï –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
3. üÜï –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—Å—Å–µ–º–±–ª–µ—Ä–∞

### –§–∞–∑–∞ 4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1-2 –Ω–µ–¥–µ–ª–∏)
1. üÜï End-to-end —Ç–µ—Å—Ç—ã
2. üÜï –ë–µ–Ω—á–º–∞—Ä–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. üÜï –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## ‚ùì –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π

1. **–ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä**: –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –Ω—É–∂–Ω–∞ –º–æ–Ω–æ–∏–¥–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞? –ú–æ–∂–µ—Ç, transducers –±—É–¥—É—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ?

2. **–ü–∞—Ä—Å–µ—Ä**: –¢–µ–∫—É—â–∏–π –ø–∞—Ä—Å–µ—Ä —É–∂–µ —Ö–æ—Ä–æ—à. –ù–µ –ª—É—á—à–µ –ª–∏ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–º –∞–Ω–∞–ª–∏–∑–µ?

3. **IR**: –ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –Ω—É–∂–µ–Ω? –ü—Ä–æ—Å—Ç—ã–µ (constant folding) –∏–ª–∏ —Å–ª–æ–∂–Ω—ã–µ (loop optimization)?

4. **–¶–µ–ª–µ–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞**: –¢–æ–ª—å–∫–æ AT89S4051 –∏–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥—Ä—É–≥–∏—Ö –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤?

5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å vs –ü—Ä–æ—Å—Ç–æ—Ç–∞**: –ß—Ç–æ –≤–∞–∂–Ω–µ–µ - —Å–∫–æ—Ä–æ—Å—Ç—å –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∏–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º–æ–≥–æ –∫–æ–¥–∞?

–ö–∞–∫–∏–µ –∏–∑ —ç—Ç–∏—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∫–∞–∂—É—Ç—Å—è –≤–∞–º –Ω–∞–∏–±–æ–ª–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º–∏? –Ø –≥–æ—Ç–æ–≤ —É–≥–ª—É–±–∏—Ç—å—Å—è –≤ –ª—é–±–æ–µ –∏–∑ –Ω–∏—Ö –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é!

```clojure
;; –í–º–µ—Å—Ç–æ –º–æ–Ω–∞–¥ - –∫–æ–º–ø–æ–∑–∏—Ä—É–µ–º—ã–µ —Ç—Ä–∞–Ω—Å–¥—å—é—Å–µ—Ä—ã
(def preprocess-pipeline
  (comp
    (map remove-comments)
    (map expand-macros)
    (filter should-include?)
    (map resolve-includes)))

;; –ë–æ–ª–µ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
(defn preprocess [source]
  (transduce preprocess-pipeline conj [] (str/split-lines source)))
```

```clojure
(defprotocol PreprocessorStage
  (process-stage [stage input state])
  (stage-name [stage])
  (can-handle? [stage directive]))

;; –†–∞—Å—à–∏—Ä—è–µ–º–∞—è —Å–∏—Å—Ç–µ–º–∞ —ç—Ç–∞–ø–æ–≤
(defrecord MacroExpander []
  PreprocessorStage
  (process-stage [_ input state] ...)
  (stage-name [_] "macro-expansion")
  (can-handle? [_ directive] (= directive :define)))
```

```clojure
;; –ú–µ–º–æ–∏–∑–∞—Ü–∏—è –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–∞—Ä—Å–µ—Ä–æ–≤
(def memoized-parse-expression 
  (memoize parse-expression))

;; –õ–µ–Ω–∏–≤—ã–µ –ø–∞—Ä—Å–µ—Ä—ã –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
(defn lazy-parse [tokens]
  (lazy-seq
    (when-let [token (first tokens)]
      (cons (parse-statement token) 
            (lazy-parse (rest tokens))))))
```

```clojure
(defrecord HIR-Node [op args type metadata])

;; –ü—Ä–∏–º–µ—Ä: for-loop ‚Üí while-loop —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è
(defn lower-for-to-while [for-node]
  (hir-node :block
    [(hir-node :assign (:init for-node))
     (hir-node :while (:condition for-node)
       [(hir-node :block (:body for-node))
        (hir-node :assign (:update for-node))])]))
```

```clojure
;; –¢—Ä—ë—Ö–∞–¥—Ä–µ—Å–Ω—ã–π –∫–æ–¥ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
(defrecord MIR-Instruction [op dest src1 src2])

;; –ü—Ä–∏–º–µ—Ä –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: constant folding
(defn constant-fold [instructions]
  (map (fn [instr]
         (if (and (= (:op instr) :add)
                  (constant? (:src1 instr))
                  (constant? (:src2 instr)))
           (mir-instruction :load (:dest instr) 
                           (+ (:src1 instr) (:src2 instr)))
           instr))
       instructions))
```

```clojure
;; –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ –¥–ª—è AT89S4051
(defrecord AT89S4051-Instruction [mnemonic operands])

(defn generate-at89s4051 [mir-instructions]
  (mapcat (fn [instr]
            (case (:op instr)
              :load [(at89s4051-instr "MOV" ["A" (:src1 instr)])]
              :add  [(at89s4051-instr "ADD" ["A" (:src1 instr)])]
              :store [(at89s4051-instr "MOV" [(:dest instr) "A"])]))
          mir-instructions))
```

```clojure
;; SSA —Ñ–æ—Ä–º–∞ –¥–ª—è AT89S4051
(defrecord SSA-Value [id type])
(defrecord SSA-Block [label instructions])

(defn to-ssa [ast]
  ;; –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –≤ Static Single Assignment
  ;; –ö–∞–∂–¥–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
  )

;; –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞ SSA
(defn dead-code-elimination [ssa-blocks]
  ;; –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
  )

(defn register-allocation [ssa-blocks]
  ;; –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤ AT89S4051
  ;; R0-R7, A, B, DPTR
  )
```

```clojure
;; –û—Å–Ω–æ–≤–Ω–æ–π pipeline
(defn compile-c51 [source-file target-file]
  (-> source-file
      slurp
      preprocess           ; –í–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
      tokenize            ; –í–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ª–µ–∫—Å–µ—Ä  
      parse               ; –í–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ä—Å–µ—Ä
      validate-semantics  ; –ù–û–í–´–ô: —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
      optimize-ast        ; –ù–û–í–´–ô: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ AST
      lower-to-hir        ; –ù–û–í–´–ô: –ø–æ–Ω–∏–∂–µ–Ω–∏–µ –¥–æ HIR
      optimize-hir        ; –ù–û–í–´–ô: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ HIR
      lower-to-mir        ; –ù–û–í–´–ô: –ø–æ–Ω–∏–∂–µ–Ω–∏–µ –¥–æ MIR
      optimize-mir        ; –ù–û–í–´–ô: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ MIR
      allocate-registers  ; –ù–û–í–´–ô: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
      generate-asm        ; –ù–û–í–´–ô: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—Å—Å–µ–º–±–ª–µ—Ä–∞
      assemble            ; –ù–û–í–´–ô: –∞—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
      link                ; –ù–û–í–´–ô: –ª–∏–Ω–∫–æ–≤–∫–∞
      (spit target-file)))
```

```clojure
(defprotocol AT89S4051-Type
  (size-bytes [type])
  (alignment [type])
  (register-class [type]))

(defrecord C51-UInt8 []
  AT89S4051-Type
  (size-bytes [_] 1)
  (alignment [_] 1)
  (register-class [_] :accumulator))

(defrecord C51-UInt16 []
  AT89S4051-Type
  (size-bytes [_] 2)
  (alignment [_] 1)
  (register-class [_] :dptr))
```

```clojure
;; –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏
(defn optimize-for-memory [ast]
  (-> ast
      inline-small-functions    ; –ò–Ω–ª–∞–π–Ω–∏–Ω–≥ —Ñ—É–Ω–∫—Ü–∏–π < 10 –±–∞–π—Ç
      eliminate-dead-variables  ; –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
      pack-bit-fields          ; –£–ø–∞–∫–æ–≤–∫–∞ –±–∏—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
      optimize-stack-usage))   ; –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–µ–∫–∞

;; –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
(defn optimize-for-speed [mir]
  (-> mir
      strength-reduction       ; a*2 ‚Üí a<<1
      loop-unrolling          ; –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Ü–∏–∫–ª–æ–≤
      peephole-optimization)) ; –õ–æ–∫–∞–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```

---

**User**

–ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä: –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –Ω—É–∂–Ω–∞ –º–æ–Ω–æ–∏–¥–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞? –ú–æ–∂–µ—Ç, transducers –±—É–¥—É—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ?
–í—ã–Ω–µ—Å–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ –≤ —Å–æ–æ—Ç–≤ —Ñ–∞–π–ª –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏, —è –ø–æ—Ç–æ–º –ø–æ—Å–º–æ—Ç—Ä—é.

IR: –ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –Ω—É–∂–µ–Ω? –ü—Ä–æ—Å—Ç—ã–µ (constant folding) –∏–ª–∏ —Å–ª–æ–∂–Ω—ã–µ (loop optimization)?
–ù–∞—á–∞—Ç—å —Å –ø—Ä–æ—Å—Ç—ã—Ö

–¶–µ–ª–µ–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞: –¢–æ–ª—å–∫–æ AT89S4051 –∏–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥—Ä—É–≥–∏—Ö –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤?
–ü–æ–∫–∞ —Ç–æ–ª—å–∫–æ AT89S4051 –¥–∞–ª–µ–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º

---

**Cursor**

–û—Ç–ª–∏—á–Ω–æ! –°–æ–∑–¥–∞–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—É –∏ –Ω–∞—á–Ω—É —Å –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –¥–ª—è AT89S4051. –î–∞–≤–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–¥–æ–π–¥–µ–º –∫ —ç—Ç–∏–º –≤–æ–ø—Ä–æ—Å–∞–º.

```markdown
# –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ C51: –í—ã–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

## üéØ –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ**: –ò–º–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä —Å —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Å–æ—Å—Ç–æ—è–Ω–∏—è  
**–†–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã**: –ú–æ–Ω–æ–∏–¥–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, Transducers, Protocol-based –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞  
**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: **Transducers + Protocols** –∫–∞–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

---

## üìä –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ–¥—Ö–æ–¥–æ–≤

### 1. –¢–µ–∫—É—â–∏–π –∏–º–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥

#### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- –†–∞–±–æ—Ç–∞–µ—Ç –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- –ü–æ–Ω—è—Ç–µ–Ω –ª—é–±–æ–º—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É
- –ü—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –õ–µ–≥–∫–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å step-by-step

#### ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
- –í—ã—Å–æ–∫–∞—è —Ü–∏–∫–ª–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å (12-15)
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –¥–∏—Ä–µ–∫—Ç–∏–≤
- –¢–µ—Å–Ω–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤

#### üìà –ú–µ—Ç—Ä–∏–∫–∏:
```
process-include: ~80 —Å—Ç—Ä–æ–∫, —Å–ª–æ–∂–Ω–æ—Å—Ç—å: 12
process-line:    ~120 —Å—Ç—Ä–æ–∫, —Å–ª–æ–∂–Ω–æ—Å—Ç—å: 15
preprocess:      ~60 —Å—Ç—Ä–æ–∫, —Å–ª–æ–∂–Ω–æ—Å—Ç—å: 8
–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å:   –ù–ò–ó–ö–ê–Ø (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã)
–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å:   –ù–ò–ó–ö–ê–Ø (–∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç –≤–µ—Å—å –∫–æ–¥)
```

---

### 2. –ú–æ–Ω–æ–∏–¥–Ω–∞—è/–ú–æ–Ω–∞–¥–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

#### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –ö–æ–º–ø–æ–∑–∏—Ä—É–µ–º–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π
- –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —á–∏—Å—Ç–æ—Ç–∞
- –≠–ª–µ–≥–∞–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è

#### ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
- **–ö–†–ò–¢–ò–ß–ù–û**: –ü—Ä–æ–±–ª–µ–º—ã –≥–∏–≥–∏–µ–Ω—ã –º–∞–∫—Ä–æ—Å–æ–≤ (–∫–∞–∫ –≤ do-parse)
- –í—ã—Å–æ–∫–∞—è –∫—Ä–∏–≤–∞—è –æ–±—É—á–µ–Ω–∏—è –¥–ª—è –∫–æ–º–∞–Ω–¥—ã
- –°–ª–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–ª–∞–¥–∫–∏ –º–æ–Ω–∞–¥–∏—á–µ—Å–∫–∏—Ö —Ü–µ–ø–æ—á–µ–∫
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –ò–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

#### üö® –£—Ä–æ–∫–∏ –∏–∑ do-parse:
```clojure
;; –ü–†–û–ë–õ–ï–ú–´ –≥–∏–≥–∏–µ–Ω—ã –≤ –º–æ–Ω–∞–¥–∏—á–µ—Å–∫–∏—Ö –º–∞–∫—Ä–æ—Å–∞—Ö:
;; 1. symbol# —Å–æ–∑–¥–∞–µ—Ç –†–ê–ó–ù–´–ï —Å–∏–º–≤–æ–ª—ã –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
;; 2. –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã ‚Üí –∑–∞—Ö–≤–∞—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö  
;; 3. –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –∏–º–µ–Ω–∞–º–∏ (state, result, error)
;; 4. –°–ª–æ–∂–Ω–æ—Å—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞ compile-time
```

#### üìà –ú–µ—Ç—Ä–∏–∫–∏:
```
process-include-m: ~15 —Å—Ç—Ä–æ–∫, —Å–ª–æ–∂–Ω–æ—Å—Ç—å: 2
process-line-m:    ~30 —Å—Ç—Ä–æ–∫, —Å–ª–æ–∂–Ω–æ—Å—Ç—å: 3  
preprocess-m:      ~20 —Å—Ç—Ä–æ–∫, —Å–ª–æ–∂–Ω–æ—Å—Ç—å: 2
–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å:     –í–´–°–û–ö–ê–Ø (unit —Ç–µ—Å—Ç—ã)
–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å:     –í–´–°–û–ö–ê–Ø (–∫–æ–º–ø–æ–∑–∏—Ü–∏—è)
–ö—Ä–∏–≤–∞—è –æ–±—É—á–µ–Ω–∏—è:   –í–´–°–û–ö–ê–Ø (–º–æ–Ω–∞–¥—ã —Å–ª–æ–∂–Ω—ã)
–†–∏—Å–∫–∏ –≥–∏–≥–∏–µ–Ω—ã:     –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï
```

---

### 3. Transducers –ø–æ–¥—Ö–æ–¥ (–†–ï–ö–û–ú–ï–ù–î–£–ï–ú–´–ô)

#### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: Lazy evaluation, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π
- **–ö–æ–º–ø–æ–∑–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è —á–µ—Ä–µ–∑ `comp`
- **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å**: –ü–æ–Ω—è—Ç–Ω—ã–π pipeline –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ö–∞–∂–¥—ã–π transducer —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
- **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —ç—Ç–∞–ø—ã
- **Clojure-native**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —è–∑—ã–∫–∞

#### ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
- –¢—Ä–µ–±—É–µ—Ç –ø–æ–Ω–∏–º–∞–Ω–∏—è transducers (–Ω–æ –ø—Ä–æ—â–µ –º–æ–Ω–∞–¥)
- –ù—É–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
- –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —è–≤–Ω–æ

#### üöÄ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
```clojure
;; –ö–æ–º–ø–æ–∑–∏—Ä—É–µ–º—ã–π pipeline –æ–±—Ä–∞–±–æ—Ç–∫–∏
(def preprocess-pipeline
  (comp
    (map remove-comments)           ; –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    (map expand-simple-macros)      ; –ü—Ä–æ—Å—Ç—ã–µ –º–∞–∫—Ä–æ—Å—ã (#define MAX 100)
    (mapcat process-includes)       ; –û–±—Ä–∞–±–æ—Ç–∫–∞ #include (–º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫)
    (filter conditional-include?)   ; –£—Å–ª–æ–≤–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è (#ifdef)
    (map expand-function-macros)    ; –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã
    (map add-line-info)))          ; –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—Ä–æ–∫–∞—Ö

;; –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
(defn preprocess [source-lines state]
  (let [result-lines (into [] preprocess-pipeline source-lines)]
    [result-lines (update-final-state state result-lines)]))
```

#### üìà –ú–µ—Ç—Ä–∏–∫–∏:
```
–ö–∞–∂–¥—ã–π transducer: ~10-20 —Å—Ç—Ä–æ–∫, —Å–ª–æ–∂–Ω–æ—Å—Ç—å: 1-2
Pipeline:          ~5 —Å—Ç—Ä–æ–∫, —Å–ª–æ–∂–Ω–æ—Å—Ç—å: 1
–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å:     –û–ß–ï–ù–¨ –í–´–°–û–ö–ê–Ø (unit + integration)
–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å:     –û–ß–ï–ù–¨ –í–´–°–û–ö–ê–Ø (–¥–æ–±–∞–≤–∏—Ç—å –≤ comp)
–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –û–¢–õ–ò–ß–ù–ê–Ø (lazy + no intermediate collections)
–ö—Ä–∏–≤–∞—è –æ–±—É—á–µ–Ω–∏—è:   –°–†–ï–î–ù–Ø–Ø (transducers –ø—Ä–æ—â–µ –º–æ–Ω–∞–¥)
```

---

### 4. Protocol-based –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

#### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- –ü–æ–ª–∏–º–æ—Ä—Ñ–∏–∑–º –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
- –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
- –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –¥–∏—Ä–µ–∫—Ç–∏–≤
- –•–æ—Ä–æ—à–∞—è —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å

#### ‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
- –ò–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è

#### üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:
```clojure
(defprotocol PreprocessorStage
  (process-stage [stage input state])
  (stage-name [stage])
  (can-handle? [stage directive]))

(defrecord IncludeProcessor []
  PreprocessorStage
  (process-stage [_ input state] ...)
  (stage-name [_] "include-processing")
  (can-handle? [_ directive] (= directive :include)))

(defrecord MacroExpander []
  PreprocessorStage
  (process-stage [_ input state] ...)
  (stage-name [_] "macro-expansion") 
  (can-handle? [_ directive] (= directive :define)))
```

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ: Transducers + Protocols

### –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –ª—É—á—à–µ–µ –∏–∑ –¥–≤—É—Ö –º–∏—Ä–æ–≤:

#### 1. Transducers –¥–ª—è pipeline –æ–±—Ä–∞–±–æ—Ç–∫–∏:
```clojure
(def preprocess-pipeline
  (comp
    (map remove-comments)
    (mapcat (partial process-with-handlers directive-handlers))
    (filter should-include?)
    (map add-debug-info)))
```

#### 2. Protocols –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∏—Ä–µ–∫—Ç–∏–≤:
```clojure
(def directive-handlers
  {:include (->IncludeProcessor)
   :define  (->MacroExpander)
   :ifdef   (->ConditionalProcessor)})

(defn process-with-handlers [handlers line]
  (if-let [directive (detect-directive line)]
    (let [handler (handlers (:type directive))]
      (if handler
        (process-stage handler line *current-state*)
        (throw (ex-info "Unknown directive" {:directive directive}))))
    [line]))  ; –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –∫–æ–¥–∞
```

#### 3. –°–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ dynamic vars –∏–ª–∏ atoms:
```clojure
(def ^:dynamic *preprocessor-state* (atom initial-state))

(defn with-preprocessor-state [initial-state f]
  (binding [*preprocessor-state* (atom initial-state)]
    (f)))
```

---

## üìã –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ –ø—Ä–∏–Ω—è—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–µ)

### –§–∞–∑–∞ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (3-5 –¥–Ω–µ–π)
1. –°–æ–∑–¥–∞—Ç—å protocols –¥–ª—è –¥–∏—Ä–µ–∫—Ç–∏–≤
2. –ù–∞–ø–∏—Å–∞—Ç—å transducers –¥–ª—è –±–∞–∑–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
3. –°–æ–∑–¥–∞—Ç—å comprehensive test suite

### –§–∞–∑–∞ 2: –ú–∏–≥—Ä–∞—Ü–∏—è –ø–æ —á–∞—Å—Ç—è–º (5-7 –¥–Ω–µ–π)
1. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
2. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ –º–∞–∫—Ä–æ—Å—ã (#define)
3. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–∫–ª—é—á–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ (#include)
4. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —É—Å–ª–æ–≤–Ω—É—é –∫–æ–º–ø–∏–ª—è—Ü–∏—é

### –§–∞–∑–∞ 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (2-3 –¥–Ω—è)
1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
2. –ë–µ–Ω—á–º–∞—Ä–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### –§–∞–∑–∞ 4: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (1-2 –¥–Ω—è)
1. –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–∑–∫–∏—Ö –º–µ—Å—Ç
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ lazy evaluation
3. –§–∏–Ω–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üî¨ –ë–µ–Ω—á–º–∞—Ä–∫–∏ –∏ –º–µ—Ç—Ä–∏–∫–∏

### –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: +20-30% (lazy evaluation)
- **–ü–∞–º—è—Ç—å**: -15-25% (no intermediate collections)
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å –∫–æ–¥–∞**: -60-70% (–ø—Ä–æ—Å—Ç—ã–µ transducers)
- **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**: +200-300% (unit —Ç–µ—Å—Ç—ã –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞)
- **–í—Ä–µ–º—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–∏–≤—ã**: —Å 2-3 —á–∞—Å–æ–≤ –¥–æ 30 –º–∏–Ω—É—Ç

### –†–∏—Å–∫–∏:
- **–í—Ä–µ–º—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞**: 2-3 –Ω–µ–¥–µ–ª–∏
- **–†–µ–≥—Ä–µ—Å—Å–∏–∏**: –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ (–µ—Å—Ç—å —Ç–µ—Å—Ç—ã)
- **–ö—Ä–∏–≤–∞—è –æ–±—É—á–µ–Ω–∏—è**: 1-2 –¥–Ω—è –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è transducers

---

## üèÅ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: **–ù–ï –°–ü–ï–®–ò–¢–¨** —Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**:
1. –¢–µ–∫—É—â–∏–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
2. –ï—Å—Ç—å –±–æ–ª–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏ (IR, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞)
3. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ pipeline

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω**:
1. –°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—å IR –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∫–æ–¥–∞
2. –ù–∞–∫–æ–ø–∏—Ç—å –æ–ø—ã—Ç —Å transducers –≤ –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç—è—Ö –ø—Ä–æ–µ–∫—Ç–∞
3. –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –ø–æ–∑–∂–µ

**–ï—Å–ª–∏ –≤—Å–µ –∂–µ —Ä–µ—à–µ–Ω–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å –°–ï–ô–ß–ê–°**:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Transducers + Protocols**
- –î–µ–ª–∞—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –∫–∞–∫ fallback
- Extensive testing –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –ø–æ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—É C51*  
*–ê–≤—Ç–æ—Ä: AI Assistant*  
*–î–∞—Ç–∞: 2024*
```

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º –ø–ª–∞–Ω –ø–æ IR —Å –ø—Ä–æ—Å—Ç—ã–º–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏ –¥–ª—è AT89S4051:

```markdown
# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (IR) –∏ –ø—Ä–æ—Å—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è AT89S4051

## üéØ –¶–µ–ª–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

**–¶–µ–ª–µ–≤–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞**: AT89S4051 (8-–±–∏—Ç–Ω—ã–π –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä)  
**–£—Ä–æ–≤–µ–Ω—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π**: –ü—Ä–æ—Å—Ç—ã–µ (constant folding, dead code elimination, strength reduction)  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –†–∞–∑–º–µ—Ä –∫–æ–¥–∞ > –°–∫–æ—Ä–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å 4KB ROM)

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ IR

### –¢—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ IR

```
AST ‚Üí HIR ‚Üí MIR ‚Üí AT89S4051 Assembly
      ‚Üë     ‚Üë     ‚Üë
   –í—ã—Å–æ–∫–∏–π –°—Ä–µ–¥–Ω–∏–π –ù–∏–∑–∫–∏–π
   —É—Ä–æ–≤–µ–Ω—å —É—Ä–æ–≤–µ–Ω—å —É—Ä–æ–≤–µ–Ω—å
```

#### 1. HIR (High-level IR) - –ë–ª–∏–∑–∫–æ –∫ AST
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞
- –û–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è (for, while, function calls)
- –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
- –û–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏

#### 2. MIR (Mid-level IR) - –¢—Ä—ë—Ö–∞–¥—Ä–µ—Å–Ω—ã–π –∫–æ–¥
- –ü—Ä–æ—Å—Ç—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (add, sub, load, store)
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- –ë–∞–∑–æ–≤—ã–µ –±–ª–æ–∫–∏ –∏ control flow graph
- –ü–ª–∞—Ç—Ñ–æ—Ä–º–æ-–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### 3. LIR (Low-level IR) - –ë–ª–∏–∑–∫–æ –∫ –∞—Å—Å–µ–º–±–ª–µ—Ä—É
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ AT89S4051
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
- –ê–¥—Ä–µ—Å–∞—Ü–∏—è –ø–∞–º—è—Ç–∏
- –ü–ª–∞—Ç—Ñ–æ—Ä–º–æ-–∑–∞–≤–∏—Å–∏–º—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

## üìä –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö

### HIR (High-level IR)

```clojure
(ns c51cc.ir.hir
  "High-level –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ")

;; –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ HIR —É–∑–ª–∞
(defrecord HIR-Node 
  [op          ; –û–ø–µ—Ä–∞—Ü–∏—è (:assign, :call, :if, :while, :for, :return)
   type        ; –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö (:uint8, :uint16, :int8, :int16, :bit, :pointer)
   operands    ; –û–ø–µ—Ä–∞–Ω–¥—ã (–≤–µ–∫—Ç–æ—Ä HIR-Node –∏–ª–∏ –ø—Ä–∏–º–∏—Ç–∏–≤–æ–≤)
   metadata])  ; –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏, —Ñ–∞–π–ª, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏)

;; –¢–∏–ø—ã –æ–ø–µ—Ä–∞—Ü–∏–π HIR
(def hir-operations
  #{:assign      ; –ü—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ: x = y
    :binary-op   ; –ë–∏–Ω–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: x = y + z
    :unary-op    ; –£–Ω–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏: x = -y
    :call        ; –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏: f(x, y)
    :if          ; –£—Å–ª–æ–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
    :while       ; –¶–∏–∫–ª while
    :for         ; –¶–∏–∫–ª for
    :return      ; –í–æ–∑–≤—Ä–∞—Ç –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
    :block       ; –ë–ª–æ–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
    :load        ; –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    :store       ; –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    :cast        ; –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤
    :array-ref   ; –î–æ—Å—Ç—É–ø –∫ –º–∞—Å—Å–∏–≤—É
    :member-ref  ; –î–æ—Å—Ç—É–ø –∫ –ø–æ–ª—é —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    })

;; –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã HIR —É–∑–ª–æ–≤
(defn hir-assign [dest src type]
  (->HIR-Node :assign type [dest src] {}))

(defn hir-binary-op [op left right result-type]
  (->HIR-Node :binary-op result-type [op left right] {}))

(defn hir-call [function args return-type]
  (->HIR-Node :call return-type [function args] {}))

;; –ü—Ä–∏–º–µ—Ä HIR –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è: x = a + b * 2
(def example-hir
  (hir-assign 
    (hir-load "x" :uint8)
    (hir-binary-op :add
      (hir-load "a" :uint8)
      (hir-binary-op :multiply
        (hir-load "b" :uint8)
        (hir-constant 2 :uint8)
        :uint8)
      :uint8)
    :uint8))
```

### MIR (Mid-level IR)

```clojure
(ns c51cc.ir.mir
  "Mid-level –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ - —Ç—Ä—ë—Ö–∞–¥—Ä–µ—Å–Ω—ã–π –∫–æ–¥")

;; –¢—Ä—ë—Ö–∞–¥—Ä–µ—Å–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
(defrecord MIR-Instruction
  [op      ; –û–ø–µ—Ä–∞—Ü–∏—è (:add, :sub, :mul, :div, :load, :store, :jump, :branch)
   dest    ; –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–∞—è)
   src1    ; –ü–µ—Ä–≤—ã–π –æ–ø–µ—Ä–∞–Ω–¥
   src2    ; –í—Ç–æ—Ä–æ–π –æ–ø–µ—Ä–∞–Ω–¥ (–º–æ–∂–µ—Ç –±—ã—Ç—å nil –¥–ª—è —É–Ω–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
   type    ; –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö
   label]) ; –ú–µ—Ç–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

;; –ë–∞–∑–æ–≤—ã–π –±–ª–æ–∫
(defrecord BasicBlock
  [label        ; –£–Ω–∏–∫–∞–ª—å–Ω–∞—è –º–µ—Ç–∫–∞ –±–ª–æ–∫–∞
   instructions ; –í–µ–∫—Ç–æ—Ä MIR-Instruction
   successors   ; –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —Å–ª–µ–¥—É—é—â–∏—Ö –±–ª–æ–∫–æ–≤
   predecessors ; –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –±–ª–æ–∫–æ–≤
   live-in      ; –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –∂–∏–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –Ω–∞ –≤—Ö–æ–¥–µ
   live-out])   ; –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –∂–∏–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –Ω–∞ –≤—ã—Ö–æ–¥–µ

;; Control Flow Graph
(defrecord CFG
  [entry-block  ; –í—Ö–æ–¥–Ω–æ–π –±–ª–æ–∫
   exit-block   ; –í—ã—Ö–æ–¥–Ω–æ–π –±–ª–æ–∫
   blocks       ; Map label -> BasicBlock
   ])

;; –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã MIR –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
(defn mir-add [dest src1 src2 type]
  (->MIR-Instruction :add dest src1 src2 type nil))

(defn mir-load [dest src type]
  (->MIR-Instruction :load dest src nil type nil))

(defn mir-store [dest src type]
  (->MIR-Instruction :store dest src nil type nil))

(defn mir-branch [condition true-label false-label]
  (->MIR-Instruction :branch nil condition nil :bool true-label))

;; –ü—Ä–∏–º–µ—Ä MIR –¥–ª—è x = a + b * 2:
(def example-mir
  [(mir-load "t1" "a" :uint8)      ; t1 = a
   (mir-load "t2" "b" :uint8)      ; t2 = b  
   (mir-add "t3" "t2" 2 :uint8)    ; t3 = t2 * 2 (–±—É–¥–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –≤ shift)
   (mir-add "t4" "t1" "t3" :uint8) ; t4 = t1 + t3
   (mir-store "x" "t4" :uint8)])   ; x = t4
```

---

## üîß –ü—Ä–æ—Å—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. Constant Folding (–°–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç)

```clojure
(ns c51cc.optimizations.constant-folding
  "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —Å–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π")

(defn constant? [operand]
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–ø–µ—Ä–∞–Ω–¥ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–æ–π"
  (number? operand))

(defn fold-binary-op [op left right]
  "–í—ã—á–∏—Å–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–∏–Ω–∞—Ä–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏"
  (when (and (constant? left) (constant? right))
    (case op
      :add (+ left right)
      :sub (- left right)
      :mul (* left right)
      :div (when (not= right 0) (quot left right))
      :mod (when (not= right 0) (rem left right))
      :and (bit-and left right)
      :or  (bit-or left right)
      :xor (bit-xor left right)
      :shl (bit-shift-left left right)
      :shr (bit-shift-right left right)
      nil)))

(defn constant-fold-instruction [instr]
  "–ü—Ä–∏–º–µ–Ω—è–µ—Ç constant folding –∫ –æ–¥–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏"
  (if (and (= (:op instr) :add)
           (constant? (:src1 instr))
           (constant? (:src2 instr)))
    ;; –ó–∞–º–µ–Ω—è–µ–º add –Ω–∞ load —Å –≤—ã—á–∏—Å–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Å—Ç–∞–Ω—Ç–æ–π
    (mir-load (:dest instr) 
              (fold-binary-op :add (:src1 instr) (:src2 instr))
              (:type instr))
    instr))

(defn constant-fold-block [basic-block]
  "–ü—Ä–∏–º–µ–Ω—è–µ—Ç constant folding –∫–æ –≤—Å–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –±–ª–æ–∫–∞"
  (update basic-block :instructions 
          #(mapv constant-fold-instruction %)))

;; –ü—Ä–∏–º–µ—Ä:
;; –ë–´–õ–û: t1 = 5 + 3
;; –°–¢–ê–õ–û: t1 = 8
```

### 2. Dead Code Elimination (–£–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ä—Ç–≤–æ–≥–æ –∫–æ–¥–∞)

```clojure
(ns c51cc.optimizations.dead-code-elimination
  "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –∫–æ–¥–∞")

(defn collect-used-variables [instructions]
  "–°–æ–±–∏—Ä–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö"
  (reduce (fn [used instr]
            (-> used
                (cond-> (:src1 instr) (conj (:src1 instr)))
                (cond-> (:src2 instr) (conj (:src2 instr)))))
          #{}
          instructions))

(defn variable-used? [var used-vars]
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è"
  (contains? used-vars var))

(defn dead-instruction? [instr used-vars]
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –º–µ—Ä—Ç–≤–æ–π"
  (and (#{:add :sub :mul :div :load} (:op instr))
       (not (variable-used? (:dest instr) used-vars))))

(defn eliminate-dead-code [basic-block]
  "–£–¥–∞–ª—è–µ—Ç –º–µ—Ä—Ç–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏–∑ –±–ª–æ–∫–∞"
  (let [instructions (:instructions basic-block)
        used-vars (collect-used-variables instructions)
        live-instructions (remove #(dead-instruction? % used-vars) instructions)]
    (assoc basic-block :instructions (vec live-instructions))))

;; –ü—Ä–∏–º–µ—Ä:
;; –ë–´–õ–û: t1 = a + b
;;       t2 = c + d  ; t2 –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
;;       return t1
;; –°–¢–ê–õ–û: t1 = a + b
;;        return t1
```

### 3. Strength Reduction (–£–ø—Ä–æ—â–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π)

```clojure
(ns c51cc.optimizations.strength-reduction
  "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –∑–∞–º–µ–Ω–∞ –¥–æ—Ä–æ–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–∞ –¥–µ—à–µ–≤—ã–µ")

(defn power-of-two? [n]
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —á–∏—Å–ª–æ —Å—Ç–µ–ø–µ–Ω—å—é –¥–≤–æ–π–∫–∏"
  (and (pos? n) (zero? (bit-and n (dec n)))))

(defn log2 [n]
  "–í—ã—á–∏—Å–ª—è–µ—Ç log2 –¥–ª—è —Å—Ç–µ–ø–µ–Ω–∏ –¥–≤–æ–π–∫–∏"
  (loop [n n, result 0]
    (if (= n 1)
      result
      (recur (bit-shift-right n 1) (inc result)))))

(defn strength-reduce-instruction [instr]
  "–ü—Ä–∏–º–µ–Ω—è–µ—Ç strength reduction –∫ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏"
  (case (:op instr)
    :mul
    (cond
      ;; x * 2^n ‚Üí x << n
      (and (constant? (:src2 instr)) (power-of-two? (:src2 instr)))
      (->MIR-Instruction :shl (:dest instr) (:src1 instr) 
                         (log2 (:src2 instr)) (:type instr) nil)
      
      ;; x * 1 ‚Üí x
      (and (constant? (:src2 instr)) (= (:src2 instr) 1))
      (mir-load (:dest instr) (:src1 instr) (:type instr))
      
      ;; x * 0 ‚Üí 0
      (and (constant? (:src2 instr)) (= (:src2 instr) 0))
      (mir-load (:dest instr) 0 (:type instr))
      
      :else instr)
    
    :div
    (cond
      ;; x / 2^n ‚Üí x >> n
      (and (constant? (:src2 instr)) (power-of-two? (:src2 instr)))
      (->MIR-Instruction :shr (:dest instr) (:src1 instr) 
                         (log2 (:src2 instr)) (:type instr) nil)
      
      ;; x / 1 ‚Üí x
      (and (constant? (:src2 instr)) (= (:src2 instr) 1))
      (mir-load (:dest instr) (:src1 instr) (:type instr))
      
      :else instr)
    
    :add
    (cond
      ;; x + 0 ‚Üí x
      (and (constant? (:src2 instr)) (= (:src2 instr) 0))
      (mir-load (:dest instr) (:src1 instr) (:type instr))
      
      :else instr)
    
    ;; –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    instr))

;; –ü—Ä–∏–º–µ—Ä:
;; –ë–´–õ–û: t1 = a * 8
;; –°–¢–ê–õ–û: t1 = a << 3
```

### 4. Copy Propagation (–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–ø–∏–π)

```clojure
(ns c51cc.optimizations.copy-propagation
  "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–ø–∏–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö")

(defn copy-instruction? [instr]
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–æ—Å—Ç—ã–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º"
  (and (= (:op instr) :load)
       (not (constant? (:src1 instr)))))

(defn build-copy-map [instructions]
  "–°—Ç—Ä–æ–∏—Ç –∫–∞—Ä—Ç—É –∫–æ–ø–∏–π: dest -> src"
  (reduce (fn [copy-map instr]
            (if (copy-instruction? instr)
              (assoc copy-map (:dest instr) (:src1 instr))
              copy-map))
          {}
          instructions))

(defn substitute-copies [instr copy-map]
  "–ó–∞–º–µ–Ω—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏—Ö –∫–æ–ø–∏—è–º–∏"
  (-> instr
      (update :src1 #(get copy-map % %))
      (update :src2 #(get copy-map % %))))

(defn propagate-copies [basic-block]
  "–ü—Ä–∏–º–µ–Ω—è–µ—Ç copy propagation –∫ –±–ª–æ–∫—É"
  (let [instructions (:instructions basic-block)
        copy-map (build-copy-map instructions)
        propagated (mapv #(substitute-copies % copy-map) instructions)]
    (assoc basic-block :instructions propagated)))

;; –ü—Ä–∏–º–µ—Ä:
;; –ë–´–õ–û: t1 = a
;;       t2 = t1 + b
;; –°–¢–ê–õ–û: t1 = a
;;        t2 = a + b
```

---

## üéØ –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è AT89S4051 –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. Bit-–æ–ø–µ—Ä–∞—Ü–∏–∏

```clojure
(defn optimize-bit-operations [instr]
  "–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∏—Ç–∞–º–∏ –¥–ª—è AT89S4051"
  (case (:op instr)
    :and
    (cond
      ;; x & 1 ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–ª–∞–¥—à–µ–≥–æ –±–∏—Ç–∞
      (and (constant? (:src2 instr)) (= (:src2 instr) 1))
      (->MIR-Instruction :bit-test (:dest instr) (:src1 instr) 0 :bit nil)
      
      ;; x & 0xFF ‚Üí x (–¥–ª—è uint8)
      (and (constant? (:src2 instr)) (= (:src2 instr) 0xFF) (= (:type instr) :uint8))
      (mir-load (:dest instr) (:src1 instr) (:type instr))
      
      :else instr)
    
    :or
    (cond
      ;; x | 0 ‚Üí x
      (and (constant? (:src2 instr)) (= (:src2 instr) 0))
      (mir-load (:dest instr) (:src1 instr) (:type instr))
      
      :else instr)
    
    instr))
```

### 2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞

```clojure
(defn optimize-accumulator-usage [instructions]
  "–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞ AT89S4051"
  ;; –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–æ–∫ –≤ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä
  ;; –ü—Ä–∏–º–µ—Ä: –≤–º–µ—Å—Ç–æ MOV A, R0; ADD A, R1; MOV R2, A; MOV A, R2; ADD A, R3
  ;; –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç: MOV A, R0; ADD A, R1; ADD A, R3; MOV R2, A
  )
```

### 3. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏

```clojure
(defn optimize-memory-usage [cfg]
  "–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏ AT89S4051"
  ;; 1. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
  ;; 2. –£–ø–∞–∫–æ–≤–∫–∞ –±–∏—Ç–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
  ;; 3. –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–µ–∫–∞
  )
```

---

## üìã –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ IR (1 –Ω–µ–¥–µ–ª—è)
1. ‚úÖ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö HIR/MIR
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã –∏ —É—Ç–∏–ª–∏—Ç—ã
3. ‚úÖ –ù–∞–ø–∏—Å–∞—Ç—å –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã
4. üÜï –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å AST ‚Üí HIR —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é

### –§–∞–∑–∞ 2: –ü—Ä–æ—Å—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (1 –Ω–µ–¥–µ–ª—è)
1. üÜï Constant folding
2. üÜï Dead code elimination  
3. üÜï Strength reduction
4. üÜï Copy propagation

### –§–∞–∑–∞ 3: HIR ‚Üí MIR –ø–æ–Ω–∏–∂–µ–Ω–∏–µ (1 –Ω–µ–¥–µ–ª—è)
1. üÜï –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è —Ü–∏–∫–ª–æ–≤ –≤ –ø–µ—Ä–µ—Ö–æ–¥—ã
2. üÜï –õ–∏–Ω–µ–∞—Ä–∏–∑–∞—Ü–∏—è –≤—ã—Ä–∞–∂–µ–Ω–∏–π
3. üÜï –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –±–ª–æ–∫–æ–≤
4. üÜï –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ CFG

### –§–∞–∑–∞ 4: AT89S4051-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (1 –Ω–µ–¥–µ–ª—è)
1. üÜï –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∏—Ç–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
2. üÜï –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞
3. üÜï –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
4. üÜï –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
```clojure
(deftest test-constant-folding
  (testing "–°–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Å—Ç–∞–Ω—Ç"
    (let [instr (mir-add "t1" 5 3 :uint8)
          optimized (constant-fold-instruction instr)]
      (is (= (:op optimized) :load))
      (is (= (:src1 optimized) 8)))))

(deftest test-strength-reduction
  (testing "–ó–∞–º–µ–Ω–∞ —É–º–Ω–æ–∂–µ–Ω–∏—è –Ω–∞ —Å—Ç–µ–ø–µ–Ω—å 2 —Å–¥–≤–∏–≥–æ–º"
    (let [instr (mir-mul "t1" "a" 8 :uint8)
          optimized (strength-reduce-instruction instr)]
      (is (= (:op optimized) :shl))
      (is (= (:src2 optimized) 3)))))
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:
```clojure
(deftest test-optimization-pipeline
  (testing "–ü–æ–ª–Ω—ã–π pipeline –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π"
    (let [original-mir [(mir-add "t1" 5 3 :uint8)
                        (mir-mul "t2" "t1" 8 :uint8)
                        (mir-add "unused" 1 2 :uint8)]
          optimized (-> original-mir
                        (apply-optimization constant-fold-block)
                        (apply-optimization eliminate-dead-code)
                        (apply-optimization strength-reduce-block))]
      ;; –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
      )))
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ú–µ—Ç—Ä–∏–∫–∏ —É–ª—É—á—à–µ–Ω–∏—è:
- **–†–∞–∑–º–µ—Ä –∫–æ–¥–∞**: -15-25% (constant folding + dead code elimination)
- **–°–∫–æ—Ä–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: +10-20% (strength reduction)
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏**: -10-15% (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö)

### –ü—Ä–∏–º–µ—Ä—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:
```c
// –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:
int x = 5 + 3;
int y = x * 8;
int unused = 10;

// –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:
int x = 8;        // constant folding
int y = x << 3;   // strength reduction
// unused —É–¥–∞–ª–µ–Ω   // dead code elimination
```

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è IR –∏ –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ C51*  
*–§–æ–∫—É—Å: AT89S4051, –ø—Ä–æ—Å—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, —Ä–∞–∑–º–µ—Ä –∫–æ–¥–∞*  
*–ê–≤—Ç–æ—Ä: AI Assistant*  
*–î–∞—Ç–∞: 2024*
```

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º –Ω–∞—á–∞–ª—å–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã IR:

```clojure
(ns c51cc.ir.hir
  "High-level –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (HIR) –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ C51
   
   HIR –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –º–µ–∂–¥—É AST –∏ MIR:
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–µ–º–∞–Ω—Ç–∏–∫—É –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è (—Ü–∏–∫–ª—ã, —Ñ—É–Ω–∫—Ü–∏–∏)
   - –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
   - –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
   - –ü–ª–∞—Ç—Ñ–æ—Ä–º–æ-–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏"
  (:require [clojure.spec.alpha :as s]))

;; ============================================================================
;; –¢–ò–ü–´ –î–ê–ù–ù–´–• AT89S4051
;; ============================================================================

(def at89s4051-types
  "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è AT89S4051"
  #{:uint8    ; 8-–±–∏—Ç–Ω–æ–µ –±–µ–∑–∑–Ω–∞–∫–æ–≤–æ–µ (0-255)
    :int8     ; 8-–±–∏—Ç–Ω–æ–µ –∑–Ω–∞–∫–æ–≤–æ–µ (-128 –¥–æ 127)
    :uint16   ; 16-–±–∏—Ç–Ω–æ–µ –±–µ–∑–∑–Ω–∞–∫–æ–≤–æ–µ (0-65535)
    :int16    ; 16-–±–∏—Ç–Ω–æ–µ –∑–Ω–∞–∫–æ–≤–æ–µ (-32768 –¥–æ 32767)
    :bit      ; –ë–∏—Ç–æ–≤–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è (0 –∏–ª–∏ 1)
    :pointer  ; 16-–±–∏—Ç–Ω—ã–π —É–∫–∞–∑–∞—Ç–µ–ª—å
    :void     ; –¢–∏–ø void –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π
    :array    ; –ú–∞—Å—Å–∏–≤ (—Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–∞–∑–º–µ—Ä–µ)
    })

(defn type-size-bytes
  "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Ç–∏–ø–∞ –≤ –±–∞–π—Ç–∞—Ö"
  [type]
  (case type
    (:uint8 :int8 :bit) 1
    (:uint16 :int16 :pointer) 2
    :void 0
    :array nil  ; –†–∞–∑–º–µ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    (throw (ex-info "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø" {:type type}))))

;; ============================================================================
;; –ë–ê–ó–û–í–´–ï –°–¢–†–£–ö–¢–£–†–´ HIR
;; ============================================================================

(defrecord HIR-Node 
  [op          ; –û–ø–µ—Ä–∞—Ü–∏—è (–∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ)
   type        ; –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
   operands    ; –í–µ–∫—Ç–æ—Ä –æ–ø–µ—Ä–∞–Ω–¥–æ–≤ (HIR-Node –∏–ª–∏ –ø—Ä–∏–º–∏—Ç–∏–≤—ã)
   metadata])  ; –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏, —Ñ–∞–π–ª, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏)

;; –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
(s/def ::op keyword?)
(s/def ::type at89s4051-types)
(s/def ::operands vector?)
(s/def ::metadata map?)
(s/def ::hir-node (s/keys :req-un [::op ::type ::operands ::metadata]))

;; ============================================================================
;; –û–ü–ï–†–ê–¶–ò–ò HIR
;; ============================================================================

(def hir-operations
  "–ú–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π HIR"
  #{;; –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    :add :sub :mul :div :mod
    :neg :abs
    
    ;; –ë–∏—Ç–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    :and :or :xor :not
    :shl :shr
    
    ;; –û–ø–µ—Ä–∞—Ü–∏–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    :eq :ne :lt :le :gt :ge
    
    ;; –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
    :logical-and :logical-or :logical-not
    
    ;; –û–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏—è
    :assign
    
    ;; –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–∞–º—è—Ç—å—é
    :load :store
    :array-ref :array-set
    
    ;; –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–º
    :if :while :for :block
    :call :return
    :break :continue
    
    ;; –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤
    :cast
    
    ;; –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    :constant :variable
    
    ;; –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è C51
    :sfr-access :sbit-access
    :interrupt-handler})

;; ============================================================================
;; –ö–û–ù–°–¢–†–£–ö–¢–û–†–´ HIR –£–ó–õ–û–í
;; ============================================================================

(defn hir-node
  "–°–æ–∑–¥–∞–µ—Ç HIR —É–∑–µ–ª —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π"
  [op type operands & [metadata]]
  (let [node (->HIR-Node op type operands (or metadata {}))]
    (when-not (s/valid? ::hir-node node)
      (throw (ex-info "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π HIR —É–∑–µ–ª" 
                     {:node node 
                      :spec-error (s/explain-data ::hir-node node)})))
    node))

;; –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
(defn hir-add [left right result-type & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª —Å–ª–æ–∂–µ–Ω–∏—è: left + right"
  (hir-node :add result-type [left right] metadata))

(defn hir-sub [left right result-type & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª –≤—ã—á–∏—Ç–∞–Ω–∏—è: left - right"
  (hir-node :sub result-type [left right] metadata))

(defn hir-mul [left right result-type & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª —É–º–Ω–æ–∂–µ–Ω–∏—è: left * right"
  (hir-node :mul result-type [left right] metadata))

(defn hir-div [left right result-type & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª –¥–µ–ª–µ–Ω–∏—è: left / right"
  (hir-node :div result-type [left right] metadata))

;; –ë–∏—Ç–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
(defn hir-and [left right result-type & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª –±–∏—Ç–æ–≤–æ–≥–æ –ò: left & right"
  (hir-node :and result-type [left right] metadata))

(defn hir-or [left right result-type & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª –±–∏—Ç–æ–≤–æ–≥–æ –ò–õ–ò: left | right"
  (hir-node :or result-type [left right] metadata))

(defn hir-xor [left right result-type & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª –±–∏—Ç–æ–≤–æ–≥–æ –∏—Å–∫–ª—é—á–∞—é—â–µ–≥–æ –ò–õ–ò: left ^ right"
  (hir-node :xor result-type [left right] metadata))

(defn hir-shl [left shift-amount result-type & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª —Å–¥–≤–∏–≥–∞ –≤–ª–µ–≤–æ: left << shift-amount"
  (hir-node :shl result-type [left shift-amount] metadata))

(defn hir-shr [left shift-amount result-type & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª —Å–¥–≤–∏–≥–∞ –≤–ø—Ä–∞–≤–æ: left >> shift-amount"
  (hir-node :shr result-type [left shift-amount] metadata))

;; –û–ø–µ—Ä–∞—Ü–∏–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
(defn hir-eq [left right & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –Ω–∞ —Ä–∞–≤–µ–Ω—Å—Ç–≤–æ: left == right"
  (hir-node :eq :bit [left right] metadata))

(defn hir-lt [left right & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –º–µ–Ω—å—à–µ: left < right"
  (hir-node :lt :bit [left right] metadata))

(defn hir-le [left right & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –º–µ–Ω—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ: left <= right"
  (hir-node :le :bit [left right] metadata))

;; –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
(defn hir-variable [name type & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π"
  (hir-node :variable type [name] metadata))

(defn hir-constant [value type & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã"
  (hir-node :constant type [value] metadata))

(defn hir-assign [dest src & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏—è: dest = src"
  (hir-node :assign (:type dest) [dest src] metadata))

;; –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–∞–º—è—Ç—å—é
(defn hir-load [variable & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π"
  (hir-node :load (:type variable) [variable] metadata))

(defn hir-store [variable value & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é"
  (hir-node :store (:type variable) [variable value] metadata))

(defn hir-array-ref [array index element-type & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª –¥–æ—Å—Ç—É–ø–∞ –∫ —ç–ª–µ–º–µ–Ω—Ç—É –º–∞—Å—Å–∏–≤–∞: array[index]"
  (hir-node :array-ref element-type [array index] metadata))

;; –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–º
(defn hir-if [condition then-branch else-branch & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª —É—Å–ª–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞"
  (hir-node :if :void [condition then-branch else-branch] metadata))

(defn hir-while [condition body & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª —Ü–∏–∫–ª–∞ while"
  (hir-node :while :void [condition body] metadata))

(defn hir-for [init condition update body & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª —Ü–∏–∫–ª–∞ for"
  (hir-node :for :void [init condition update body] metadata))

(defn hir-block [statements & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª –±–ª–æ–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤"
  (hir-node :block :void statements metadata))

(defn hir-call [function args return-type & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏"
  (hir-node :call return-type [function args] metadata))

(defn hir-return [value & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏"
  (hir-node :return :void [value] metadata))

;; –ü—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤
(defn hir-cast [value target-type & [metadata]]
  "–°–æ–∑–¥–∞–µ—Ç —É–∑–µ–ª –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è —Ç–∏–ø–æ–≤"
  (hir-node :cast target-type [value] metadata))

;; ============================================================================
;; –£–¢–ò–õ–ò–¢–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° HIR
;; ============================================================================

(defn hir-node? [x]
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–±—ä–µ–∫—Ç HIR —É–∑–ª–æ–º"
  (instance? HIR-Node x))

(defn leaf-node? [node]
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É–∑–µ–ª –ª–∏—Å—Ç–æ–≤—ã–º (–±–µ–∑ –¥–æ—á–µ—Ä–Ω–∏—Ö —É–∑–ª–æ–≤)"
  (#{:variable :constant} (:op node)))

(defn binary-op? [node]
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É–∑–µ–ª –±–∏–Ω–∞—Ä–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π"
  (#{:add :sub :mul :div :mod :and :or :xor :shl :shr 
     :eq :ne :lt :le :gt :ge :logical-and :logical-or} (:op node)))

(defn unary-op? [node]
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É–∑–µ–ª —É–Ω–∞—Ä–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π"
  (#{:neg :abs :not :logical-not} (:op node)))

(defn control-flow-op? [node]
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É–∑–µ–ª –æ–ø–µ—Ä–∞—Ü–∏–µ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–º"
  (#{:if :while :for :call :return :break :continue} (:op node)))

(defn get-operand [node index]
  "–ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç –æ–ø–µ—Ä–∞–Ω–¥ –ø–æ –∏–Ω–¥–µ–∫—Å—É"
  (get (:operands node) index))

(defn first-operand [node]
  "–ü–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–≤—ã–π –æ–ø–µ—Ä–∞–Ω–¥"
  (get-operand node 0))

(defn second-operand [node]
  "–ü–æ–ª—É—á–∞–µ—Ç –≤—Ç–æ—Ä–æ–π –æ–ø–µ—Ä–∞–Ω–¥"
  (get-operand node 1))

(defn third-operand [node]
  "–ü–æ–ª—É—á–∞–µ—Ç —Ç—Ä–µ—Ç–∏–π –æ–ø–µ—Ä–∞–Ω–¥"
  (get-operand node 2))

;; ============================================================================
;; –û–ë–•–û–î HIR –î–ï–†–ï–í–ê
;; ============================================================================

(defn walk-hir
  "–û–±—Ö–æ–¥–∏—Ç HIR –¥–µ—Ä–µ–≤–æ —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∫ –∫–∞–∂–¥–æ–º—É —É–∑–ª—É
   
   f - —Ñ—É–Ω–∫—Ü–∏—è (node) -> node –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ —É–∑–ª–æ–≤
   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ"
  [f node]
  (if (hir-node? node)
    (let [transformed-operands (mapv #(walk-hir f %) (:operands node))
          transformed-node (assoc node :operands transformed-operands)]
      (f transformed-node))
    (f node)))

(defn collect-nodes
  "–°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —É–∑–ª—ã –¥–µ—Ä–µ–≤–∞, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏–µ –ø—Ä–µ–¥–∏–∫–∞—Ç—É"
  [pred node]
  (let [result (atom [])]
    (walk-hir (fn [n]
                (when (and (hir-node? n) (pred n))
                  (swap! result conj n))
                n)
              node)
    @result))

(defn find-variables
  "–ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ HIR –¥–µ—Ä–µ–≤–µ"
  [node]
  (collect-nodes #(= (:op %) :variable) node))

(defn find-constants
  "–ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –≤ HIR –¥–µ—Ä–µ–≤–µ"
  [node]
  (collect-nodes #(= (:op %) :constant) node))

;; ============================================================================
;; –í–ê–õ–ò–î–ê–¶–ò–Ø HIR
;; ============================================================================

(defn validate-hir-node
  "–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç HIR —É–∑–µ–ª –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å"
  [node]
  (cond
    (not (hir-node? node))
    {:valid? false :error "–ù–µ —è–≤–ª—è–µ—Ç—Å—è HIR —É–∑–ª–æ–º"}
    
    (not (contains? hir-operations (:op node)))
    {:valid? false :error (str "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: " (:op node))}
    
    (not (contains? at89s4051-types (:type node)))
    {:valid? false :error (str "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø: " (:type node))}
    
    :else
    {:valid? true}))

(defn validate-hir-tree
  "–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—Å—ë HIR –¥–µ—Ä–µ–≤–æ"
  [node]
  (let [errors (atom [])]
    (walk-hir (fn [n]
                (when (hir-node? n)
                  (let [validation (validate-hir-node n)]
                    (when-not (:valid? validation)
                      (swap! errors conj {:node n :error (:error validation)}))))
                n)
              node)
    (if (empty? @errors)
      {:valid? true}
      {:valid? false :errors @errors})))

;; ============================================================================
;; –ö–†–ê–°–ò–í–´–ô –í–´–í–û–î HIR
;; ============================================================================

(defn pretty-print-hir
  "–ö—Ä–∞—Å–∏–≤–æ –≤—ã–≤–æ–¥–∏—Ç HIR –¥–µ—Ä–µ–≤–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏"
  [node & {:keys [indent] :or {indent 0}}]
  (let [spaces (apply str (repeat indent "  "))]
    (if (hir-node? node)
      (do
        (println (str spaces "(" (:op node) " :" (:type node)))
        (doseq [operand (:operands node)]
          (pretty-print-hir operand :indent (+ indent 1)))
        (println (str spaces ")")))
      (println (str spaces node)))))

;; ============================================================================
;; –ü–†–ò–ú–ï–†–´ –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø
;; ============================================================================

(comment
  ;; –ü—Ä–∏–º–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è HIR –¥–ª—è –≤—ã—Ä–∞–∂–µ–Ω–∏—è: x = a + b * 2
  (def example-hir
    (hir-assign 
      (hir-variable "x" :uint8)
      (hir-add 
        (hir-variable "a" :uint8)
        (hir-mul 
          (hir-variable "b" :uint8)
          (hir-constant 2 :uint8)
          :uint8)
        :uint8)))
  
  ;; –ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥
  (pretty-print-hir example-hir)
  
  ;; –í–∞–ª–∏–¥–∞—Ü–∏—è
  (validate-hir-tree example-hir)
  
  ;; –ü–æ–∏—Å–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
  (find-variables example-hir)
  )

;; –≠–∫—Å–ø–æ—Ä—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
(def ^:export hir-node hir-node)
(def ^:export validate-hir-tree validate-hir-tree)
(def ^:export pretty-print-hir pretty-print-hir)
(def ^:export walk-hir walk-hir)
```

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º –º–æ–¥—É–ª—å –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:

```clojure
(ns c51cc.optimizations.simple
  "–ü—Ä–æ—Å—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ C51
   
   –†–µ–∞–ª–∏–∑—É–µ—Ç –±–∞–∑–æ–≤—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
   - Constant folding (—Å–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç)
   - Dead code elimination (—É–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ä—Ç–≤–æ–≥–æ –∫–æ–¥–∞)
   - Strength reduction (—É–ø—Ä–æ—â–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π)
   - Copy propagation (—Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–ø–∏–π)
   
   –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ HIR –∏ —Ñ–æ–∫—É—Å–∏—Ä—É—é—Ç—Å—è –Ω–∞:
   - –£–º–µ–Ω—å—à–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–¥–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è AT89S4051)
   - –ü—Ä–æ—Å—Ç–æ—Ç–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏
   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π"
  (:require [c51cc.ir.hir :as hir]))

;; ============================================================================
;; –£–¢–ò–õ–ò–¢–´ –î–õ–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ô
;; ============================================================================

(defn constant-node? [node]
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É–∑–µ–ª –∫–æ–Ω—Å—Ç–∞–Ω—Ç–æ–π"
  (and (hir/hir-node? node) (= (:op node) :constant)))

(defn get-constant-value [node]
  "–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–∑ —É–∑–ª–∞"
  (when (constant-node? node)
    (hir/first-operand node)))

(defn variable-node? [node]
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É–∑–µ–ª –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π"
  (and (hir/hir-node? node) (= (:op node) :variable)))

(defn get-variable-name [node]
  "–ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–º—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏–∑ —É–∑–ª–∞"
  (when (variable-node? node)
    (hir/first-operand node)))

(defn safe-arithmetic-op [op left right]
  "–ë–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫—É—é –æ–ø–µ—Ä–∞—Ü–∏—é —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è"
  (try
    (case op
      :add (+ left right)
      :sub (- left right)
      :mul (* left right)
      :div (when (not= right 0) (quot left right))
      :mod (when (not= right 0) (rem left right))
      nil)
    (catch Exception _ nil)))

(defn safe-bitwise-op [op left right]
  "–ë–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –±–∏—Ç–æ–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é"
  (try
    (case op
      :and (bit-and left right)
      :or  (bit-or left right)
      :xor (bit-xor left right)
      :shl (bit-shift-left left right)
      :shr (bit-shift-right left right)
      nil)
    (catch Exception _ nil)))

;; ============================================================================
;; CONSTANT FOLDING (–°–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç)
;; ============================================================================

(defn fold-binary-constants
  "–°–≤–µ—Ä—Ç—ã–≤–∞–µ—Ç –±–∏–Ω–∞—Ä–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é —Å –¥–≤—É–º—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏"
  [node]
  (when (and (hir/binary-op? node)
             (constant-node? (hir/first-operand node))
             (constant-node? (hir/second-operand node)))
    (let [op (:op node)
          left (get-constant-value (hir/first-operand node))
          right (get-constant-value (hir/second-operand node))
          result-type (:type node)]
      
      ;; –ü—ã—Ç–∞–µ–º—Å—è –≤—ã—á–∏—Å–ª–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      (when-let [result (or (safe-arithmetic-op op left right)
                           (safe-bitwise-op op left right))]
        ;; –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—ã–π —É–∑–µ–ª
        (hir/hir-constant result result-type (:metadata node))))))

(defn fold-unary-constants
  "–°–≤–µ—Ä—Ç—ã–≤–∞–µ—Ç —É–Ω–∞—Ä–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é —Å –∫–æ–Ω—Å—Ç–∞–Ω—Ç–æ–π"
  [node]
  (when (and (hir/unary-op? node)
             (constant-node? (hir/first-operand node)))
    (let [op (:op node)
          operand (get-constant-value (hir/first-operand node))
          result-type (:type node)]
      
      (when-let [result (case op
                         :neg (- operand)
                         :abs (Math/abs operand)
                         :not (bit-not operand)
                         :logical-not (if (zero? operand) 1 0)
                         nil)]
        (hir/hir-constant result result-type (:metadata node))))))

(defn constant-fold-node
  "–ü—Ä–∏–º–µ–Ω—è–µ—Ç constant folding –∫ –æ–¥–Ω–æ–º—É —É–∑–ª—É"
  [node]
  (if (hir/hir-node? node)
    (or (fold-binary-constants node)
        (fold-unary-constants node)
        node)
    node))

(defn constant-fold
  "–ü—Ä–∏–º–µ–Ω—è–µ—Ç constant folding –∫–æ –≤—Å–µ–º—É HIR –¥–µ—Ä–µ–≤—É"
  [hir-tree]
  (hir/walk-hir constant-fold-node hir-tree))

;; ============================================================================
;; STRENGTH REDUCTION (–£–ø—Ä–æ—â–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π)
;; ============================================================================

(defn power-of-two? [n]
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —á–∏—Å–ª–æ —Å—Ç–µ–ø–µ–Ω—å—é –¥–≤–æ–π–∫–∏"
  (and (pos? n) (zero? (bit-and n (dec n)))))

(defn log2 [n]
  "–í—ã—á–∏—Å–ª—è–µ—Ç log2 –¥–ª—è —Å—Ç–µ–ø–µ–Ω–∏ –¥–≤–æ–π–∫–∏"
  (loop [n n, result 0]
    (if (= n 1)
      result
      (recur (bit-shift-right n 1) (inc result)))))

(defn strength-reduce-multiplication
  "–£–ø—Ä–æ—â–∞–µ—Ç —É–º–Ω–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å—Ç–µ–ø–µ–Ω—å –¥–≤–æ–π–∫–∏ –≤ —Å–¥–≤–∏–≥"
  [node]
  (when (and (= (:op node) :mul)
             (constant-node? (hir/second-operand node)))
    (let [multiplier (get-constant-value (hir/second-operand node))]
      (cond
        ;; x * 0 ‚Üí 0
        (= multiplier 0)
        (hir/hir-constant 0 (:type node) (:metadata node))
        
        ;; x * 1 ‚Üí x
        (= multiplier 1)
        (hir/first-operand node)
        
        ;; x * 2^n ‚Üí x << n
        (power-of-two? multiplier)
        (hir/hir-shl (hir/first-operand node)
                     (hir/hir-constant (log2 multiplier) :uint8)
                     (:type node)
                     (:metadata node))
        
        :else node))))

(defn strength-reduce-division
  "–£–ø—Ä–æ—â–∞–µ—Ç –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç–µ–ø–µ–Ω—å –¥–≤–æ–π–∫–∏ –≤ —Å–¥–≤–∏–≥"
  [node]
  (when (and (= (:op node) :div)
             (constant-node? (hir/second-operand node)))
    (let [divisor (get-constant-value (hir/second-operand node))]
      (cond
        ;; x / 1 ‚Üí x
        (= divisor 1)
        (hir/first-operand node)
        
        ;; x / 2^n ‚Üí x >> n (—Ç–æ–ª—å–∫–æ –¥–ª—è –±–µ–∑–∑–Ω–∞–∫–æ–≤—ã—Ö —Ç–∏–ø–æ–≤)
        (and (power-of-two? divisor)
             (#{:uint8 :uint16} (:type node)))
        (hir/hir-shr (hir/first-operand node)
                     (hir/hir-constant (log2 divisor) :uint8)
                     (:type node)
                     (:metadata node))
        
        :else node))))

(defn strength-reduce-addition
  "–£–ø—Ä–æ—â–∞–µ—Ç —Å–ª–æ–∂–µ–Ω–∏–µ —Å –Ω—É–ª–µ–º"
  [node]
  (when (= (:op node) :add)
    (let [left (hir/first-operand node)
          right (hir/second-operand node)]
      (cond
        ;; x + 0 ‚Üí x
        (and (constant-node? right) (= (get-constant-value right) 0))
        left
        
        ;; 0 + x ‚Üí x
        (and (constant-node? left) (= (get-constant-value left) 0))
        right
        
        :else node))))

(defn strength-reduce-subtraction
  "–£–ø—Ä–æ—â–∞–µ—Ç –≤—ã—á–∏—Ç–∞–Ω–∏–µ –Ω—É–ª—è"
  [node]
  (when (and (= (:op node) :sub)
             (constant-node? (hir/second-operand node))
             (= (get-constant-value (hir/second-operand node)) 0))
    ;; x - 0 ‚Üí x
    (hir/first-operand node)))

(defn strength-reduce-bitwise
  "–£–ø—Ä–æ—â–∞–µ—Ç –±–∏—Ç–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏"
  [node]
  (case (:op node)
    :and
    (let [left (hir/first-operand node)
          right (hir/second-operand node)]
      (cond
        ;; x & 0 ‚Üí 0
        (and (constant-node? right) (= (get-constant-value right) 0))
        (hir/hir-constant 0 (:type node) (:metadata node))
        
        ;; x & 0xFF ‚Üí x (–¥–ª—è uint8)
        (and (constant-node? right) 
             (= (get-constant-value right) 0xFF)
             (= (:type node) :uint8))
        left
        
        ;; x & 0xFFFF ‚Üí x (–¥–ª—è uint16)
        (and (constant-node? right) 
             (= (get-constant-value right) 0xFFFF)
             (= (:type node) :uint16))
        left
        
        :else node))
    
    :or
    (let [left (hir/first-operand node)
          right (hir/second-operand node)]
      (cond
        ;; x | 0 ‚Üí x
        (and (constant-node? right) (= (get-constant-value right) 0))
        left
        
        ;; 0 | x ‚Üí x
        (and (constant-node? left) (= (get-constant-value left) 0))
        right
        
        :else node))
    
    :xor
    (let [right (hir/second-operand node)]
      (cond
        ;; x ^ 0 ‚Üí x
        (and (constant-node? right) (= (get-constant-value right) 0))
        (hir/first-operand node)
        
        :else node))
    
    node))

(defn strength-reduce-node
  "–ü—Ä–∏–º–µ–Ω—è–µ—Ç strength reduction –∫ –æ–¥–Ω–æ–º—É —É–∑–ª—É"
  [node]
  (if (hir/hir-node? node)
    (or (strength-reduce-multiplication node)
        (strength-reduce-division node)
        (strength-reduce-addition node)
        (strength-reduce-subtraction node)
        (strength-reduce-bitwise node)
        node)
    node))

(defn strength-reduce
  "–ü—Ä–∏–º–µ–Ω—è–µ—Ç strength reduction –∫–æ –≤—Å–µ–º—É HIR –¥–µ—Ä–µ–≤—É"
  [hir-tree]
  (hir/walk-hir strength-reduce-node hir-tree))

;; ============================================================================
;; DEAD CODE ELIMINATION (–£–¥–∞–ª–µ–Ω–∏–µ –º–µ—Ä—Ç–≤–æ–≥–æ –∫–æ–¥–∞)
;; ============================================================================

(defn collect-used-variables
  "–°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ HIR –¥–µ—Ä–µ–≤–µ"
  [hir-tree]
  (let [used-vars (atom #{})]
    (hir/walk-hir 
      (fn [node]
        (when (variable-node? node)
          (swap! used-vars conj (get-variable-name node)))
        node)
      hir-tree)
    @used-vars))

(defn assignment-to-unused-var?
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É–∑–µ–ª –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ–º –≤ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é"
  [node used-vars]
  (and (= (:op node) :assign)
       (variable-node? (hir/first-operand node))
       (not (contains? used-vars (get-variable-name (hir/first-operand node))))))

(defn has-side-effects?
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏–º–µ–µ—Ç –ª–∏ —É–∑–µ–ª –ø–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã"
  [node]
  ;; –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥: —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–π –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–∞–º—è—Ç—å—é –∏–º–µ—é—Ç –ø–æ–±–æ—á–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
  (#{:call :store :sfr-access :sbit-access} (:op node)))

(defn dead-code-elimination-node
  "–£–¥–∞–ª—è–µ—Ç –º–µ—Ä—Ç–≤—ã–π –∫–æ–¥ –∏–∑ —É–∑–ª–∞"
  [node used-vars]
  (if (and (hir/hir-node? node)
           (not (has-side-effects? node))
           (assignment-to-unused-var? node used-vars))
    ;; –ó–∞–º–µ–Ω—è–µ–º –º–µ—Ä—Ç–≤–æ–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ –Ω–∞ no-op (–ø—É—Å—Ç–æ–π –±–ª–æ–∫)
    (hir/hir-block [] (:metadata node))
    node))

(defn dead-code-elimination
  "–£–¥–∞–ª—è–µ—Ç –º–µ—Ä—Ç–≤—ã–π –∫–æ–¥ –∏–∑ HIR –¥–µ—Ä–µ–≤–∞"
  [hir-tree]
  (let [used-vars (collect-used-variables hir-tree)]
    (hir/walk-hir #(dead-code-elimination-node % used-vars) hir-tree)))

;; ============================================================================
;; COPY PROPAGATION (–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–ø–∏–π)
;; ============================================================================

(defn simple-assignment? [node]
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É–∑–µ–ª –ø—Ä–æ—Å—Ç—ã–º –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π"
  (and (= (:op node) :assign)
       (variable-node? (hir/first-operand node))
       (variable-node? (hir/second-operand node))))

(defn collect-copy-assignments
  "–°–æ–±–∏—Ä–∞–µ—Ç –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏—è –≤–∏–¥–∞ x = y"
  [hir-tree]
  (let [copies (atom {})]
    (hir/walk-hir
      (fn [node]
        (when (simple-assignment? node)
          (let [dest (get-variable-name (hir/first-operand node))
                src (get-variable-name (hir/second-operand node))]
            (swap! copies assoc dest src)))
        node)
      hir-tree)
    @copies))

(defn substitute-variable
  "–ó–∞–º–µ–Ω—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –µ—ë –∫–æ–ø–∏–µ–π, –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ"
  [node copy-map]
  (if (variable-node? node)
    (let [var-name (get-variable-name node)]
      (if-let [replacement (get copy-map var-name)]
        (hir/hir-variable replacement (:type node) (:metadata node))
        node))
    node))

(defn copy-propagation
  "–ü—Ä–∏–º–µ–Ω—è–µ—Ç copy propagation –∫ HIR –¥–µ—Ä–µ–≤—É"
  [hir-tree]
  (let [copy-map (collect-copy-assignments hir-tree)]
    (hir/walk-hir #(substitute-variable % copy-map) hir-tree)))

;; ============================================================================
;; –ö–û–ú–ü–û–ó–ò–¶–ò–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ô
;; ============================================================================

(defn apply-simple-optimizations
  "–ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ –ø—Ä–æ—Å—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∫ HIR –¥–µ—Ä–µ–≤—É
   
   –ü–æ—Ä—è–¥–æ–∫ –≤–∞–∂–µ–Ω:
   1. Constant folding - —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
   2. Strength reduction - —É–ø—Ä–æ—â–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏
   3. Copy propagation - —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç –∫–æ–ø–∏–∏
   4. Dead code elimination - —É–¥–∞–ª—è–µ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥"
  [hir-tree]
  (-> hir-tree
      constant-fold
      strength-reduce
      copy-propagation
      dead-code-elimination))

(defn optimize-iteratively
  "–ü—Ä–∏–º–µ–Ω—è–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ –¥–æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ–π —Ç–æ—á–∫–∏"
  [hir-tree & {:keys [max-iterations] :or {max-iterations 10}}]
  (loop [current hir-tree
         iteration 0]
    (if (>= iteration max-iterations)
      current
      (let [optimized (apply-simple-optimizations current)]
        (if (= optimized current)
          optimized  ; –î–æ—Å—Ç–∏–≥–ª–∏ –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ–π —Ç–æ—á–∫–∏
          (recur optimized (inc iteration)))))))

;; ============================================================================
;; –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ô
;; ============================================================================

(defn count-nodes-by-type
  "–ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∑–ª–æ–≤ –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞"
  [hir-tree]
  (let [counts (atom {})]
    (hir/walk-hir
      (fn [node]
        (when (hir/hir-node? node)
          (swap! counts update (:op node) (fnil inc 0)))
        node)
      hir-tree)
    @counts))

(defn optimization-statistics
  "–°–æ–±–∏—Ä–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–æ –∏ –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π"
  [original-tree optimized-tree]
  (let [original-counts (count-nodes-by-type original-tree)
        optimized-counts (count-nodes-by-type optimized-tree)
        
        original-total (reduce + (vals original-counts))
        optimized-total (reduce + (vals optimized-counts))
        
        reduction-percent (if (pos? original-total)
                           (* 100.0 (/ (- original-total optimized-total) original-total))
                           0.0)]
    
    {:original-nodes original-total
     :optimized-nodes optimized-total
     :nodes-eliminated (- original-total optimized-total)
     :reduction-percent reduction-percent
     :original-counts original-counts
     :optimized-counts optimized-counts}))

;; ============================================================================
;; –≠–ö–°–ü–û–†–¢ –§–£–ù–ö–¶–ò–ô
;; ============================================================================

(def ^:export constant-fold constant-fold)
(def ^:export strength-reduce strength-reduce)
(def ^:export dead-code-elimination dead-code-elimination)
(def ^:export copy-propagation copy-propagation)
(def ^:export apply-simple-optimizations apply-simple-optimizations)
(def ^:export optimize-iteratively optimize-iteratively)
(def ^:export optimization-statistics optimization-statistics)
```

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:

```clojure
(ns c51cc.test-simple-optimizations
  "–¢–µ—Å—Ç—ã –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π HIR –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ C51"
  (:require [c51cc.ir.hir :as hir]
            [c51cc.optimizations.simple :as opt]))

;; ============================================================================
;; –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï
;; ============================================================================

(defn create-test-constant-folding
  "–°–æ–∑–¥–∞–µ—Ç HIR –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è constant folding: x = 5 + 3 * 2"
  []
  (hir/hir-assign
    (hir/hir-variable "x" :uint8)
    (hir/hir-add
      (hir/hir-constant 5 :uint8)
      (hir/hir-mul
        (hir/hir-constant 3 :uint8)
        (hir/hir-constant 2 :uint8)
        :uint8)
      :uint8)))

(defn create-test-strength-reduction
  "–°–æ–∑–¥–∞–µ—Ç HIR –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è strength reduction: y = a * 8 + b / 4"
  []
  (hir/hir-assign
    (hir/hir-variable "y" :uint8)
    (hir/hir-add
      (hir/hir-mul
        (hir/hir-variable "a" :uint8)
        (hir/hir-constant 8 :uint8)
        :uint8)
      (hir/hir-div
        (hir/hir-variable "b" :uint8)
        (hir/hir-constant 4 :uint8)
        :uint8)
      :uint8)))

(defn create-test-dead-code
  "–°–æ–∑–¥–∞–µ—Ç HIR –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è dead code elimination"
  []
  (hir/hir-block
    [(hir/hir-assign
       (hir/hir-variable "used" :uint8)
       (hir/hir-constant 10 :uint8))
     
     (hir/hir-assign
       (hir/hir-variable "unused" :uint8)
       (hir/hir-constant 20 :uint8))
     
     (hir/hir-return
       (hir/hir-variable "used" :uint8))]))

(defn create-test-copy-propagation
  "–°–æ–∑–¥–∞–µ—Ç HIR –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è copy propagation: t = a; result = t + b"
  []
  (hir/hir-block
    [(hir/hir-assign
       (hir/hir-variable "t" :uint8)
       (hir/hir-variable "a" :uint8))
     
     (hir/hir-assign
       (hir/hir-variable "result" :uint8)
       (hir/hir-add
         (hir/hir-variable "t" :uint8)
         (hir/hir-variable "b" :uint8)
         :uint8))]))

(defn create-complex-test
  "–°–æ–∑–¥–∞–µ—Ç —Å–ª–æ–∂–Ω—ã–π HIR –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π"
  []
  (hir/hir-block
    [;; –ö–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
     (hir/hir-assign
       (hir/hir-variable "const_result" :uint8)
       (hir/hir-add
         (hir/hir-mul
           (hir/hir-constant 2 :uint8)
           (hir/hir-constant 3 :uint8)
           :uint8)
         (hir/hir-constant 4 :uint8)
         :uint8))
     
     ;; Strength reduction
     (hir/hir-assign
       (hir/hir-variable "shifted" :uint8)
       (hir/hir-mul
         (hir/hir-variable "input" :uint8)
         (hir/hir-constant 16 :uint8)
         :uint8))
     
     ;; Copy propagation
     (hir/hir-assign
       (hir/hir-variable "temp" :uint8)
       (hir/hir-variable "shifted" :uint8))
     
     ;; Dead code (unused variable)
     (hir/hir-assign
       (hir/hir-variable "dead_var" :uint8)
       (hir/hir-constant 99 :uint8))
     
     ;; –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
     (hir/hir-assign
       (hir/hir-variable "final_result" :uint8)
       (hir/hir-add
         (hir/hir-variable "const_result" :uint8)
         (hir/hir-variable "temp" :uint8)
         :uint8))
     
     (hir/hir-return
       (hir/hir-variable "final_result" :uint8))]))

;; ============================================================================
;; –¢–ï–°–¢–û–í–´–ï –§–£–ù–ö–¶–ò–ò
;; ============================================================================

(defn test-constant-folding
  "–¢–µ—Å—Ç–∏—Ä—É–µ—Ç constant folding –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é"
  []
  (println "=== –¢–µ—Å—Ç Constant Folding ===")
  (let [original (create-test-constant-folding)
        optimized (opt/constant-fold original)]
    
    (println "\n–ò—Å—Ö–æ–¥–Ω—ã–π HIR:")
    (hir/pretty-print-hir original)
    
    (println "\n–ü–æ—Å–ª–µ constant folding:")
    (hir/pretty-print-hir optimized)
    
    (println "\n–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: x = 11 (5 + 3*2 = 5 + 6 = 11)")
    optimized))

(defn test-strength-reduction
  "–¢–µ—Å—Ç–∏—Ä—É–µ—Ç strength reduction –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é"
  []
  (println "\n=== –¢–µ—Å—Ç Strength Reduction ===")
  (let [original (create-test-strength-reduction)
        optimized (opt/strength-reduce original)]
    
    (println "\n–ò—Å—Ö–æ–¥–Ω—ã–π HIR:")
    (hir/pretty-print-hir original)
    
    (println "\n–ü–æ—Å–ª–µ strength reduction:")
    (hir/pretty-print-hir optimized)
    
    (println "\n–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: y = (a << 3) + (b >> 2)")
    optimized))

(defn test-dead-code-elimination
  "–¢–µ—Å—Ç–∏—Ä—É–µ—Ç dead code elimination –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é"
  []
  (println "\n=== –¢–µ—Å—Ç Dead Code Elimination ===")
  (let [original (create-test-dead-code)
        optimized (opt/dead-code-elimination original)]
    
    (println "\n–ò—Å—Ö–æ–¥–Ω—ã–π HIR:")
    (hir/pretty-print-hir original)
    
    (println "\n–ü–æ—Å–ª–µ dead code elimination:")
    (hir/pretty-print-hir optimized)
    
    (println "\n–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏–µ unused –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–¥–∞–ª–µ–Ω–æ")
    optimized))

(defn test-copy-propagation
  "–¢–µ—Å—Ç–∏—Ä—É–µ—Ç copy propagation –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é"
  []
  (println "\n=== –¢–µ—Å—Ç Copy Propagation ===")
  (let [original (create-test-copy-propagation)
        optimized (opt/copy-propagation original)]
    
    (println "\n–ò—Å—Ö–æ–¥–Ω—ã–π HIR:")
    (hir/pretty-print-hir original)
    
    (println "\n–ü–æ—Å–ª–µ copy propagation:")
    (hir/pretty-print-hir optimized)
    
    (println "\n–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: t –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ a –≤ –≤—ã—Ä–∞–∂–µ–Ω–∏–∏")
    optimized))

(defn test-all-optimizations
  "–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≤–º–µ—Å—Ç–µ"
  []
  (println "\n=== –¢–µ—Å—Ç –í—Å–µ—Ö –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π ===")
  (let [original (create-complex-test)
        optimized (opt/apply-simple-optimizations original)
        stats (opt/optimization-statistics original optimized)]
    
    (println "\n–ò—Å—Ö–æ–¥–Ω—ã–π HIR:")
    (hir/pretty-print-hir original)
    
    (println "\n–ü–æ—Å–ª–µ –≤—Å–µ—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:")
    (hir/pretty-print-hir optimized)
    
    (println "\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π:")
    (println (str "  –ò—Å—Ö–æ–¥–Ω—ã—Ö —É–∑–ª–æ–≤: " (:original-nodes stats)))
    (println (str "  –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤: " (:optimized-nodes stats)))
    (println (str "  –£–¥–∞–ª–µ–Ω–æ —É–∑–ª–æ–≤: " (:nodes-eliminated stats)))
    (println (str "  –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ: " (format "%.1f%%" (:reduction-percent stats))))
    
    optimized))

(defn test-iterative-optimization
  "–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é"
  []
  (println "\n=== –¢–µ—Å—Ç –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ ===")
  (let [original (create-complex-test)
        optimized (opt/optimize-iteratively original)
        stats (opt/optimization-statistics original optimized)]
    
    (println "\n–ò—Å—Ö–æ–¥–Ω—ã–π HIR:")
    (hir/pretty-print-hir original)
    
    (println "\n–ü–æ—Å–ª–µ –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:")
    (hir/pretty-print-hir optimized)
    
    (println "\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
    (println (str "  –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ: " (format "%.1f%%" (:reduction-percent stats))))
    
    optimized))

;; ============================================================================
;; –°–ü–ï–¶–ò–§–ò–ß–ù–´–ï –î–õ–Ø AT89S4051 –¢–ï–°–¢–´
;; ============================================================================

(defn test-at89s4051-bit-operations
  "–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –±–∏—Ç–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è AT89S4051"
  []
  (println "\n=== –¢–µ—Å—Ç –ë–∏—Ç–æ–≤—ã—Ö –û–ø–µ—Ä–∞—Ü–∏–π AT89S4051 ===")
  (let [original (hir/hir-block
                   [(hir/hir-assign
                      (hir/hir-variable "masked" :uint8)
                      (hir/hir-and
                        (hir/hir-variable "input" :uint8)
                        (hir/hir-constant 0xFF :uint8)
                        :uint8))
                    
                    (hir/hir-assign
                      (hir/hir-variable "cleared" :uint8)
                      (hir/hir-or
                        (hir/hir-variable "value" :uint8)
                        (hir/hir-constant 0 :uint8)
                        :uint8))])
        
        optimized (opt/apply-simple-optimizations original)]
    
    (println "\n–ò—Å—Ö–æ–¥–Ω—ã–π HIR:")
    (hir/pretty-print-hir original)
    
    (println "\n–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:")
    (hir/pretty-print-hir optimized)
    
    (println "\n–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:")
    (println "  masked = input (x & 0xFF ‚Üí x –¥–ª—è uint8)")
    (println "  cleared = value (x | 0 ‚Üí x)")
    
    optimized))

(defn test-at89s4051-arithmetic
  "–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è AT89S4051"
  []
  (println "\n=== –¢–µ—Å—Ç –ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏—Ö –û–ø–µ—Ä–∞—Ü–∏–π AT89S4051 ===")
  (let [original (hir/hir-block
                   [(hir/hir-assign
                      (hir/hir-variable "doubled" :uint8)
                      (hir/hir-mul
                        (hir/hir-variable "x" :uint8)
                        (hir/hir-constant 2 :uint8)
                        :uint8))
                    
                    (hir/hir-assign
                      (hir/hir-variable "halved" :uint8)
                      (hir/hir-div
                        (hir/hir-variable "y" :uint8)
                        (hir/hir-constant 2 :uint8)
                        :uint8))
                    
                    (hir/hir-assign
                      (hir/hir-variable "unchanged" :uint8)
                      (hir/hir-add
                        (hir/hir-variable "z" :uint8)
                        (hir/hir-constant 0 :uint8)
                        :uint8))])
        
        optimized (opt/apply-simple-optimizations original)]
    
    (println "\n–ò—Å—Ö–æ–¥–Ω—ã–π HIR:")
    (hir/pretty-print-hir original)
    
    (println "\n–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:")
    (hir/pretty-print-hir optimized)
    
    (println "\n–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:")
    (println "  doubled = x << 1 (x * 2 ‚Üí x << 1)")
    (println "  halved = y >> 1 (y / 2 ‚Üí y >> 1)")
    (println "  unchanged = z (z + 0 ‚Üí z)")
    
    optimized))

;; ============================================================================
;; –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
;; ============================================================================

(defn run-all-tests
  "–ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ —Ç–µ—Å—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π"
  []
  (println "üöÄ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–û–°–¢–´–• –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ô –ö–û–ú–ü–ò–õ–Ø–¢–û–†–ê C51")
  (println (str "=" (apply str (repeat 60 "="))))
  
  ;; –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã
  (test-constant-folding)
  (test-strength-reduction)
  (test-dead-code-elimination)
  (test-copy-propagation)
  
  ;; –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã
  (test-all-optimizations)
  (test-iterative-optimization)
  
  ;; –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è AT89S4051
  (test-at89s4051-bit-operations)
  (test-at89s4051-arithmetic)
  
  (println "\n‚úÖ –í–°–ï –¢–ï–°–¢–´ –ó–ê–í–ï–†–®–ï–ù–´")
  (println "\nüìä –í–´–í–û–î–´:")
  (println "  ‚Ä¢ Constant folding —É—Å–ø–µ—à–Ω–æ —Å–≤–µ—Ä—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è")
  (println "  ‚Ä¢ Strength reduction –∑–∞–º–µ–Ω—è–µ—Ç –¥–æ—Ä–æ–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ –¥–µ—à–µ–≤—ã–µ")
  (println "  ‚Ä¢ Dead code elimination —É–¥–∞–ª—è–µ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∫–æ–¥")
  (println "  ‚Ä¢ Copy propagation —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç –∫–æ–ø–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö")
  (println "  ‚Ä¢ –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç–∏–≥–∞–µ—Ç –Ω–µ–ø–æ–¥–≤–∏–∂–Ω–æ–π —Ç–æ—á–∫–∏")
  (println "  ‚Ä¢ –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–ª—è AT89S4051 –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"))

;; ============================================================================
;; –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–û–ù–ù–´–ï –ü–†–ò–ú–ï–†–´
;; ============================================================================

(defn demo-c51-optimization
  "–î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é —Ç–∏–ø–∏—á–Ω–æ–≥–æ C51 –∫–æ–¥–∞"
  []
  (println "\nüéØ –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–∏–ø–∏—á–Ω–æ–≥–æ C51 –∫–æ–¥–∞")
  (println (str "-" (apply str (repeat 50 "-"))))
  
  ;; –ò–º–∏—Ç–∏—Ä—É–µ–º HIR –¥–ª—è —Ç–∏–ø–∏—á–Ω–æ–≥–æ C51 –∫–æ–¥–∞:
  ;; uint8_t result = (input * 4) + (mask & 0xFF) + 0;
  ;; uint8_t unused = 42;
  ;; return result;
  
  (let [original (hir/hir-block
                   [(hir/hir-assign
                      (hir/hir-variable "result" :uint8)
                      (hir/hir-add
                        (hir/hir-add
                          (hir/hir-mul
                            (hir/hir-variable "input" :uint8)
                            (hir/hir-constant 4 :uint8)
                            :uint8)
                          (hir/hir-and
                            (hir/hir-variable "mask" :uint8)
                            (hir/hir-constant 0xFF :uint8)
                            :uint8)
                          :uint8)
                        (hir/hir-constant 0 :uint8)
                        :uint8))
                    
                    (hir/hir-assign
                      (hir/hir-variable "unused" :uint8)
                      (hir/hir-constant 42 :uint8))
                    
                    (hir/hir-return
                      (hir/hir-variable "result" :uint8))])
        
        optimized (opt/optimize-iteratively original)
        stats (opt/optimization-statistics original optimized)]
    
    (println "\n–ò—Å—Ö–æ–¥–Ω—ã–π C51 –∫–æ–¥ (–∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ):")
    (println "  uint8_t result = (input * 4) + (mask & 0xFF) + 0;")
    (println "  uint8_t unused = 42;")
    (println "  return result;")
    
    (println "\n–ò—Å—Ö–æ–¥–Ω—ã–π HIR:")
    (hir/pretty-print-hir original)
    
    (println "\n–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HIR:")
    (hir/pretty-print-hir optimized)
    
    (println "\n–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π C51 –∫–æ–¥ (–∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ):")
    (println "  uint8_t result = (input << 2) + mask;")
    (println "  return result;")
    
    (println "\n–ü—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:")
    (println "  ‚Ä¢ input * 4 ‚Üí input << 2 (strength reduction)")
    (println "  ‚Ä¢ mask & 0xFF ‚Üí mask (bitwise simplification)")
    (println "  ‚Ä¢ + 0 —É–¥–∞–ª–µ–Ω–æ (strength reduction)")
    (println "  ‚Ä¢ unused = 42 —É–¥–∞–ª–µ–Ω–æ (dead code elimination)")
    
    (println (str "\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: " (:nodes-eliminated stats) " —É–∑–ª–æ–≤ —É–¥–∞–ª–µ–Ω–æ ("
                  (format "%.1f%%" (:reduction-percent stats)) " —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ)"))
    
    optimized))

;; –ó–∞–ø—É—Å–∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞
(comment
  (run-all-tests)
  (demo-c51-optimization)
  )
```

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º –∏—Ç–æ–≥–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å –ø–ª–∞–Ω–æ–º —Ä–∞–∑–≤–∏—Ç–∏—è:

```markdown
# –ü–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ C51: –î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞

## üéØ –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

### ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **–ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä**: –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π C89 –∏ AT89S4051
- **–õ–µ–∫—Å–µ—Ä**: –¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è —Å C51-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–º–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
- **–ü–∞—Ä—Å–µ—Ä**: –ú–æ–Ω–∞–¥–∏—á–µ—Å–∫–∏–µ –∫–æ–º–±–∏–Ω–∞—Ç–æ—Ä—ã —Å –≥–∏–≥–∏–µ–Ω–∏—á–µ—Å–∫–∏–º–∏ –º–∞–∫—Ä–æ—Å–∞–º–∏
- **AST**: –ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–∏–ø–æ–≤ —É–∑–ª–æ–≤ —Å visitor pattern
- **HIR**: High-level –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ ‚ú® **–ù–û–í–û–ï**
- **–ü—Ä–æ—Å—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**: Constant folding, strength reduction, dead code elimination ‚ú® **–ù–û–í–û–ï**

### üöß –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
- **MIR**: Mid-level –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (—Ç—Ä—ë—Ö–∞–¥—Ä–µ—Å–Ω—ã–π –∫–æ–¥)
- **–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑**: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –∏ –æ–±–ª–∞—Å—Ç–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
- **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞**: AT89S4051 assembly

### üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è
- **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤**: –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ R0-R7, A, B
- **–õ–∏–Ω–∫–æ–≤–∫–∞**: –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- **–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ debugging

---

## üó∫Ô∏è –î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞ —Ä–∞–∑–≤–∏—Ç–∏—è

### –§–∞–∑–∞ 1: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ IR –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (2-3 –Ω–µ–¥–µ–ª–∏)

#### –ù–µ–¥–µ–ª—è 1: MIR –∏ –±–∞–∑–æ–≤—ã–µ –±–ª–æ–∫–∏
```
üìÖ –î–Ω–∏ 1-3: Mid-level IR (MIR)
- –¢—Ä—ë—Ö–∞–¥—Ä–µ—Å–Ω—ã–π –∫–æ–¥
- –ë–∞–∑–æ–≤—ã–µ –±–ª–æ–∫–∏
- Control Flow Graph (CFG)

üìÖ –î–Ω–∏ 4-5: HIR ‚Üí MIR –ø–æ–Ω–∏–∂–µ–Ω–∏–µ
- –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è —Ü–∏–∫–ª–æ–≤ –≤ –ø–µ—Ä–µ—Ö–æ–¥—ã
- –õ–∏–Ω–µ–∞—Ä–∏–∑–∞—Ü–∏—è –≤—ã—Ä–∞–∂–µ–Ω–∏–π
- –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

üìÖ –î–Ω–∏ 6-7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞
- Unit —Ç–µ—Å—Ç—ã –¥–ª—è MIR
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã HIR ‚Üí MIR
```

#### –ù–µ–¥–µ–ª—è 2: –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
```
üìÖ –î–Ω–∏ 1-3: –°–∏—Å—Ç–µ–º–∞ —Ç–∏–ø–æ–≤
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Ç–∏–ø–æ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤
- –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è AT89S4051

üìÖ –î–Ω–∏ 4-5: –û–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏
- Symbol table
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- –ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

üìÖ –î–Ω–∏ 6-7: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å AST
- AST ‚Üí HIR —Å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
- –°–±–æ—Ä –æ—à–∏–±–æ–∫ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π
```

#### –ù–µ–¥–µ–ª—è 3: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
```
üìÖ –î–Ω–∏ 1-2: –ê–Ω–∞–ª–∏–∑ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- Live variable analysis
- Reaching definitions
- Available expressions

üìÖ –î–Ω–∏ 3-4: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- Common subexpression elimination
- Loop-invariant code motion (–ø—Ä–æ—Å—Ç—ã–µ —Å–ª—É—á–∞–∏)
- Peephole optimization

üìÖ –î–Ω–∏ 5-7: AT89S4051-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞
- –ë–∏—Ç–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏
```

### –§–∞–∑–∞ 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ (3-4 –Ω–µ–¥–µ–ª–∏)

#### –ù–µ–¥–µ–ª—è 4: LIR –∏ —Ü–µ–ª–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
```
üìÖ –î–Ω–∏ 1-3: Low-level IR (LIR)
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ AT89S4051
- –†–µ–∂–∏–º—ã –∞–¥—Ä–µ—Å–∞—Ü–∏–∏
- –ü—Å–µ–≤–¥–æ–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

üìÖ –î–Ω–∏ 4-5: MIR ‚Üí LIR –ø–æ–Ω–∏–∂–µ–Ω–∏–µ
- –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –í—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–π

üìÖ –î–Ω–∏ 6-7: –ë–∞–∑–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞—Å—Å–µ–º–±–ª–µ—Ä–∞
- –ü—Ä–æ—Å—Ç—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- –ú–µ—Ç–∫–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥—ã
```

#### –ù–µ–¥–µ–ª—è 5: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
```
üìÖ –î–Ω–∏ 1-3: –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
- Linear scan allocation
- Spilling –≤ –ø–∞–º—è—Ç—å
- –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤

üìÖ –î–Ω–∏ 4-5: AT89S4051 —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞ A
- –†–µ–≥–∏—Å—Ç—Ä—ã R0-R7
- DPTR –¥–ª—è 16-–±–∏—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

üìÖ –î–Ω–∏ 6-7: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
- –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è MOV –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–µ
```

#### –ù–µ–¥–µ–ª—è 6: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
```
üìÖ –î–Ω–∏ 1-3: –ê—Å—Å–µ–º–±–ª–µ—Ä AT89S4051
- –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
- –î–∏—Ä–µ–∫—Ç–∏–≤—ã –∞—Å—Å–µ–º–±–ª–µ—Ä–∞
- –°–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∏–µ –∞–¥—Ä–µ—Å–∞

üìÖ –î–Ω–∏ 4-5: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞
- Peephole optimization –Ω–∞ —É—Ä–æ–≤–Ω–µ –∞—Å—Å–µ–º–±–ª–µ—Ä–∞
- –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

üìÖ –î–Ω–∏ 6-7: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- End-to-end —Ç–µ—Å—Ç—ã –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º–æ–≥–æ –∫–æ–¥–∞
```

#### –ù–µ–¥–µ–ª—è 7: –õ–∏–Ω–∫–æ–≤–∫–∞ –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
```
üìÖ –î–Ω–∏ 1-3: –ü—Ä–æ—Å—Ç–∞—è –ª–∏–Ω–∫–æ–≤–∫–∞
- –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–æ–≤
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HEX —Ñ–∞–π–ª–æ–≤

üìÖ –î–Ω–∏ 4-5: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ runtime
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è AT89S4051
- Startup –∫–æ–¥
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π

üìÖ –î–Ω–∏ 6-7: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –ø—Ä–∏–º–µ—Ä—ã
- –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–≥—Ä–∞–º–º
- Best practices
```

### –§–∞–∑–∞ 3: –ü–æ–ª–∏—Ä–æ–≤–∫–∞ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (2-3 –Ω–µ–¥–µ–ª–∏)

#### –ù–µ–¥–µ–ª—è 8: –û—Ç–ª–∞–¥–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
```
üìÖ –î–Ω–∏ 1-3: –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ –∏ –∞—Å—Å–µ–º–±–ª–µ—Ä–∞
- –°–∏–º–≤–æ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–ª–∞–¥—á–∏–∫–æ–≤

üìÖ –î–Ω–∏ 4-5: –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- –ë–µ–Ω—á–º–∞—Ä–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
- –£–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞

üìÖ –î–Ω–∏ 6-7: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏
```

#### –ù–µ–¥–µ–ª—è 9: –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏–π
```
üìÖ –î–Ω–∏ 1-3: –£—Ç–∏–ª–∏—Ç—ã
- –î–∏–∑–∞—Å—Å–µ–º–±–ª–µ—Ä
- –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–¥–∞
- –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫ –ø–∞–º—è—Ç–∏

üìÖ –î–Ω–∏ 4-5: IDE –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- Language Server Protocol
- –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
- –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ

üìÖ –î–Ω–∏ 6-7: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
- –ü—Ä–∏–º–µ—Ä—ã —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π
```

#### –ù–µ–¥–µ–ª—è 10: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–ª–∏–∑
```
üìÖ –î–Ω–∏ 1-3: Comprehensive —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- Stress —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –¢–µ—Å—Ç—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö

üìÖ –î–Ω–∏ 4-5: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ä–µ–ª–∏–∑—É
- –£–ø–∞–∫–æ–≤–∫–∞ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞
- –£—Å—Ç–∞–Ω–æ–≤–æ—á–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã
- CI/CD pipeline

üìÖ –î–Ω–∏ 6-7: –†–µ–ª–∏–∑ v1.0
- –ü—É–±–ª–∏–∫–∞—Ü–∏—è
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```

---

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä: –†–µ—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ ‚úÖ
**–í–µ—Ä–¥–∏–∫—Ç**: –û—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –±–µ–∑ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**: 
- –†–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- –ï—Å—Ç—å –±–æ–ª–µ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏ (IR, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞)
- Transducers —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ–∑–∂–µ

### IR: –í –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ üöß
**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å**: HIR –≥–æ—Ç–æ–≤, MIR –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏**:
1. –ó–∞–≤–µ—Ä—à–∏—Ç—å MIR —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å HIR ‚Üí MIR —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é
3. –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: –ë–∞–∑–æ–≤—ã–µ –≥–æ—Ç–æ–≤—ã ‚úÖ
**–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã**:
- Constant folding
- Strength reduction  
- Dead code elimination
- Copy propagation

**–ü–ª–∞–Ω–∏—Ä—É—é—Ç—Å—è**:
- Common subexpression elimination
- Loop optimizations
- AT89S4051-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

### –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
- **–†–∞–∑–º–µ—Ä**: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ 15-25% –º–µ–Ω—å—à–µ –Ω–∞–∏–≤–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- **–°–∫–æ—Ä–æ—Å—Ç—å**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ 10-20% –±—ã—Å—Ç—Ä–µ–µ
- **–ü–∞–º—è—Ç—å**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAM –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞
- **–°–∫–æ—Ä–æ—Å—Ç—å –∫–æ–º–ø–∏–ª—è—Ü–∏–∏**: < 1 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤ –¥–æ 1000 —Å—Ç—Ä–æ–∫
- **–ü–∞–º—è—Ç—å**: < 100MB RAM –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–∏–Ω–µ–π–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–¥–∞

### –ö–∞—á–µ—Å—Ç–≤–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- **–û—à–∏–±–∫–∏**: –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞ –∏ –ø—Ä–∏—á–∏–Ω—ã
- **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è**: –ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ**: –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫–æ–º–ø–∏–ª—è—Ü–∏—é –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã
1. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å**: –ö–∞–∂–¥—ã–π —ç—Ç–∞–ø –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ - –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å
2. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**: Comprehensive unit –∏ integration —Ç–µ—Å—Ç—ã
3. **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å**: –ü—Ä–æ—Å—Ç–æ—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö

### –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
- **–Ø–∑—ã–∫**: Clojure (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ)
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: clojure.test + property-based testing
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: Markdown + code examples
- **CI/CD**: GitHub Actions (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)

### –°—Ç–∞–Ω–¥–∞—Ä—Ç—ã –∫–æ–¥–∞
- **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**: –ù–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è
- **–ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ**: –û–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–π –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞**: –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ namespace'—ã
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: clojure.spec –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (—ç—Ç–∞ –Ω–µ–¥–µ–ª—è)
1. ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å HIR –º–æ–¥—É–ª—å (–≥–æ—Ç–æ–≤–æ)
2. ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–≥–æ—Ç–æ–≤–æ)
3. üîÑ –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É –Ω–∞–¥ MIR
4. üîÑ –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è HIR ‚Üí MIR —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ —Ü–µ–ª–∏ (1 –º–µ—Å—è—Ü)
1. –ó–∞–≤–µ—Ä—à–∏—Ç—å MIR –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
3. –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
4. –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É –Ω–∞–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –∫–æ–¥–∞

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —Ü–µ–ª–∏ (3 –º–µ—Å—è—Ü–∞)
1. –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä C51 ‚Üí AT89S4051
2. Comprehensive —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö
3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –ø—Ä–∏–º–µ—Ä—ã
4. –†–µ–ª–∏–∑ v1.0

---

## üìö –†–µ—Å—É—Ä—Å—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –°–æ–∑–¥–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `PREPROCESSOR_ARCHITECTURE_ANALYSIS.md` - –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
- `IR_DESIGN_SIMPLE_OPTIMIZATIONS.md` - –î–∏–∑–∞–π–Ω IR –∏ –ø—Ä–æ—Å—Ç—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
- `AST_README.md` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ AST –º–æ–¥—É–ª—é
- `PREPROCESSOR_README.md` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—É

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏
- `c51cc.ir.hir` - High-level –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
- `c51cc.optimizations.simple` - –ü—Ä–æ—Å—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- `test-simple-optimizations.clj` - –¢–µ—Å—Ç—ã –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è

### –ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `MIR_SPECIFICATION.md` - –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è MIR
- `CODE_GENERATION_GUIDE.md` - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞
- `AT89S4051_TARGET_GUIDE.md` - –°–ø–µ—Ü–∏—Ñ–∏–∫–∞ —Ü–µ–ª–µ–≤–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

---

*–î–æ—Ä–æ–∂–Ω–∞—è –∫–∞—Ä—Ç–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ –º–µ—Ä–µ —Ä–∞–∑–≤–∏—Ç–∏—è –ø—Ä–æ–µ–∫—Ç–∞*  
*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –î–µ–∫–∞–±—Ä—å 2024*  
*–°—Ç–∞—Ç—É—Å: HIR –∏ –ø—Ä–æ—Å—Ç—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã, MIR –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ*
```

–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏–º —Ç–µ—Å—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å–æ–∑–¥–∞–Ω–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

–ü–æ–ø—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –¥—Ä—É–≥–∏–º —Å–ø–æ—Å–æ–±–æ–º:

–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –ø–æ–ø—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç:

–ü–æ–ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª:

