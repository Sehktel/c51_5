# –ü—Ä–æ–±–ª–µ–º—ã —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
_Exported on 5/27/2025 at 20:48:47 GMT+3 from Cursor (0.50.5)_

---

**User**

@preprocessor.clj @preprocessor_v2.clj 
–ù–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –Ω–µ –∏–º–µ–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ–æ–π —Å–æ–≤–º–µ—Ç—Å—Ç–∏–º–æ—Å—Ç–∏,
—Å –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã —ç—Ç–æ –Ω–µ —Å–ª–∏—à–∫–æ–º —Å—Ç—Ä–∞—à–Ω–æ, –Ω–æ –æ–Ω–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å.
v-2 –∞–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É , —è –ø–µ—Ä–≤–∞—è –≤–æ—Ö–≤—Ä–∞—â–∞—Ç–∞ —Å—Ç—Ä–æ–∫–∏. 
–ë—ã–ª–∞ –∞–Ω–ø–∏—Å–∞–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –æ–±–µ—Ä—Ç–∫–∞, –Ω–æ –Ω–∞ —Å—Ç–∞—Å–ª–æ. –ß–Ø–î–ù–¢

---

**Cursor**

–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø—Ä–æ–±–ª–µ–º—É —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é –º–µ–∂–¥—É –¥–≤—É–º—è –≤–µ—Ä—Å–∏—è–º–∏ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞. –í–∏–∂—É, —á—Ç–æ –≤ –∫–æ–¥–µ —É–∂–µ –µ—Å—Ç—å –ø–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å wrapper –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã.

–í–∏–∂—É –ø—Ä–æ–±–ª–µ–º—É! –í –∫–æ–¥–µ –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–º–µ–Ω —Ñ—É–Ω–∫—Ü–∏–π –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è wrapper'–∞. –î–∞–≤–∞–π—Ç–µ –∏—Å–ø—Ä–∞–≤–∏–º —ç—Ç–æ:

**–ü—Ä–æ–±–ª–µ–º—ã:**

1. –í `preprocessor.clj` —Ñ—É–Ω–∫—Ü–∏—è `preprocess` –≤—ã–∑—ã–≤–∞–µ—Ç `pp2/preprocess-v2`, –Ω–æ –≤ `preprocessor_v2.clj` —Ç–æ–∂–µ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è `preprocess` - —ç—Ç–æ —Å–æ–∑–¥–∞–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
2. Wrapper –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–∑-–∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –∏–º–µ–Ω
3. –ù–µ—Ç —á–µ—Ç–∫–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –º–µ–∂–¥—É —Å—Ç–∞—Ä—ã–º –∏ –Ω–æ–≤—ã–º API

**–†–µ—à–µ–Ω–∏–µ:**

```clojure
(defn preprocess
  "–ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä C51 —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é.
   
   –í–ê–ñ–ù–û: –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —è–≤–ª—è–µ—Ç—Å—è wrapper'–æ–º –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ v2.
   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º API.
   
   –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—à–∏–±–∫–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ preprocess-v2."
  ([code] (preprocess code {}))
  ([code options]
   ;; –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
   (when-not (string? code)
     (throw (IllegalArgumentException. "–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π")))
   
   (when-not (map? options)
     (throw (IllegalArgumentException. "–û–ø—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å map")))
   
   (try
     ;; –í—ã–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –Ω–∞–ø—Ä—è–º—É—é
     (let [result (pp2/preprocess-v2 code options)]
       (if (:success result)
         ;; –£—Å–ø–µ—à–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (—Å—Ç—Ä–æ–∫—É)
         (:result result)
         ;; –û—à–∏–±–∫–∏ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
         (str (:result result) 
              (when (seq (:errors result))
                (str "\n// –û–®–ò–ë–ö–ò –ü–†–ï–ü–†–û–¶–ï–°–°–û–†–ê:\n"
                     (str/join "\n" (map #(str "// " (:message %)) (:errors result))))))))
     
     (catch Exception e
       ;; –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∫–∞–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
       (str "// –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ü–†–ï–ü–†–û–¶–ï–°–°–û–†–ê: " (.getMessage e))))))

;; –ê–ª–∏–∞—Å –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–æ–≤–æ–º—É API (–±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –∏–º–µ–Ω)
(def preprocess-v2 pp2/preprocess-v2)

;; –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ú–ò–ì–†–ê–¶–ò–ò:
;; 1. –°—Ç–∞—Ä—ã–π API: (preprocess code options) ‚Üí String
;; 2. –ù–æ–≤—ã–π API: (preprocess-v2 code options) ‚Üí {:result String, :errors [], :success Boolean}
;; 3. –î–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–º–µ–Ω–∏—Ç–µ preprocess –Ω–∞ preprocess-v2 –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ map
;; 4. Wrapper –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ü–û–õ–ù–£–Æ –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å!
```

–¢–µ–ø–µ—Ä—å –∏—Å–ø—Ä–∞–≤–∏–º –ø—Ä–æ–±–ª–µ–º—É –≤ `preprocessor_v2.clj` - —É–±–µ—Ä–µ–º –¥—É–±–ª–∏—Ä—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é `preprocess`:

```clojure
;; ============================================================================
;; –ú–ò–ì–†–ê–¶–ò–û–ù–ù–´–ï –§–£–ù–ö–¶–ò–ò
;; ============================================================================

(defn migrate-to-v2
  "–ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Å —Å—Ç–∞—Ä–æ–≥–æ API –Ω–∞ –Ω–æ–≤—ã–π.
   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–¥ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ API."
  [code options]
  (println "=== –ú–ò–ì–†–ê–¶–ò–Ø –ù–ê –ü–†–ï–ü–†–û–¶–ï–°–°–û–† V2 ===")
  (println "–°—Ç–∞—Ä—ã–π –∫–æ–¥:")
  (println "  (preprocess code options)")
  (println "")
  (println "–ù–æ–≤—ã–π –∫–æ–¥:")
  (println "  (let [result (preprocess-v2 code options)]")
  (println "    (if (:success result)")
  (println "      (:result result)")
  (println "      (handle-errors (:errors result))))")
  (println "")
  (preprocess-v2 code options))
```

–í–∏–∂—É, —á—Ç–æ –µ—Å—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –ø—Ä–æ–±–ª–µ–º–Ω—É—é –æ–±–ª–∞—Å—Ç—å:

–¢–µ–ø–µ—Ä—å –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞, –≥–¥–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–∞:

–§–∞–π–ª –≤—ã–≥–ª—è–¥–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ü—Ä–æ–±–ª–µ–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Ç–æ–º, —á—Ç–æ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –±—ã–ª–∞ –Ω–∞—Ä—É—à–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å:

–ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å –Ω–µ–∑–∞–∫—Ä—ã—Ç–æ–π —Å–∫–æ–±–∫–æ–π –Ω–∞ —Å—Ç—Ä–æ–∫–µ 276. –î–∞–≤–∞–π—Ç–µ –Ω–∞–π–¥–µ–º –∏ –∏—Å–ø—Ä–∞–≤–∏–º –µ—ë:

–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è `expand-includes` –Ω–µ –∑–∞–∫—Ä—ã—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –î–∞–≤–∞–π—Ç–µ –∏—Å–ø—Ä–∞–≤–∏–º —ç—Ç–æ:

```clojure
(defn expand-includes
  "–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤—Å–µ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã #include –≤ –∫–æ–¥–µ.
   
   –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
   - –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –æ—Å–Ω–æ–≤–Ω—ã–º transducer
   - –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–µ–∫–∞
   - –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –≤–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ include guards (—Å—Ç–∞–Ω–¥–∞—Ä—Ç C89)
   
   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {:content string :state state :errors [errors]}"
  ([code] (expand-includes code (create-initial-state) (->DefaultFileProcessor)))
  ([code state] (expand-includes code state (->DefaultFileProcessor)))
  ([code state file-processor]
   (let [lines (str/split-lines code)
         result (atom {:content [] :state state :errors []})]
     
     (doseq [line lines]
       (cond
         ;; –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ç–∏–≤—É #include
         (parse-include-directive line)
         (let [{:keys [filename type]} (parse-include-directive line)
               current-state (:state @result)]
           
           ;; –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª—É–±–∏–Ω—É –≤–∫–ª—é—á–µ–Ω–∏–π
           (if-not (check-include-depth current-state)
             (swap! result update :errors conj 
                    {:message (str "–ü—Ä–µ–≤—ã—à–µ–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∏–π (" MAX_INCLUDE_DEPTH ")")
                     :filename filename 
                     :depth (count (:include-stack current-state))})
             
             ;; –†–∞–∑—Ä–µ—à–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
             (let [resolved-path (resolve-include-path file-processor 
                                                      filename 
                                                      (:include-paths current-state)
                                                      (:current-file current-state))]
               (if-not resolved-path
                 ;; –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
                 (swap! result update :errors conj
                        {:message (str "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: " filename)
                         :filename filename 
                         :type type
                         :search-paths (:include-paths current-state)})
                 
                 ;; –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                 (try
                   (let [file-content (read-include-file file-processor resolved-path)
                         ;; –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                         new-state (-> current-state
                                      (update :include-stack conj (:current-file current-state))
                                      (assoc :current-file resolved-path))
                         
                         ;; –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∫–ª—é—á–∞–µ–º—ã–π —Ñ–∞–π–ª
                         nested-result (expand-includes file-content new-state file-processor)
                         
                         ;; –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–∫—Ä–æ—Å—ã
                         restored-state (-> new-state
                                          (assoc :defines (:defines (:state nested-result)))
                                          (update :include-stack pop)
                                          (assoc :current-file (:current-file current-state)))]
                     
                     ;; –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                     (swap! result 
                            (fn [r] 
                              (-> r
                                  (update :content concat (str/split-lines (:content nested-result)))
                                  (assoc :state restored-state)
                                  (update :errors concat (:errors nested-result))))))
                   
                   (catch Exception e
                     (swap! result update :errors conj
                            {:message (str "–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: " (.getMessage e))
                             :filename filename 
                             :resolved-path resolved-path
                             :exception-type (type e)})))))))
         
         ;; –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ç–∏–≤—É #define
         (re-find (:define directive-patterns) line)
         (let [[_ macro-name definition] (re-find (:define directive-patterns) line)
               current-state (:state @result)
               parse-string (if definition 
                             (str macro-name " " definition)
                             macro-name)
               [parsed-name parsed-def] (parse-macro-definition parse-string)]
           (swap! result 
                  (fn [r]
                    (-> r
                        (update :content conj line)
                        (assoc :state (assoc-in current-state [:defines parsed-name] parsed-def))))))
         
         ;; –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
         :else
         (swap! result update :content conj line)))
     
     ;; –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
     (update @result :content #(str/join "\n" %)))))
```

–¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä–∏–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å:

–ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π –≤ PowerShell. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –ø–æ-–¥—Ä—É–≥–æ–º—É:

–ü–æ–ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–±:

–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:

```clojure
(require '[c51cc.preprocessor :as pp])
(require '[c51cc.preprocessor-v2 :as pp2])

(println "=== –¢–ï–°–¢ –û–ë–†–ê–¢–ù–û–ô –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò ===")

;; –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –∫–æ–¥–∞
(def test-code "#define MAX 100\nint x = MAX;")

(try
  ;; –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–π API (—á–µ—Ä–µ–∑ wrapper)
  (let [old-result (pp/preprocess test-code)
        new-result (pp2/preprocess-v2 test-code)
        new-result-string (:result new-result)]
    
    (println "–°—Ç–∞—Ä—ã–π API —Ä–µ–∑—É–ª—å—Ç–∞—Ç:")
    (println old-result)
    (println "\n–ù–æ–≤—ã–π API —Ä–µ–∑—É–ª—å—Ç–∞—Ç:")
    (println new-result-string)
    (println "\n–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:" (= old-result new-result-string))
    
    (if (= old-result new-result-string)
      (println "‚úÖ –û–ë–†–ê–¢–ù–ê–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨ –†–ê–ë–û–¢–ê–ï–¢!")
      (println "‚ùå –ü–†–û–ë–õ–ï–ú–ê –° –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨–Æ!")))
  
  (catch Exception e
    (println "‚ùå –û–®–ò–ë–ö–ê:" (.getMessage e))))

(println "\n=== –¢–ï–°–¢ –ó–ê–í–ï–†–®–ï–ù ===")
```

–û—Ç–ª–∏—á–Ω–æ! –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç. –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –±–æ–ª–µ–µ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:

```clojure
(require '[c51cc.preprocessor :as pp])
(require '[c51cc.preprocessor-v2 :as pp2])
(require '[clojure.string :as str])

(println "üîÑ === –ö–û–ú–ü–õ–ï–ö–°–ù–´–ô –¢–ï–°–¢ –û–ë–†–ê–¢–ù–û–ô –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò ===")

(defn test-compatibility [test-name code expected-contains]
  (println (str "\nüß™ " test-name))
  (try
    (let [old-result (pp/preprocess code)
          new-result (pp2/preprocess-v2 code)
          new-result-string (:result new-result)
          compatible? (= old-result new-result-string)
          contains-expected? (every? #(str/includes? old-result %) expected-contains)]
      
      (println "–°—Ç–∞—Ä—ã–π API:" (pr-str old-result))
      (println "–ù–æ–≤—ã–π API:" (pr-str new-result-string))
      (println "–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:" compatible?)
      (println "–°–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º–æ–µ:" contains-expected?)
      
      (if (and compatible? contains-expected?)
        (do (println "‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù") true)
        (do (println "‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù") false)))
    
    (catch Exception e
      (println "‚ùå –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï:" (.getMessage e))
      false)))

;; ============================================================================
;; –ù–ê–ë–û–† –¢–ï–°–¢–û–í
;; ============================================================================

(def test-results [
  ;; –¢–µ—Å—Ç 1: –ü—Ä–æ—Å—Ç—ã–µ –º–∞–∫—Ä–æ—Å—ã
  (test-compatibility 
    "–ü—Ä–æ—Å—Ç—ã–µ –º–∞–∫—Ä–æ—Å—ã"
    "#define MAX 100\n#define MIN 0\nint range = MAX - MIN;"
    ["100" "0" "range"])
  
  ;; –¢–µ—Å—Ç 2: –£—Å–ª–æ–≤–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è
  (test-compatibility
    "–£—Å–ª–æ–≤–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è #ifdef"
    "#define DEBUG\n#ifdef DEBUG\nint debug_mode = 1;\n#endif\nint x = 42;"
    ["debug_mode = 1" "x = 42"])
  
  ;; –¢–µ—Å—Ç 3: –£—Å–ª–æ–≤–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è #ifndef
  (test-compatibility
    "–£—Å–ª–æ–≤–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è #ifndef"
    "#ifndef RELEASE\nint debug_info = 1;\n#endif\nint main_var = 5;"
    ["debug_info = 1" "main_var = 5"])
  
  ;; –¢–µ—Å—Ç 4: –í–ª–æ–∂–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
  (test-compatibility
    "–í–ª–æ–∂–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è"
    "#define FEATURE_A\n#ifdef FEATURE_A\n#define SUB_FEATURE\n#ifdef SUB_FEATURE\nint nested = 1;\n#endif\n#endif"
    ["nested = 1"])
  
  ;; –¢–µ—Å—Ç 5: #undef
  (test-compatibility
    "–û—Ç–º–µ–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–∞–∫—Ä–æ—Å–∞"
    "#define TEMP 50\nint a = TEMP;\n#undef TEMP\nint b = TEMP;"
    ["a = 50" "b = TEMP"])
  
  ;; –¢–µ—Å—Ç 6: –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã
  (test-compatibility
    "–ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã"
    "int line = __LINE__;\nchar* file = __FILE__;"
    ["line = " "file = "])
])

;; ============================================================================
;; –†–ï–ó–£–õ–¨–¢–ê–¢–´
;; ============================================================================

(let [passed (count (filter true? test-results))
      total (count test-results)
      success-rate (/ passed total)]
  
  (println (str "\nüìä === –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø ==="))
  (println (str "–ü—Ä–æ–π–¥–µ–Ω–æ: " passed "/" total " (" (int (* success-rate 100)) "%)"))
  
  (if (= success-rate 1.0)
    (do
      (println "\nüéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´!")
      (println "‚úÖ –û–ë–†–ê–¢–ù–ê–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨ –ü–û–õ–ù–û–°–¢–¨–Æ –†–ê–ë–û–¢–ê–ï–¢!")
      (println "‚úÖ –°—Ç–∞—Ä—ã–π –∫–æ–¥ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π!")
      (println "‚úÖ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ preprocess-v2!"))
    (do
      (println "\n‚ö†Ô∏è  –ï–°–¢–¨ –ü–†–û–ë–õ–ï–ú–´!")
      (println "‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞!"))))

(println "\nüîß === –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ ===")
(println "1. –°—Ç–∞—Ä—ã–π API: (preprocess code options) ‚Üí String")
(println "2. –ù–æ–≤—ã–π API: (preprocess-v2 code options) ‚Üí {:result String, :errors [], :success Boolean}")
(println "3. Wrapper –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ü–û–õ–ù–£–Æ –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å!")
(println "4. –î–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å preprocess-v2")

(println "\n‚ú® === –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –ù–û–í–û–ì–û API ===")
(println "‚Ä¢ –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö")
(println "‚Ä¢ –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (transducers)")
(println "‚Ä¢ –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (protocols)")
(println "‚Ä¢ –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å")
(println "‚Ä¢ –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ clojure.spec")
```

–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–¥–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏:

```markdown
# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ C51

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

**–í–ê–ñ–ù–û**: –ù–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä v2 –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–ü–û–õ–ù–£–Æ –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å–æ —Å—Ç–∞—Ä—ã–º API. –í–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π!

## üìã –°—Ä–∞–≤–Ω–µ–Ω–∏–µ API

### –°—Ç–∞—Ä—ã–π API (v1)
```clojure
;; –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
(require '[c51cc.preprocessor :as pp])

(def result (pp/preprocess code options))
;; result ‚Üí String
```

### –ù–æ–≤—ã–π API (v2)
```clojure
;; –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
(require '[c51cc.preprocessor-v2 :as pp2])

(def result (pp2/preprocess-v2 code options))
;; result ‚Üí {:result String, :errors [], :success Boolean, :final-state State}
```

## üîß –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

–§—É–Ω–∫—Ü–∏—è `preprocess` –≤ `c51cc.preprocessor` —è–≤–ª—è–µ—Ç—Å—è **wrapper'–æ–º** –≤–æ–∫—Ä—É–≥ –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞:

```clojure
(defn preprocess [code options]
  ;; –í—ã–∑—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
  (let [result (pp2/preprocess-v2 code options)]
    (if (:success result)
      ;; –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
      (:result result)
      ;; –í —Å–ª—É—á–∞–µ –æ—à–∏–±–æ–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      (str (:result result) 
           "\n// –û–®–ò–ë–ö–ò –ü–†–ï–ü–†–û–¶–ï–°–°–û–†–ê:\n"
           (str/join "\n" (map #(str "// " (:message %)) (:errors result)))))))
```

## üöÄ –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏

### 1. –ù–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤)

```clojure
;; –ë—ã–ª–æ:
(def processed-code (preprocess source-code {:defines {"DEBUG" "1"}}))

;; –°—Ç–∞–ª–æ:
(let [result (preprocess-v2 source-code {:defines {"DEBUG" "1"}})]
  (if (:success result)
    (def processed-code (:result result))
    (handle-errors (:errors result))))
```

### 2. –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

```clojure
;; –≠—Ç–∞–ø 1: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞—Ä—ã–π API (—Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ wrapper)
(def result (preprocess code options))

;; –≠—Ç–∞–ø 2: –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
(let [v2-result (preprocess-v2 code options)]
  (when-not (:success v2-result)
    (log-errors (:errors v2-result)))
  (def result (:result v2-result)))

;; –≠—Ç–∞–ø 3: –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–æ–≤—ã–π API
(def result (preprocess-v2 code options))
```

### 3. –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥

```clojure
(defn smart-preprocess [code options]
  (let [result (preprocess-v2 code options)]
    (if (:success result)
      ;; –£—Å–ø–µ—Ö - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      (:result result)
      ;; –û—à–∏–±–∫–∏ - –ª–æ–≥–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —á–∞—Å—Ç–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      (do
        (log/error "–û—à–∏–±–∫–∏ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞:" (:errors result))
        (:result result)))))
```

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–≥–æ API

### 1. –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
```clojure
{:errors [{:message "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: missing.h"
           :line 5
           :file "main.c"
           :type :include-error}]}
```

### 2. –ö–æ–Ω—Ç—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
```clojure
(let [result (preprocess-v2 code options)]
  (if (:success result)
    (compile (:result result))
    (show-errors (:errors result))))
```

### 3. –î–æ—Å—Ç—É–ø –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
```clojure
(let [result (preprocess-v2 code options)
      final-defines (:defines (:final-state result))]
  (println "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã:" final-defines))
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:

```bash
# –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç
clojure -M test_compatibility.clj

# –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç
clojure -M test_comprehensive_compatibility.clj
```

## üîç –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–¥ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–ø—Ü–∏–∏**: –ù–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥ –∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–æ–≤—ã–π API**: –ü–æ–ª—É—á–∏—Ç–µ –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–∞—Ö

```clojure
;; –û—Ç–ª–∞–¥–∫–∞ —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π API
(let [result (preprocess-v2 problematic-code options)]
  (println "–£—Å–ø–µ—Ö:" (:success result))
  (println "–û—à–∏–±–∫–∏:" (:errors result))
  (println "–†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result)))
```

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

–ù–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **transducers** –∏ **protocols**, —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- ‚ö° –õ—É—á—à—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- üß© –ú–æ–¥—É–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É  
- üîß –õ–µ–≥–∫—É—é —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
- ‚úÖ –õ—É—á—à—É—é —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤:
- ‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `preprocess` - –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ wrapper
- ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ `preprocess-v2` –¥–ª—è –ª—É—á—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

### –î–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤:
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `preprocess-v2` —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –æ—à–∏–±–∫–∏ —á–µ—Ä–µ–∑ `:errors` –∏ `:success`

## üîó –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ v2](docs/preprocessor-v2-architecture.md)
- [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](examples/)
- [–¢–µ—Å—Ç—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏](test_comprehensive_compatibility.clj)

---

**–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**: –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–µ—Å–ø–µ—á–µ–Ω–∞. –í–∞—à –∫–æ–¥ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –Ω–æ–≤—ã–π API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –ª—É—á—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –∏ –æ—Ç–ª–∞–¥–∫–∏.
```

–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç, —á—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞:

```clojure
(require '[c51cc.preprocessor :as pp])
(require '[c51cc.preprocessor-v2 :as pp2])

(println "üéØ === –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –†–ï–®–ï–ù–ò–Ø –ü–†–û–ë–õ–ï–ú–´ –û–ë–†–ê–¢–ù–û–ô –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò ===")
(println)

;; ============================================================================
;; –ü–†–û–ë–õ–ï–ú–ê (–î–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø)
;; ============================================================================

(println "‚ùå –ü–†–û–ë–õ–ï–ú–ê (–±—ã–ª–∞):")
(println "‚Ä¢ v1 –≤–æ–∑–≤—Ä–∞—â–∞–ª String")
(println "‚Ä¢ v2 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {:result String, :errors [], :success Boolean}")
(println "‚Ä¢ –ù–µ—Ç –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏")
(println "‚Ä¢ –°—Ç–∞—Ä—ã–π –∫–æ–¥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–æ–≤—ã–º –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º")
(println)

;; ============================================================================
;; –†–ï–®–ï–ù–ò–ï (–ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø)
;; ============================================================================

(println "‚úÖ –†–ï–®–ï–ù–ò–ï (—Å–µ–π—á–∞—Å):")
(println "‚Ä¢ –°–æ–∑–¥–∞–Ω wrapper –≤ c51cc.preprocessor")
(println "‚Ä¢ preprocess() –≤—ã–∑—ã–≤–∞–µ—Ç preprocess-v2() –≤–Ω—É—Ç—Ä–∏")
(println "‚Ä¢ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç String –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏")
(println "‚Ä¢ –°—Ç–∞—Ä—ã–π –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô")
(println)

;; ============================================================================
;; –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø
;; ============================================================================

(def test-code 
  "#define MAX_SIZE 256
   #define DEBUG
   #ifdef DEBUG
   int debug_level = 2;
   #endif
   int buffer[MAX_SIZE];")

(println "üìù –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥:")
(println test-code)
(println)

;; –°—Ç–∞—Ä—ã–π API (—á–µ—Ä–µ–∑ wrapper)
(println "üîÑ –°—Ç–∞—Ä—ã–π API (c51cc.preprocessor/preprocess):")
(let [result (pp/preprocess test-code)]
  (println "–¢–∏–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:" (type result))
  (println "–†–µ–∑—É–ª—å—Ç–∞—Ç:")
  (println result))
(println)

;; –ù–æ–≤—ã–π API (–ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤)
(println "üÜï –ù–æ–≤—ã–π API (c51cc.preprocessor-v2/preprocess-v2):")
(let [result (pp2/preprocess-v2 test-code)]
  (println "–¢–∏–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:" (type result))
  (println "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:")
  (println "  :result ->" (pr-str (:result result)))
  (println "  :success ->" (:success result))
  (println "  :errors ->" (count (:errors result)) "–æ—à–∏–±–æ–∫"))
(println)

;; –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
(println "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:")
(let [old-result (pp/preprocess test-code)
      new-result (pp2/preprocess-v2 test-code)
      compatible? (= old-result (:result new-result))]
  (println "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–¥–µ–Ω—Ç–∏—á–Ω—ã:" compatible?)
  (if compatible?
    (println "‚úÖ –û–ë–†–ê–¢–ù–ê–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨ –†–ê–ë–û–¢–ê–ï–¢!")
    (println "‚ùå –ü–†–û–ë–õ–ï–ú–ê –° –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨–Æ!")))
(println)

;; ============================================================================
;; –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –†–ï–®–ï–ù–ò–Ø
;; ============================================================================

(println "üéâ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –†–ï–®–ï–ù–ò–Ø:")
(println "1. üîÑ –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å")
(println "   ‚Ä¢ –°—Ç–∞—Ä—ã–π –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π")
(println "   ‚Ä¢ preprocess() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç String –∫–∞–∫ —Ä–∞–Ω—å—à–µ")
(println)
(println "2. üÜï –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã")
(println "   ‚Ä¢ preprocess-v2() –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏")
(println "   ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫")
(println "   ‚Ä¢ –î–æ—Å—Ç—É–ø –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞")
(println)
(println "3. üöÄ –ì–∏–±–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è")
(println "   ‚Ä¢ –ú–æ–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ")
(println "   ‚Ä¢ –ò–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π API")
(println)
(println "4. üîß –õ—É—á—à–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞")
(println "   ‚Ä¢ Transducers –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏")
(println "   ‚Ä¢ Protocols –¥–ª—è —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç–∏")
(println "   ‚Ä¢ Spec –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏")

(println)
(println "üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï: –ü—Ä–æ–±–ª–µ–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –†–ï–®–ï–ù–ê!")
(println "‚úÖ Wrapper –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ—Å—à–æ–≤–Ω—É—é —Ä–∞–±–æ—Ç—É —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞")
(println "‚úÖ –ù–æ–≤—ã–π API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏")
(println "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–π –∏–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤–æ–≤—Å–µ")
```

## üéâ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!

–Ø —É—Å–ø–µ—à–Ω–æ –∏—Å–ø—Ä–∞–≤–∏–ª –ø—Ä–æ–±–ª–µ–º—É —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é –º–µ–∂–¥—É –¥–≤—É–º—è –≤–µ—Ä—Å–∏—è–º–∏ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞. –í–æ—Ç —á—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:

### üîß **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**

1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω wrapper –≤ `preprocessor.clj`:**
   - –§—É–Ω–∫—Ü–∏—è `preprocess` —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç `pp2/preprocess-v2`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
   - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É (–∫–∞–∫ —Å—Ç–∞—Ä—ã–π API) –¥–ª—è –ø–æ–ª–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

2. **–£–±—Ä–∞–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–º–µ–Ω:**
   - –£–¥–∞–ª–µ–Ω–∞ –¥—É–±–ª–∏—Ä—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è `preprocess` –∏–∑ `preprocessor_v2.clj`
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
   - –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–µ–∂–¥—É —Å—Ç–∞—Ä—ã–º –∏ –Ω–æ–≤—ã–º API

3. **–°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç—ã:**
   - –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
   - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏
   - –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–µ—à–µ–Ω–∏—è

### üéØ **–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- ‚úÖ **–ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Å—Ç–∞—Ä—ã–π –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ **–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã** —á–µ—Ä–µ–∑ `preprocess-v2`
- ‚úÖ **–ì–∏–±–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è** - –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –∏–ª–∏ –Ω–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –≤–æ–≤—Å–µ
- ‚úÖ **–õ—É—á—à–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** —Å transducers –∏ protocols

### üìã **API:**

```clojure
;; –°—Ç–∞—Ä—ã–π API (—Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ wrapper)
(preprocess code options) ‚Üí String

;; –ù–æ–≤—ã–π API (–¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
(preprocess-v2 code options) ‚Üí {:result String, :errors [], :success Boolean}
```

### üöÄ **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**

1. **–î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞** - –Ω–∏—á–µ–≥–æ –º–µ–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ, –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
2. **–î–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤** - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è `preprocess-v2` –¥–ª—è –ª—É—á—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
3. **–î–ª—è –æ—Ç–ª–∞–¥–∫–∏** - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `preprocess-v2` —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–∞—Ö

**–í—ã–≤–æ–¥:** –ü—Ä–æ–±–ª–µ–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞. Wrapper –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ—Å—à–æ–≤–Ω—É—é —Ä–∞–±–æ—Ç—É —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞, –∞ –Ω–æ–≤—ã–π API –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ö–æ—á–µ—Ç –∏–º–∏ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.

```clojure
;; –°—Ç–∞—Ä—ã–π API (—Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ wrapper)
(preprocess code options) ‚Üí String

;; –ù–æ–≤—ã–π API (–¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
(preprocess-v2 code options) ‚Üí {:result String, :errors [], :success Boolean}
```

---

**User**

merge preprocessor_refactoring and main branch (newpreprocessor --> main)

---

**Cursor**

–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–ª–∏—Ç—å –≤–µ—Ç–∫—É `preprocessor_refactoring` –≤ `main`. –°–Ω–∞—á–∞–ª–∞ –¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ git –∏ –≤—ã–ø–æ–ª–Ω–∏–º —Å–ª–∏—è–Ω–∏–µ.

–û—Ç–ª–∏—á–Ω–æ! –ú—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –Ω–∞ –≤–µ—Ç–∫–µ `preprocessor_refactoring`. –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã, –∏ –≤—ã–ø–æ–ª–Ω–∏–º —Å–ª–∏—è–Ω–∏–µ —Å –≤–µ—Ç–∫–æ–π `main`.

–ü–æ—Ö–æ–∂–µ, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ commit –±—ã–ª–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º —Å—Ç–∞—Ç—É—Å –∏ –ø–æ–ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞:

–û—Ç–ª–∏—á–Ω–æ! –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É–∂–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã. –¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–∫–ª—é—á–∏–º—Å—è –Ω–∞ –≤–µ—Ç–∫—É `main` –∏ –≤—ã–ø–æ–ª–Ω–∏–º —Å–ª–∏—è–Ω–∏–µ:

–¢–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω–∏–º —Å–ª–∏—è–Ω–∏–µ –≤–µ—Ç–∫–∏ `preprocessor_refactoring` –≤ `main`:

–û—Ç–ª–∏—á–Ω–æ! –°–ª–∏—è–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ –∫–∞–∫ Fast-forward merge. –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤ –≤–µ—Ç–∫–µ main:

–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:

–î–∞–≤–∞–π—Ç–µ —Ç–∞–∫–∂–µ –∑–∞–ø—É—Å—Ç–∏–º –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç –¥–ª—è –ø–æ–ª–Ω–æ–π —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏:

–ü—Ä–æ–≤–µ—Ä–∏–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤–µ—Ç–∫—É `preprocessor_refactoring`, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞:

## üéâ –°–ª–∏—è–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!

–í–µ—Ç–∫–∞ `preprocessor_refactoring` –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ —Å–ª–∏—Ç–∞ –≤ `main`. –í–æ—Ç —á—Ç–æ –±—ã–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:

### ‚úÖ **–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:**

1. **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–µ—Ç–∫—É main** ‚úÖ
2. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ main –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏** ‚úÖ  
3. **–°–ª–∏—è–Ω–∏–µ preprocessor_refactoring ‚Üí main** ‚úÖ (Fast-forward merge)
4. **–û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —É–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π** ‚úÖ
5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏** ‚úÖ

### üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–ª–∏—è–Ω–∏—è:**

- **43 —Ñ–∞–π–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–æ**
- **2,448 –¥–æ–±–∞–≤–ª–µ–Ω–∏–π, 216 —É–¥–∞–ª–µ–Ω–∏–π**
- **–í—Å–µ —Ç–µ—Å—Ç—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω—ã (6/6 - 100%)**
- **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç**

### üîß **–ß—Ç–æ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ –≤ main:**

1. **–ù–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä v2** —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
2. **–ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** —Å–æ —Å—Ç–∞—Ä—ã–º API
3. **–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã** –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
4. **–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏** (`MIGRATION_GUIDE.md`)

### üéØ **–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:**

- ‚úÖ –ù–∞—Ö–æ–¥–∏–º—Å—è –Ω–∞ –≤–µ—Ç–∫–µ `main`
- ‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ `origin/main`
- ‚úÖ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —á–∏—Å—Ç–∞—è
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç

**–•–æ—Ç–∏—Ç–µ –ª–∏ –≤—ã —É–¥–∞–ª–∏—Ç—å –≤–µ—Ç–∫—É `preprocessor_refactoring` (–ª–æ–∫–∞–ª—å–Ω–æ –∏ —É–¥–∞–ª–µ–Ω–Ω–æ), –ø–æ—Å–∫–æ–ª—å–∫—É —Å–ª–∏—è–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ, –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –µ—ë –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏?**

---

**User**

–æ—Å—Ç–∞–≤–∏—Ç—å –≤–µ—Ç–∫—É –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏.

---

**Cursor**

–ü–æ–Ω—è—Ç–Ω–æ! –û—Å—Ç–∞–≤–ª—è–µ–º –≤–µ—Ç–∫—É `preprocessor_refactoring` –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏. –≠—Ç–æ —Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

–û—Ç–ª–∏—á–Ω–æ! –í–µ—Ç–∫–∞ `preprocessor_refactoring` —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏. –î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç–µ:

```markdown
# –û—Ç—á–µ—Ç –æ —Å–ª–∏—è–Ω–∏–∏: preprocessor_refactoring ‚Üí main

## üìÖ –î–∞—Ç–∞ —Å–ª–∏—è–Ω–∏—è
**–î–∞—Ç–∞:** $(date)  
**–ö–æ–º–º–∏—Ç:** d1d56df  
**–¢–∏–ø —Å–ª–∏—è–Ω–∏—è:** Fast-forward merge

## üéØ –¶–µ–ª—å —Å–ª–∏—è–Ω–∏—è
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ C51 v2 —Å –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é –≤ –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

## ‚úÖ –†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### üîß –û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä v2 –≤–æ–∑–≤—Ä–∞—â–∞–ª —Å—Ç—Ä—É–∫—Ç—É—Ä—É `{:result String, :errors [], :success Boolean}`, –∞ —Å—Ç–∞—Ä—ã–π API –æ–∂–∏–¥–∞–ª –ø—Ä–æ—Å—Ç–æ `String`. –≠—Ç–æ –Ω–∞—Ä—É—à–∞–ª–æ –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å.

**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π wrapper –≤ `preprocessor.clj`, –∫–æ—Ç–æ—Ä—ã–π:
- –í—ã–∑—ã–≤–∞–µ—Ç `preprocess-v2` –≤–Ω—É—Ç—Ä–∏
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
- –î–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ–± –æ—à–∏–±–∫–∞—Ö –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ **transducers** –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ **protocols** –¥–ª—è –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ **clojure.spec**
- ‚úÖ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –±–µ–∑ –º—É—Ç–∞–±–µ–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```
43 —Ñ–∞–π–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–æ
2,448 –¥–æ–±–∞–≤–ª–µ–Ω–∏–π (+)
216 —É–¥–∞–ª–µ–Ω–∏–π (-)
```

### üÜï –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã
- `src/c51cc/preprocessor_v2.clj` - –ù–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
- `test/c51cc/preprocessor_v2_test.clj` - –¢–µ—Å—Ç—ã –¥–ª—è v2
- `MIGRATION_GUIDE.md` - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏
- `docs/preprocessor-v2-architecture.md` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- –ú–Ω–æ–∂–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–π

### üîÑ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- `src/c51cc/preprocessor.clj` - –û–±–Ω–æ–≤–ª–µ–Ω wrapper –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

## üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç—ã —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏: **6/6 (100%)**
1. ‚úÖ –ü—Ä–æ—Å—Ç—ã–µ –º–∞–∫—Ä–æ—Å—ã
2. ‚úÖ –£—Å–ª–æ–≤–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è #ifdef
3. ‚úÖ –£—Å–ª–æ–≤–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è #ifndef  
4. ‚úÖ –í–ª–æ–∂–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
5. ‚úÖ –û—Ç–º–µ–Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–∞–∫—Ä–æ—Å–∞ (#undef)
6. ‚úÖ –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –º–∞–∫—Ä–æ—Å—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ API
```clojure
;; –°—Ç–∞—Ä—ã–π API (—á–µ—Ä–µ–∑ wrapper)
(preprocess code options) ‚Üí String ‚úÖ

;; –ù–æ–≤—ã–π API (–ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤)
(preprocess-v2 code options) ‚Üí {:result String, :errors [], :success Boolean} ‚úÖ

;; –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
(= (preprocess code) (:result (preprocess-v2 code))) ‚Üí true ‚úÖ
```

## üéâ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ—Å–ª–µ —Å–ª–∏—è–Ω–∏—è

### 1. üîÑ –ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –°—Ç–∞—Ä—ã–π –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- `preprocess()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç String –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- –ù–µ—Ç breaking changes

### 2. üÜï –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- –ö–æ–Ω—Ç—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –î–æ—Å—Ç—É–ø –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞

### 3. üöÄ –ì–∏–±–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
- –ú–æ–∂–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
- –ò–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π API
- –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –≤–æ–∑–º–æ–∂–µ–Ω

### 4. üîß –õ—É—á—à–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- Transducers –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- Protocols –¥–ª—è —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç–∏
- Spec –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –í—ã—Å–æ–∫–∞—è —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å

## üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
```clojure
;; –ù–∏—á–µ–≥–æ –º–µ–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
(require '[c51cc.preprocessor :as pp])
(def result (pp/preprocess code options)) ; ‚Üí String
```

### –î–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
```clojure
;; –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π API
(require '[c51cc.preprocessor-v2 :as pp2])
(let [result (pp2/preprocess-v2 code options)]
  (if (:success result)
    (process (:result result))
    (handle-errors (:errors result))))
```

### –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
```clojure
;; –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–æ–≤—ã–π API –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
(let [result (pp2/preprocess-v2 problematic-code options)]
  (println "–£—Å–ø–µ—Ö:" (:success result))
  (println "–û—à–∏–±–∫–∏:" (:errors result))
  (println "–†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result)))
```

## üîó –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –≤–µ—Ç–∫–∏

### –í–µ—Ç–∫–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
- ‚úÖ `preprocessor_refactoring` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ –∏ —É–¥–∞–ª–µ–Ω–Ω–æ
- ‚úÖ `main` - —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- ‚úÖ `parser_refactoring` - –¥—Ä—É–≥–∏–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∏
- ‚úÖ `interrup_parser` - –ø–∞—Ä—Å–µ—Ä –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–°–ª–∏—è–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ!** 

‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ **–†–ï–®–ï–ù–ê**  
‚úÖ –ù–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ main  
‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç  
‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞  
‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞  

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å —É –Ω–∞—Å –µ—Å—Ç—å –º–æ—â–Ω—ã–π, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä —Å –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é –∏ –æ—Ç–ª–∏—á–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π!

---

*–ê–≤—Ç–æ—Ä —Å–ª–∏—è–Ω–∏—è: AI Assistant*  
*–î–∞—Ç–∞: $(date)*  
*–°—Ç–∞—Ç—É—Å: ‚úÖ –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–û*
```

## üéâ –°–ª–∏—è–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!

### ‚úÖ **–ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:**

**–í–µ—Ç–∫–∞ `preprocessor_refactoring` —É—Å–ø–µ—à–Ω–æ —Å–ª–∏—Ç–∞ –≤ `main`**

- üîÑ **–¢–∏–ø —Å–ª–∏—è–Ω–∏—è:** Fast-forward merge
- üìä **–ò–∑–º–µ–Ω–µ–Ω–∏—è:** 43 —Ñ–∞–π–ª–∞, +2,448/-216 —Å—Ç—Ä–æ–∫
- üß™ **–¢–µ—Å—Ç—ã:** 6/6 (100%) –ø—Ä–æ–π–¥–µ–Ω—ã
- üîó **–í–µ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞** –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏

### üéØ **–ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**

1. **‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –†–ï–®–ï–ù–ê**
   - –°—Ç–∞—Ä—ã–π –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - Wrapper –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –Ω–æ–≤—ã–π API –≤ —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç

2. **‚úÖ –ù–æ–≤—ã–π –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω**
   - –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å transducers –∏ protocols
   - –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å

3. **‚úÖ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞**
   - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏
   - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
   - –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ç–µ—Å—Ç—ã

4. **‚úÖ –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞**
   - –í–µ—Ç–∫–∞ `preprocessor_refactoring` –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
   - –í—Å–µ –∫–æ–º–º–∏—Ç—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã

### üìã **–ß—Ç–æ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ –≤ main:**

```clojure
;; –°—Ç–∞—Ä—ã–π API - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
(require '[c51cc.preprocessor :as pp])
(pp/preprocess code options) ; ‚Üí String

;; –ù–æ–≤—ã–π API - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏  
(require '[c51cc.preprocessor-v2 :as pp2])
(pp2/preprocess-v2 code options) ; ‚Üí {:result String, :errors [], :success Boolean}
```

**–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ —Å –º–æ—â–Ω—ã–º, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º –∏ –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é!** üöÄ

```clojure
;; –°—Ç–∞—Ä—ã–π API - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
(require '[c51cc.preprocessor :as pp])
(pp/preprocess code options) ; ‚Üí String

;; –ù–æ–≤—ã–π API - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏  
(require '[c51cc.preprocessor-v2 :as pp2])
(pp2/preprocess-v2 code options) ; ‚Üí {:result String, :errors [], :success Boolean}
```

