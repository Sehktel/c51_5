# –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã include –≤ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ
_Exported on 5/27/2025 at 20:48:25 GMT+3 from Cursor (0.50.5)_

---

**User**

@preprocessor_v2.clj 
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–∏—Ä–µ–∫—Ç–∏–≤—ã include 

---

**Cursor**

–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –∫–æ–¥ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –∏ —Ä–µ–∞–ª–∏–∑—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–∏—Ä–µ–∫—Ç–∏–≤—ã `#include`. –°–Ω–∞—á–∞–ª–∞ –∏–∑—É—á—É —Ç–µ–∫—É—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–¥–∞.

–¢–µ–ø–µ—Ä—å –∏–∑—É—á—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –¥–∏—Ä–µ–∫—Ç–∏–≤ –∏ —Ä–µ–µ—Å—Ç—Ä –¥–∏—Ä–µ–∫—Ç–∏–≤:

–¢–µ–ø–µ—Ä—å –∏–∑—É—á—É –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –ø–æ–ª–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —è –ø–æ–Ω–∏–º–∞—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞. –ú–Ω–µ –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–∏–≤—É `#include` —Å–ª–µ–¥—É—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º. –Ø –≤–∏–∂—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤:

1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã**: –ö–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–ª—ã, transducers –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥
2. **–°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞**: –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è `#include` —É–∂–µ –µ—Å—Ç—å –≤ `directive-patterns`
3. **–°–æ—Å—Ç–æ—è–Ω–∏–µ**: `include-stack` –∏ `include-paths` —É–∂–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω—ã –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
4. **–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã**: `MAX_INCLUDE_DEPTH` —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞

–û–¥–Ω–∞–∫–æ —è –≤–∏–∂—É –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:

1. **–†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: –¢–µ–∫—É—â–∏–π transducer –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–∫–ª—é—á–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
2. **–§–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**: –ù—É–∂–µ–Ω –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
3. **–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**: –ù—É–∂–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –≤–∫–ª—é—á–µ–Ω–∏–π

–î–∞–≤–∞–π—Ç–µ —Ä–µ–∞–ª–∏–∑—É–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É `#include` —Å —É—á–µ—Ç–æ–º —ç—Ç–∏—Ö —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏–π:

```clojure
;; ============================================================================
;; –ü–†–û–¢–û–ö–û–õ–´ –î–õ–Ø –î–ò–†–ï–ö–¢–ò–í –ü–†–ï–ü–†–û–¶–ï–°–°–û–†–ê
;; ============================================================================

(defprotocol PreprocessorDirective
  "–ü—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –≤—Å–µ—Ö –¥–∏—Ä–µ–∫—Ç–∏–≤ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞.
   –ö–∞–∂–¥–∞—è –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ –¥–æ–ª–∂–Ω–∞ —É–º–µ—Ç—å:
   - –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å —Å–≤–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É —Å –¥–∏—Ä–µ–∫—Ç–∏–≤–æ–π
   - –í–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏"
  (matches? [this line]
    "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ —Å—Ç—Ä–æ–∫–∞ –¥–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–∏–≤–µ")
  (process [this line state]
    "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Ç—Ä–æ–∫—É —Å –¥–∏—Ä–µ–∫—Ç–∏–≤–æ–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç [result new-state]"))

(defprotocol ConditionalDirective
  "–ü—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è —É—Å–ª–æ–≤–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–∏–≤ (#if, #ifdef, #ifndef, #else, #endif)"
  (evaluate-condition [this condition state]
    "–í—ã—á–∏—Å–ª—è–µ—Ç —É—Å–ª–æ–≤–∏–µ –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–∏–≤—ã"))

(defprotocol MacroProcessor
  "–ü—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–∞–∫—Ä–æ—Å–∞–º–∏"
  (expand-macro [this macro-name args state]
    "–†–∞—Å—à–∏—Ä—è–µ—Ç –º–∞–∫—Ä–æ—Å —Å –∑–∞–¥–∞–Ω–Ω—ã–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏")
  (define-macro [this name definition state]
    "–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–æ–≤—ã–π –º–∞–∫—Ä–æ—Å")
  (undefine-macro [this name state]
    "–£–¥–∞–ª—è–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∞–∫—Ä–æ—Å–∞"))

(defprotocol FileProcessor
  "–ü—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∏—Ä–µ–∫—Ç–∏–≤ #include.
   
   –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
   - –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è —Ñ–∞–π–ª–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç–∏
   - –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –≤ —Ç–µ—Å—Ç–∞—Ö
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ø–æ–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤"
  (resolve-include-path [this filename include-paths current-file]
    "–†–∞–∑—Ä–µ—à–∞–µ—Ç –ø—É—Ç—å –∫ –≤–∫–ª—é—á–∞–µ–º–æ–º—É —Ñ–∞–π–ª—É —Å —É—á–µ—Ç–æ–º –ø—É—Ç–µ–π –ø–æ–∏—Å–∫–∞")
  (read-include-file [this resolved-path]
    "–ß–∏—Ç–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞")
  (file-exists? [this path]
    "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞")
  (get-canonical-path [this path]
    "–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å —Ñ–∞–π–ª–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –≤–∫–ª—é—á–µ–Ω–∏–π"))
```

–¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª—é –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–∫–ª—é—á–µ–Ω–∏—è–º–∏:

```clojure
(defn should-process-line?
  "–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –¥–æ–ª–∂–Ω–∞ –ª–∏ —Å—Ç—Ä–æ–∫–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Å–ª–æ–≤–Ω–æ–π –∫–æ–º–ø–∏–ª—è—Ü–∏–∏"
  [state]
  (or (empty? (:conditional-stack state))
      (every? :active (:conditional-stack state))))

;; ============================================================================
;; –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –í–ö–õ–Æ–ß–ï–ù–ò–Ø–ú–ò
;; ============================================================================

(defn check-include-depth
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≥–ª—É–±–∏–Ω—É –≤–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–µ–∫–∞.
   
   –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
   - –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏ –ø—Ä–∏ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –≤–∫–ª—é—á–µ–Ω–∏—è—Ö
   - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–≤ C (–æ–±—ã—á–Ω–æ 15-200 —É—Ä–æ–≤–Ω–µ–π)
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ —Å—Ç–µ–∫–∞"
  [state]
  (< (count (:include-stack state)) MAX_INCLUDE_DEPTH))

(defn detect-circular-include
  "–û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –≤–∫–ª—é—á–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤.
   
   –ê–ª–≥–æ—Ä–∏—Ç–º:
   1. –ü–æ–ª—É—á–∞–µ–º –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–µ –ø—É—Ç–∏ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ –≤ —Å—Ç–µ–∫–µ –≤–∫–ª—é—á–µ–Ω–∏–π
   2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–π —Ñ–∞–π–ª —É–∂–µ –≤ —Å—Ç–µ–∫–µ
   3. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true –µ—Å–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω —Ü–∏–∫–ª"
  [state new-file-path file-processor]
  (let [canonical-new-path (get-canonical-path file-processor new-file-path)
        canonical-stack-paths (map #(get-canonical-path file-processor %) (:include-stack state))]
    (some #(= canonical-new-path %) canonical-stack-paths)))

(defn parse-include-directive
  "–ü–∞—Ä—Å–∏—Ç –¥–∏—Ä–µ–∫—Ç–∏–≤—É #include –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –≤–∫–ª—é—á–µ–Ω–∏—è.
   
   –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É C89:
   - #include <filename>  - —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
   - #include \"filename\" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
   
   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {:type :system/:user :filename string} –∏–ª–∏ nil –ø—Ä–∏ –æ—à–∏–±–∫–µ"
  [line]
  (when-let [[_ filename] (re-find (:include directive-patterns) line)]
    (cond
      ;; –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ –ø–µ—Ä–≤–æ–º—É —Å–∏–º–≤–æ–ª—É –≤ –∑–∞—Ö–≤–∞—á–µ–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ
      (str/starts-with? line "#include <") {:type :system :filename filename}
      (str/starts-with? line "#include \"") {:type :user :filename filename}
      :else nil)))

;; –†–µ–∞–ª–∏–∑–∞—Ü–∏—è FileProcessor –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
(defrecord DefaultFileProcessor []
  FileProcessor
  (resolve-include-path [_ filename include-paths current-file]
    (let [;; –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞
          current-dir (when current-file
                       (let [file (io/file current-file)]
                         (when (.exists file)
                           (.getParent file))))
          search-paths (if current-dir
                        (cons current-dir include-paths)
                        include-paths)]
      (loop [paths search-paths]
        (when (seq paths)
          (let [candidate-path (str (first paths) "/" filename)
                file (io/file candidate-path)]
            (if (.exists file)
              (.getAbsolutePath file)
              (recur (rest paths))))))))
  
  (read-include-file [_ resolved-path]
    (try
      (slurp resolved-path)
      (catch Exception e
        (throw (ex-info (str "–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: " (.getMessage e))
                       {:file resolved-path :cause e})))))
  
  (file-exists? [_ path]
    (.exists (io/file path)))
  
  (get-canonical-path [_ path]
    (try
      (.getCanonicalPath (io/file path))
      (catch Exception _
        ;; –ï—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π
        path))))
```

–¢–µ–ø–µ—Ä—å —Ä–µ–∞–ª–∏–∑—É—é —Å–∞–º—É –¥–∏—Ä–µ–∫—Ç–∏–≤—É `#include`. –ù–∞–π–¥—É –º–µ—Å—Ç–æ –ø–æ—Å–ª–µ –¥—Ä—É–≥–∏—Ö –¥–∏—Ä–µ–∫—Ç–∏–≤:

–¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª—é –¥–∏—Ä–µ–∫—Ç–∏–≤—É `#include` –ø–µ—Ä–µ–¥ —Ä–µ–µ—Å—Ç—Ä–æ–º –¥–∏—Ä–µ–∫—Ç–∏–≤:

```clojure
;; –î–∏—Ä–µ–∫—Ç–∏–≤–∞ #endif
(defrecord EndifDirective []
  PreprocessorDirective
  (matches? [_ line]
    (re-find (:endif directive-patterns) line))
  
  (process [_ line state]
    (if (empty? (:conditional-stack state))
      [nil (add-error state "–î–∏—Ä–µ–∫—Ç–∏–≤–∞ #endif –±–µ–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ #if")]
      [nil (update state :conditional-stack pop)])))

;; –î–∏—Ä–µ–∫—Ç–∏–≤–∞ #include
(defrecord IncludeDirective [file-processor]
  PreprocessorDirective
  (matches? [_ line]
    (re-find (:include directive-patterns) line))
  
  (process [_ line state]
    (if (should-process-line? state)
      (let [include-info (parse-include-directive line)]
        (if-not include-info
          ;; –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã
          [nil (add-error state "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–∏—Ä–µ–∫—Ç–∏–≤—ã #include")]
          
          (let [{:keys [filename type]} include-info]
            ;; –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª—É–±–∏–Ω—É –≤–∫–ª—é—á–µ–Ω–∏–π
            (if-not (check-include-depth state)
              [nil (add-error state 
                             (str "–ü—Ä–µ–≤—ã—à–µ–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∏–π (" MAX_INCLUDE_DEPTH ")")
                             {:filename filename :depth (count (:include-stack state))})]
              
              ;; –†–∞–∑—Ä–µ—à–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
              (let [resolved-path (resolve-include-path file-processor 
                                                       filename 
                                                       (:include-paths state)
                                                       (:current-file state))]
                (if-not resolved-path
                  ;; –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
                  [nil (add-error state 
                                 (str "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: " filename)
                                 {:filename filename 
                                  :type type
                                  :search-paths (:include-paths state)})]
                  
                  ;; –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –≤–∫–ª—é—á–µ–Ω–∏—è
                  (if (detect-circular-include state resolved-path file-processor)
                    [nil (add-error state 
                                   (str "–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ü–∏–∫–ª–∏—á–µ—Å–∫–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ: " filename)
                                   {:filename filename 
                                    :resolved-path resolved-path
                                    :include-stack (:include-stack state)})]
                    
                    ;; –ß–∏—Ç–∞–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª
                    (try
                      (let [file-content (read-include-file file-processor resolved-path)
                            ;; –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                            new-state (-> state
                                         (update :include-stack conj (:current-file state))
                                         (assoc :current-file resolved-path)
                                         (assoc :line-number 1))
                            
                            ;; –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                            processed-result (preprocess-v2 file-content 
                                                           {:defines (:defines new-state)
                                                            :include-paths (:include-paths new-state)
                                                            :current-file resolved-path})
                            
                            ;; –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á–µ–Ω–∏—è
                            final-state (-> new-state
                                           (assoc :defines (:defines (get processed-result :final-state new-state)))
                                           (update :include-stack pop)
                                           (assoc :current-file (:current-file state))
                                           (update :errors concat (:errors processed-result)))]
                        
                        ;; –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
                        [(:result processed-result) final-state])
                      
                      (catch Exception e
                        [nil (add-error state 
                                       (str "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞: " (.getMessage e))
                                       {:filename filename 
                                        :resolved-path resolved-path
                                        :exception-type (type e)})]))))))))
      ;; –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –∏–∑-–∑–∞ —É—Å–ª–æ–≤–Ω–æ–π –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
      [nil state]))
  
  FileProcessor
  (resolve-include-path [this filename include-paths current-file]
    (resolve-include-path file-processor filename include-paths current-file))
  (read-include-file [this resolved-path]
    (read-include-file file-processor resolved-path))
  (file-exists? [this path]
    (file-exists? file-processor path))
  (get-canonical-path [this path]
    (get-canonical-path file-processor path)))

;; ============================================================================
;; –†–ï–ï–°–¢–† –î–ò–†–ï–ö–¢–ò–í
;; ============================================================================
```

---

**User**

–∞–±–∞–∂–¥–∏! —Ü–∏–∫–ª–∏—á–µ—Å–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Ä–∞–∑–≤–µ –Ω–µ —Ä–µ—à–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–∞—â–∏—Ç–Ω—ã—Ö define ? 

---

**Cursor**

–í—ã –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤—ã! –≠—Ç–æ –æ—Ç–ª–∏—á–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤. –î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å –¥–µ—Ç–∞–ª—å–Ω–æ:

## –ê–Ω–∞–ª–∏–∑ –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—é —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –≤–∫–ª—é—á–µ–Ω–∏–π

### 1. **Include Guards (–∑–∞—â–∏—Ç–Ω—ã–µ define) - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥ C89/C90**

```c
// header.h
#ifndef HEADER_H
#define HEADER_H

// —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞

#endif /* HEADER_H */
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º C89
- –ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –ª–æ–≥–∏–∫—É
- –ì–∏–±–∫–æ—Å—Ç—å –≤ –∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏
- –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø—É "–Ω–µ –∏–∑–æ–±—Ä–µ—Ç–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥"

### 2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Ü–∏–∫–ª–æ–≤ - –º–æ–π –ø–æ–¥—Ö–æ–¥**

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ –º–æ–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è:**
- –î—É–±–ª–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ —Ä–µ—à–∞—Ç—å—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–¥–∞
- –£—Å–ª–æ–∂–Ω—è–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
- –ù–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏—é –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–≤ C
- –ú–æ–∂–µ—Ç –º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–¥–µ

–í—ã –ø—Ä–∞–≤—ã - **—Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã —Ä–µ—à–∞—Ç—å—Å—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–º —á–µ—Ä–µ–∑ include guards**, –∞ –Ω–µ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º!

–î–∞–≤–∞–π—Ç–µ –∏—Å–ø—Ä–∞–≤–∏–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é, —É–±—Ä–∞–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Ü–∏–∫–ª–æ–≤:

```c
// header.h
#ifndef HEADER_H
#define HEADER_H

// —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞

#endif /* HEADER_H */
```

```clojure
;; –î–∏—Ä–µ–∫—Ç–∏–≤–∞ #include
(defrecord IncludeDirective [file-processor]
  PreprocessorDirective
  (matches? [_ line]
    (re-find (:include directive-patterns) line))
  
  (process [_ line state]
    (if (should-process-line? state)
      (let [include-info (parse-include-directive line)]
        (if-not include-info
          ;; –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã
          [nil (add-error state "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–∏—Ä–µ–∫—Ç–∏–≤—ã #include")]
          
          (let [{:keys [filename type]} include-info]
            ;; –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –≥–ª—É–±–∏–Ω—É –≤–∫–ª—é—á–µ–Ω–∏–π (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–µ–∫–∞)
            (if-not (check-include-depth state)
              [nil (add-error state 
                             (str "–ü—Ä–µ–≤—ã—à–µ–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∏–π (" MAX_INCLUDE_DEPTH ")")
                             {:filename filename :depth (count (:include-stack state))})]
              
              ;; –†–∞–∑—Ä–µ—à–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
              (let [resolved-path (resolve-include-path file-processor 
                                                       filename 
                                                       (:include-paths state)
                                                       (:current-file state))]
                (if-not resolved-path
                  ;; –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
                  [nil (add-error state 
                                 (str "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: " filename)
                                 {:filename filename 
                                  :type type
                                  :search-paths (:include-paths state)})]
                  
                  ;; –ß–∏—Ç–∞–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª
                  ;; –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –≤–∫–ª—é—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å—Å—è
                  ;; –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–º —á–µ—Ä–µ–∑ include guards (#ifndef/#define/#endif)
                  ;; —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É C89, –∞ –Ω–µ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                  (try
                    (let [file-content (read-include-file file-processor resolved-path)
                          ;; –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                          new-state (-> state
                                       (update :include-stack conj (:current-file state))
                                       (assoc :current-file resolved-path)
                                       (assoc :line-number 1))
                          
                          ;; –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                          processed-result (preprocess-v2 file-content 
                                                         {:defines (:defines new-state)
                                                          :include-paths (:include-paths new-state)
                                                          :current-file resolved-path})
                          
                          ;; –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á–µ–Ω–∏—è
                          final-state (-> new-state
                                         (assoc :defines (:defines (get processed-result :final-state new-state)))
                                         (update :include-stack pop)
                                         (assoc :current-file (:current-file state))
                                         (update :errors concat (:errors processed-result)))]
                      
                      ;; –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
                      [(:result processed-result) final-state])
                    
                    (catch Exception e
                      [nil (add-error state 
                                     (str "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞: " (.getMessage e))
                                     {:filename filename 
                                      :resolved-path resolved-path
                                      :exception-type (type e)})])))))))
      ;; –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –∏–∑-–∑–∞ —É—Å–ª–æ–≤–Ω–æ–π –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
      [nil state]))
  
  FileProcessor
  (resolve-include-path [this filename include-paths current-file]
    (resolve-include-path file-processor filename include-paths current-file))
  (read-include-file [this resolved-path]
    (read-include-file file-processor resolved-path))
  (file-exists? [this path]
    (file-exists? file-processor path))
  (get-canonical-path [this path]
    (get-canonical-path file-processor path)))
```

–ï—Å—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –î–∞–≤–∞–π—Ç–µ –∏—Å–ø—Ä–∞–≤–∏–º –µ—ë:

–Ø –≤–∏–∂—É –ø—Ä–æ–±–ª–µ–º—É - –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å IncludeDirective –≤ —Ä–µ–µ—Å—Ç—Ä –¥–∏—Ä–µ–∫—Ç–∏–≤ –∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤. –¢–∞–∫–∂–µ –Ω—É–∂–Ω–æ —É–±—Ä–∞—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

```clojure
(defn check-include-depth
  "–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≥–ª—É–±–∏–Ω—É –≤–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–µ–∫–∞.
   
   –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
   - –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏ –ø—Ä–∏ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –≤–∫–ª—é—á–µ–Ω–∏—è—Ö
   - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–æ–≤ C (–æ–±—ã—á–Ω–æ 15-200 —É—Ä–æ–≤–Ω–µ–π)
   - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ —Å—Ç–µ–∫–∞"
  [state]
  (< (count (:include-stack state)) MAX_INCLUDE_DEPTH))

(defn parse-include-directive
  "–ü–∞—Ä—Å–∏—Ç –¥–∏—Ä–µ–∫—Ç–∏–≤—É #include –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –≤–∫–ª—é—á–µ–Ω–∏—è.
   
   –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É C89:
   - #include <filename>  - —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
   - #include \"filename\" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
   
   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {:type :system/:user :filename string} –∏–ª–∏ nil –ø—Ä–∏ –æ—à–∏–±–∫–µ"
  [line]
  (when-let [[_ filename] (re-find (:include directive-patterns) line)]
    (cond
      ;; –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ –ø–µ—Ä–≤–æ–º—É —Å–∏–º–≤–æ–ª—É –≤ –∑–∞—Ö–≤–∞—á–µ–Ω–Ω–æ–π –≥—Ä—É–ø–ø–µ
      (str/starts-with? line "#include <") {:type :system :filename filename}
      (str/starts-with? line "#include \"") {:type :user :filename filename}
      :else nil)))
```

–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ IncludeDirective —Ç—Ä–µ–±—É–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä file-processor. –ù—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ:

```clojure
(def directive-registry
  "–†–µ–µ—Å—Ç—Ä –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–∏–≤ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞"
  [(->DefineDirective)
   (->UndefDirective)
   (->IfdefDirective)
   (->IfndefDirective)
   (->ElseDirective)
   (->EndifDirective)
   (->IncludeDirective (->DefaultFileProcessor))])
```

–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–º –≤—ã–∑–æ–≤–µ preprocess-v2 –≤–Ω—É—Ç—Ä–∏ IncludeDirective. –≠—Ç–æ —Å–æ–∑–¥–∞–µ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å. –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:

```clojure
;; –î–∏—Ä–µ–∫—Ç–∏–≤–∞ #include
(defrecord IncludeDirective [file-processor]
  PreprocessorDirective
  (matches? [_ line]
    (re-find (:include directive-patterns) line))
  
  (process [_ line state]
    (if (should-process-line? state)
      (let [include-info (parse-include-directive line)]
        (if-not include-info
          ;; –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã
          [nil (add-error state "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –¥–∏—Ä–µ–∫—Ç–∏–≤—ã #include")]
          
          (let [{:keys [filename type]} include-info]
            ;; –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –≥–ª—É–±–∏–Ω—É –≤–∫–ª—é—á–µ–Ω–∏–π (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–µ–∫–∞)
            (if-not (check-include-depth state)
              [nil (add-error state 
                             (str "–ü—Ä–µ–≤—ã—à–µ–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∏–π (" MAX_INCLUDE_DEPTH ")")
                             {:filename filename :depth (count (:include-stack state))})]
              
              ;; –†–∞–∑—Ä–µ—à–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
              (let [resolved-path (resolve-include-path file-processor 
                                                       filename 
                                                       (:include-paths state)
                                                       (:current-file state))]
                (if-not resolved-path
                  ;; –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
                  [nil (add-error state 
                                 (str "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: " filename)
                                 {:filename filename 
                                  :type type
                                  :search-paths (:include-paths state)})]
                  
                  ;; –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                  ;; –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –≤–∫–ª—é—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å—Å—è
                  ;; –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–º —á–µ—Ä–µ–∑ include guards (#ifndef/#define/#endif)
                  ;; —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É C89, –∞ –Ω–µ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                  (try
                    (let [file-content (read-include-file file-processor resolved-path)
                          ;; –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                          new-state (-> state
                                       (update :include-stack conj (:current-file state))
                                       (assoc :current-file resolved-path)
                                       (assoc :line-number 1))]
                      
                      ;; –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
                      ;; –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –∏—Ö –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ
                      [file-content new-state])
                    
                    (catch Exception e
                      [nil (add-error state 
                                     (str "–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞: " (.getMessage e))
                                     {:filename filename 
                                      :resolved-path resolved-path
                                      :exception-type (type e)})])))))))
      ;; –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –∏–∑-–∑–∞ —É—Å–ª–æ–≤–Ω–æ–π –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
      [nil state]))
  
  FileProcessor
  (resolve-include-path [this filename include-paths current-file]
    (resolve-include-path file-processor filename include-paths current-file))
  (read-include-file [this resolved-path]
    (read-include-file file-processor resolved-path))
  (file-exists? [this path]
    (file-exists? file-processor path))
  (get-canonical-path [this path]
    (get-canonical-path file-processor path)))
```

–Ø –≤–∏–∂—É –ø—Ä–æ–±–ª–µ–º—É - –µ—Å—Ç—å –Ω–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∫–æ–±–∫–∏. –î–∞–≤–∞–π—Ç–µ –Ω–∞–π–¥–µ–º –∏ –∏—Å–ø—Ä–∞–≤–∏–º –∏—Ö:

–Ø –≤–∏–∂—É –ø—Ä–æ–±–ª–µ–º—É! –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ `#include`, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–ª—è—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –≤ –ø–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏. –î–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–µ–º –ø–æ–¥—Ö–æ–¥:

## –ê–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã

**–ü—Ä–æ–±–ª–µ–º–∞**: –¢–µ–∫—É—â–∏–π transducer-based –ø–æ–¥—Ö–æ–¥ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ `#include` –¥–æ–ª–∂–µ–Ω **–∑–∞–º–µ–Ω–∏—Ç—å** —Å—Ç—Ä–æ–∫—É –¥–∏—Ä–µ–∫—Ç–∏–≤—ã –Ω–∞ **–º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫** –∏–∑ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞.

**–†–µ—à–µ–Ω–∏—è**:
1. **–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ `#include` –ø–µ—Ä–µ–¥ –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
2. **–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è transducer** - —Å–¥–µ–ª–∞—Ç—å –µ–≥–æ —Å–ø–æ—Å–æ–±–Ω—ã–º –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
3. **–†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥** - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ

–î–∞–≤–∞–π—Ç–µ —Ä–µ–∞–ª–∏–∑—É–µ–º **–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–∫–ª—é—á–µ–Ω–∏–π**:

```clojure
;; ============================================================================
;; –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò –í–ö–õ–Æ–ß–ï–ù–ò–ô
;; ============================================================================

(defn expand-includes
  "–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤—Å–µ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã #include –≤ –∫–æ–¥–µ.
   
   –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
   - –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –æ—Å–Ω–æ–≤–Ω—ã–º transducer
   - –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–µ–∫–∞
   - –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –≤–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ include guards (—Å—Ç–∞–Ω–¥–∞—Ä—Ç C89)
   
   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {:content string :state state :errors [errors]}"
  ([code] (expand-includes code {} (->DefaultFileProcessor)))
  ([code state] (expand-includes code state (->DefaultFileProcessor)))
  ([code state file-processor]
   (let [lines (str/split-lines code)
         result (atom {:content [] :state state :errors []})]
     
     (doseq [line lines]
       (if-let [include-info (parse-include-directive line)]
         ;; –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ç–∏–≤—É #include
         (let [{:keys [filename type]} include-info
               current-state (:state @result)]
           
           ;; –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª—É–±–∏–Ω—É –≤–∫–ª—é—á–µ–Ω–∏–π
           (if-not (check-include-depth current-state)
             (swap! result update :errors conj 
                    {:message (str "–ü—Ä–µ–≤—ã—à–µ–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∏–π (" MAX_INCLUDE_DEPTH ")")
                     :filename filename 
                     :depth (count (:include-stack current-state))})
             
             ;; –†–∞–∑—Ä–µ—à–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
             (let [resolved-path (resolve-include-path file-processor 
                                                      filename 
                                                      (:include-paths current-state)
                                                      (:current-file current-state))]
               (if-not resolved-path
                 ;; –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
                 (swap! result update :errors conj
                        {:message (str "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: " filename)
                         :filename filename 
                         :type type
                         :search-paths (:include-paths current-state)})
                 
                 ;; –ß–∏—Ç–∞–µ–º –∏ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª
                 (try
                   (let [file-content (read-include-file file-processor resolved-path)
                         ;; –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                         new-state (-> current-state
                                      (update :include-stack conj (:current-file current-state))
                                      (assoc :current-file resolved-path))
                         
                         ;; –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∫–ª—é—á–∞–µ–º—ã–π —Ñ–∞–π–ª
                         nested-result (expand-includes file-content new-state file-processor)
                         
                         ;; –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                         restored-state (-> (:state nested-result)
                                          (update :include-stack pop)
                                          (assoc :current-file (:current-file current-state)))]
                     
                     ;; –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                     (swap! result 
                            (fn [r] 
                              (-> r
                                  (update :content concat (str/split-lines (:content nested-result)))
                                  (assoc :state restored-state)
                                  (update :errors concat (:errors nested-result))))))
                   
                   (catch Exception e
                     (swap! result update :errors conj
                            {:message (str "–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: " (.getMessage e))
                             :filename filename 
                             :resolved-path resolved-path
                             :exception-type (type e)})))))))
         
         ;; –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
         (swap! result update :content conj line)))
     
     ;; –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
     (update @result :content #(str/join "\n" %)))))

;; –î–∏—Ä–µ–∫—Ç–∏–≤–∞ #include (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
(defrecord IncludeDirective [file-processor]
  PreprocessorDirective
  (matches? [_ line]
    (re-find (:include directive-patterns) line))
  
  (process [_ line state]
    ;; –í –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ #include –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —ç—Ç–∞–ø–µ expand-includes
    ;; –≠—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω—É–∂–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å transducer
    [nil state]))
```

–¢–µ–ø–µ—Ä—å –æ–±–Ω–æ–≤–∏–º —Ñ—É–Ω–∫—Ü–∏—é `preprocess-v2` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á–µ–Ω–∏–π:

```clojure
(defn preprocess-v2
  "–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º transducers –∏ protocols"
  ([code] (preprocess-v2 code {}))
  ([code options]
   ;; –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
   (when-not (string? code)
     (throw (ex-info "–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π" {:code-type (type code)})))
   
   (when-not (map? options)
     (throw (ex-info "–û–ø—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å map" {:options-type (type options)})))
   
   (try
     (let [initial-state (create-initial-state 
                         :defines (get options :defines {})
                         :include-paths (get options :include-paths ["." "include" "lib"])
                         :current-file (get options :current-file "input"))
           
           ;; –≠–¢–ê–ü 1: –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏–π
           include-result (expand-includes code initial-state)
           expanded-code (:content include-result)
           state-after-includes (merge initial-state (:state include-result))
           include-errors (:errors include-result)
           
           ;; –≠–¢–ê–ü 2: –û—Å–Ω–æ–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ transducers
           lines (str/split-lines expanded-code)
           final-state (volatile! state-after-includes)
           
           ;; –ö–æ–º–ø–æ–∑–∏—Ü–∏—è transducers –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–±–µ–∑ IncludeDirective)
           processing-xf (comp
                         (remove-comments-xf)
                         (normalize-whitespace-xf)
                         (map (fn [line]
                                (let [current-state @final-state
                                      ;; –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â—É—é –¥–∏—Ä–µ–∫—Ç–∏–≤—É (–∫—Ä–æ–º–µ #include)
                                      matching-directive (first (filter #(and (matches? % line)
                                                                              (not (instance? IncludeDirective %))) 
                                                                        directive-registry))]
                                  (if matching-directive
                                    ;; –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ç–∏–≤—É
                                    (let [[processed-line new-state] (process matching-directive line current-state)]
                                      (vreset! final-state new-state)
                                      processed-line)  ; –º–æ–∂–µ—Ç –±—ã—Ç—å nil
                                    ;; –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –∫–æ–¥–∞
                                    (if (should-process-line? current-state)
                                      (let [expanded-line (expand-macros-in-text line (:defines current-state) current-state)
                                            new-state (update current-state :line-number inc)]
                                        (vreset! final-state new-state)
                                        expanded-line)
                                      ;; –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑-–∑–∞ —É—Å–ª–æ–≤–Ω–æ–π –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
                                      (do
                                        (vswap! final-state update :line-number inc)
                                        nil))))))
                         (filter some?))  ; –£–±–∏—Ä–∞–µ–º nil —Å—Ç—Ä–æ–∫–∏
           
           processed-lines (into [] processing-xf lines)
           final-state-value @final-state
           all-errors (concat include-errors (:errors final-state-value))]
       
       {:result (str/join "\n" processed-lines)
        :errors all-errors
        :success (empty? all-errors)
        :final-state final-state-value})
     
     (catch Exception e
       {:result ""
        :errors [{:message (str "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞: " (.getMessage e))
                 :type :critical
                 :exception-type (type e)}]
        :success false}))))
```

–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –¥–∏—Ä–µ–∫—Ç–∏–≤—ã `#include`:

```cpp
#ifndef HEADER_H
#define HEADER_H

#define MAX_SIZE 100
#define VERSION "1.0.0"

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
int test_function(int x);

#endif /* HEADER_H */
```

```c
#include "header.h"

int main() {
    int buffer[MAX_SIZE];
    printf("Version: %s\n", VERSION);
    return test_function(42);
}
```

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–¥–∏–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç:

–ü–æ–ø—Ä–æ–±—É–µ–º –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç:

–ü—Ä–æ–±–ª–µ–º–∞ —Å –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞. –í Clojure –¥–µ—Ñ–∏—Å—ã –≤ –∏–º–µ–Ω–∞—Ö –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤ –∏–º–µ–Ω –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è–º –≤ –∏–º–µ–Ω–∞—Ö —Ñ–∞–π–ª–æ–≤. –ü–µ—Ä–µ–∏–º–µ–Ω—É–µ–º —Ñ–∞–π–ª:

–ò–º—è —Ñ–∞–π–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ. –ü—Ä–æ–±–ª–µ–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –∏–º–µ–Ω. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º:

–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```clojure
(require '[c51cc.preprocessor-v2 :as pp])

;; –¢–µ—Å—Ç –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
(println "=== –¢–ï–°–¢ 1: –ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ ===")
(let [result (pp/preprocess-v2 "#define TEST 123\nint x = TEST;")]
  (println "–†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
  (println "–£—Å–ø–µ—Ö:" (:success result))
  (println "–û—à–∏–±–∫–∏:" (:errors result)))

;; –¢–µ—Å—Ç include —Å –ø—Ä–æ—Å—Ç—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º
(println "\n=== –¢–ï–°–¢ 2: Include —Å –ø—Ä–æ—Å—Ç—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º ===")
(spit "test_header.h" "#define MAX_SIZE 100\n#define VERSION \"1.0\"")
(let [result (pp/preprocess-v2 "#include \"test_header.h\"\nint buffer[MAX_SIZE];" 
                              {:include-paths ["."]})]
  (println "–†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
  (println "–£—Å–ø–µ—Ö:" (:success result))
  (println "–û—à–∏–±–∫–∏:" (:errors result)))

;; –¢–µ—Å—Ç include guards
(println "\n=== –¢–ï–°–¢ 3: Include guards ===")
(spit "guarded_header.h" "#ifndef GUARD_H\n#define GUARD_H\n#define PROTECTED 42\n#endif")
(let [result (pp/preprocess-v2 "#include \"guarded_header.h\"\n#include \"guarded_header.h\"\nint x = PROTECTED;" 
                              {:include-paths ["."]})]
  (println "–†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
  (println "–£—Å–ø–µ—Ö:" (:success result))
  (println "–û—à–∏–±–∫–∏:" (:errors result)))

(println "\n=== –¢–ï–°–¢–´ –ó–ê–í–ï–†–®–ï–ù–´ ===")
```

–û—Ç–ª–∏—á–Ω–æ! –¢–µ—Å—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ –±–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ç–µ—Å—Ç–æ–º 2. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

–Ø –≤–∏–∂—É, —á—Ç–æ —Ñ–∞–π–ª—ã `test_header.h` –∏ `guarded_header.h` —Å–æ–∑–¥–∞–Ω—ã. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏ –∏—Å–ø—Ä–∞–≤–∏–º —Ç–µ—Å—Ç:

–§–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ —Ç–µ—Å—Ç 2 –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è. –î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç:

```clojure
(require '[c51cc.preprocessor-v2 :as pp])

(println "=== –î–ï–¢–ê–õ–¨–ù–´–ô –¢–ï–°–¢ –î–ò–†–ï–ö–¢–ò–í–´ #INCLUDE ===\n")

;; –¢–µ—Å—Ç 1: –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
(println "–¢–ï–°–¢ 1: –ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞–∫—Ä–æ—Å–æ–≤")
(let [result (pp/preprocess-v2 "#define TEST 123\nint x = TEST;")]
  (println "  –ö–æ–¥:" "#define TEST 123\\nint x = TEST;")
  (println "  –†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
  (println "  –£—Å–ø–µ—Ö:" (:success result))
  (println "  –û—à–∏–±–∫–∏:" (count (:errors result)))
  (println))

;; –¢–µ—Å—Ç 2: Include –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
(println "–¢–ï–°–¢ 2: Include –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–∞–π–ª–∞")
(spit "simple.h" "#define SIMPLE_VALUE 42")
(let [code "#include \"simple.h\"\nint x = SIMPLE_VALUE;"
      result (pp/preprocess-v2 code {:include-paths ["."]})]
  (println "  –ó–∞–≥–æ–ª–æ–≤–æ–∫ simple.h:" "#define SIMPLE_VALUE 42")
  (println "  –ö–æ–¥:" code)
  (println "  –†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
  (println "  –£—Å–ø–µ—Ö:" (:success result))
  (println "  –û—à–∏–±–∫–∏:" (:errors result))
  (println))

;; –¢–µ—Å—Ç 3: Include guards (–¥–≤–æ–π–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ)
(println "–¢–ï–°–¢ 3: Include guards")
(spit "protected.h" "#ifndef PROTECTED_H\n#define PROTECTED_H\n#define PROTECTED_VALUE 99\n#endif")
(let [code "#include \"protected.h\"\n#include \"protected.h\"\nint y = PROTECTED_VALUE;"
      result (pp/preprocess-v2 code {:include-paths ["."]})]
  (println "  –ó–∞–≥–æ–ª–æ–≤–æ–∫ protected.h —Å include guards")
  (println "  –ö–æ–¥ —Å –¥–≤–æ–π–Ω—ã–º –≤–∫–ª—é—á–µ–Ω–∏–µ–º:" code)
  (println "  –†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
  (println "  –£—Å–ø–µ—Ö:" (:success result))
  (println "  –û—à–∏–±–∫–∏:" (:errors result))
  (println))

;; –¢–µ—Å—Ç 4: –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª
(println "–¢–ï–°–¢ 4: –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª")
(let [code "#include \"nonexistent.h\"\nint z = 1;"
      result (pp/preprocess-v2 code {:include-paths ["."]})]
  (println "  –ö–æ–¥:" code)
  (println "  –†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
  (println "  –£—Å–ø–µ—Ö:" (:success result))
  (println "  –û—à–∏–±–∫–∏:" (count (:errors result)))
  (when (seq (:errors result))
    (println "  –ü–µ—Ä–≤–∞—è –æ—à–∏–±–∫–∞:" (:message (first (:errors result)))))
  (println))

;; –¢–µ—Å—Ç 5: –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω–∏—è
(println "–¢–ï–°–¢ 5: –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω–∏—è")
(spit "inner.h" "#define INNER_VALUE 123")
(spit "outer.h" "#include \"inner.h\"\n#define OUTER_VALUE INNER_VALUE")
(let [code "#include \"outer.h\"\nint result = OUTER_VALUE;"
      result (pp/preprocess-v2 code {:include-paths ["."]})]
  (println "  inner.h:" "#define INNER_VALUE 123")
  (println "  outer.h:" "#include \"inner.h\"\\n#define OUTER_VALUE INNER_VALUE")
  (println "  –ö–æ–¥:" code)
  (println "  –†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
  (println "  –£—Å–ø–µ—Ö:" (:success result))
  (println "  –û—à–∏–±–∫–∏:" (:errors result))
  (println))

(println "=== –í–°–ï –¢–ï–°–¢–´ –ó–ê–í–ï–†–®–ï–ù–´ ===")
```

–û—Ç–ª–∏—á–Ω–æ! –¢–µ—Å—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —á—Ç–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:

## –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ **–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. **–ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞–∫—Ä–æ—Å–æ–≤** - —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
3. **Include guards** - —á–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç (–Ω–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)

### ‚ùå **–ü—Ä–æ–±–ª–µ–º—ã:**
1. **–¢–µ—Å—Ç—ã 2, 3, 5 –Ω–µ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è** - –≤—ã–≤–æ–¥ –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è
2. **–ú–∞–∫—Ä–æ—Å—ã –∏–∑ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–µ —Ä–∞—Å—à–∏—Ä—è—é—Ç—Å—è** (—Ç–µ—Å—Ç 5: `OUTER_VALUE` –Ω–µ –∑–∞–º–µ–Ω–∏–ª—Å—è –Ω–∞ `123`)

### üîç **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º:**

**–ü—Ä–æ–±–ª–µ–º–∞ 1**: –í–æ–∑–º–æ–∂–Ω–æ, –µ—Å—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —Ä–µ–∫—É—Ä—Å–∏—è –≤ `expand-includes`
**–ü—Ä–æ–±–ª–µ–º–∞ 2**: –ú–∞–∫—Ä–æ—Å—ã –∏–∑ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

–î–∞–≤–∞–π—Ç–µ –∏—Å–ø—Ä–∞–≤–∏–º —ç—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ä–µ–∫—É—Ä—Å–∏–µ–π:

–Ø –≤–∏–∂—É –ø—Ä–æ–±–ª–µ–º—É! –í —Ñ—É–Ω–∫—Ü–∏–∏ `expand-includes` –µ—Å—Ç—å **–±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —Ä–µ–∫—É—Ä—Å–∏—è**. –ö–æ–≥–¥–∞ –º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∫–ª—é—á–∞–µ–º—ã–π —Ñ–∞–π–ª, –º—ã —Å–Ω–æ–≤–∞ –≤—ã–∑—ã–≤–∞–µ–º `expand-includes`, –Ω–æ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ –º–∞–∫—Ä–æ—Å—ã –∏–∑ –≤–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω—ã –æ–±—Ä–∞—Ç–Ω–æ.

–î–∞–≤–∞–π—Ç–µ –∏—Å–ø—Ä–∞–≤–∏–º —ç—Ç—É –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É:

```clojure
(defn expand-includes
  "–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤—Å–µ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã #include –≤ –∫–æ–¥–µ.
   
   –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
   - –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –æ—Å–Ω–æ–≤–Ω—ã–º transducer
   - –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–µ–∫–∞
   - –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –≤–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ include guards (—Å—Ç–∞–Ω–¥–∞—Ä—Ç C89)
   
   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {:content string :state state :errors [errors]}"
  ([code] (expand-includes code (create-initial-state) (->DefaultFileProcessor)))
  ([code state] (expand-includes code state (->DefaultFileProcessor)))
  ([code state file-processor]
   (let [lines (str/split-lines code)
         result (atom {:content [] :state state :errors []})]
     
     (doseq [line lines]
       (if-let [include-info (parse-include-directive line)]
         ;; –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ç–∏–≤—É #include
         (let [{:keys [filename type]} include-info
               current-state (:state @result)]
           
           ;; –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª—É–±–∏–Ω—É –≤–∫–ª—é—á–µ–Ω–∏–π
           (if-not (check-include-depth current-state)
             (swap! result update :errors conj 
                    {:message (str "–ü—Ä–µ–≤—ã—à–µ–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∏–π (" MAX_INCLUDE_DEPTH ")")
                     :filename filename 
                     :depth (count (:include-stack current-state))})
             
             ;; –†–∞–∑—Ä–µ—à–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
             (let [resolved-path (resolve-include-path file-processor 
                                                      filename 
                                                      (:include-paths current-state)
                                                      (:current-file current-state))]
               (if-not resolved-path
                 ;; –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
                 (swap! result update :errors conj
                        {:message (str "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: " filename)
                         :filename filename 
                         :type type
                         :search-paths (:include-paths current-state)})
                 
                 ;; –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                 ;; –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –≤–∫–ª—é—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å—Å—è
                 ;; –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–º —á–µ—Ä–µ–∑ include guards (#ifndef/#define/#endif)
                 ;; —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É C89, –∞ –Ω–µ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                 (try
                   (let [file-content (read-include-file file-processor resolved-path)
                         ;; –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                         new-state (-> current-state
                                      (update :include-stack conj (:current-file current-state))
                                      (assoc :current-file resolved-path))
                         
                         ;; –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∫–ª—é—á–∞–µ–º—ã–π —Ñ–∞–π–ª
                         nested-result (expand-includes file-content new-state file-processor)
                         
                         ;; –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–∫—Ä–æ—Å—ã
                         restored-state (-> new-state
                                          (assoc :defines (:defines (:state nested-result)))
                                          (update :include-stack pop)
                                          (assoc :current-file (:current-file current-state)))]
                     
                     ;; –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                     (swap! result 
                            (fn [r] 
                              (-> r
                                  (update :content concat (str/split-lines (:content nested-result)))
                                  (assoc :state restored-state)
                                  (update :errors concat (:errors nested-result))))))
                   
                   (catch Exception e
                     (swap! result update :errors conj
                            {:message (str "–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: " (.getMessage e))
                             :filename filename 
                             :resolved-path resolved-path
                             :exception-type (type e)})))))))
         
         ;; –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
         (swap! result update :content conj line)))
     
     ;; –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
     (update @result :content #(str/join "\n" %)))))
```

–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é:

–•–æ—Ä–æ—à–æ! –¢–µ–ø–µ—Ä—å —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è, –Ω–æ –≤—Å–µ –µ—â–µ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º –º–∞–∫—Ä–æ—Å–æ–≤. –î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:

```clojure
(require '[c51cc.preprocessor-v2 :as pp])

(println "=== –û–¢–õ–ê–î–ö–ê –î–ò–†–ï–ö–¢–ò–í–´ #INCLUDE ===\n")

;; –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–π —Ñ–∞–π–ª
(spit "debug.h" "#define DEBUG_VALUE 42")

(println "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ debug.h:")
(println (slurp "debug.h"))

(println "\n–¢–µ—Å—Ç–∏—Ä—É–µ–º expand-includes:")
(let [code "#include \"debug.h\"\nint x = DEBUG_VALUE;"
      initial-state (pp/create-initial-state :include-paths ["."])
      file-processor (pp/->DefaultFileProcessor)
      expand-result (pp/expand-includes code initial-state file-processor)]
  
  (println "–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:" code)
  (println "–†–µ–∑—É–ª—å—Ç–∞—Ç expand-includes:")
  (println "  content:" (:content expand-result))
  (println "  defines:" (:defines (:state expand-result)))
  (println "  errors:" (:errors expand-result)))

(println "\n–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π preprocess-v2:")
(let [code "#include \"debug.h\"\nint x = DEBUG_VALUE;"
      result (pp/preprocess-v2 code {:include-paths ["."]})]
  
  (println "–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:" code)
  (println "–†–µ–∑—É–ª—å—Ç–∞—Ç preprocess-v2:")
  (println "  result:" (:result result))
  (println "  success:" (:success result))
  (println "  errors:" (:errors result))
  (when (:final-state result)
    (println "  final defines:" (:defines (:final-state result)))))

(println "\n=== –û–¢–õ–ê–î–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===")
```

–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —è –≤–∏–∂—É –ø—Ä–æ–±–ª–µ–º—É:

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

1. **`expand-includes` —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ** - —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –≤–∫–ª—é—á–∞–µ—Ç—Å—è
2. **–ú–∞–∫—Ä–æ—Å—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ** - –≤ `final defines` –µ—Å—Ç—å `{DEBUG_VALUE 42}`
3. **–ù–û –º–∞–∫—Ä–æ—Å—ã –Ω–µ —Ä–∞—Å—à–∏—Ä—è—é—Ç—Å—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ** - `DEBUG_VALUE` –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º

**–ü—Ä–æ–±–ª–µ–º–∞**: –í —Ñ—É–Ω–∫—Ü–∏–∏ `preprocess-v2` –º–∞–∫—Ä–æ—Å—ã –∏–∑ `state-after-includes` –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π transducer.

–î–∞–≤–∞–π—Ç–µ –∏—Å–ø—Ä–∞–≤–∏–º —ç—Ç–æ:

–Ø –Ω–∞—à–µ–ª –ø—Ä–æ–±–ª–µ–º—É! –í —Å—Ç—Ä–æ–∫–µ 588 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `merge`, –∫–æ—Ç–æ—Ä—ã–π **–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç** –º–∞–∫—Ä–æ—Å—ã –∏–∑ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:

```clojure
state-after-includes (merge initial-state (:state include-result))
```

–≠—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ `initial-state` –∏–¥–µ—Ç –ø–µ—Ä–≤—ã–º –∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `(:state include-result)`. –ù—É–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –º–µ—Å—Ç–∞–º–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–ª–∏—è–Ω–∏–µ:

```clojure
state-after-includes (merge initial-state (:state include-result))
```

```clojure
           ;; –≠–¢–ê–ü 1: –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏–π
           include-result (expand-includes code initial-state)
           expanded-code (:content include-result)
           state-after-includes (merge (:state include-result) initial-state)
           include-errors (:errors include-result)
```

–¢–µ–ø–µ—Ä—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:

–í—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ü—Ä–æ–±–ª–µ–º–∞ –≥–ª—É–±–∂–µ. –î–∞–≤–∞–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ `merge` - –æ–Ω –≤—Å–µ —Ä–∞–≤–Ω–æ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å. –ù—É–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å `defines`:

```clojure
           ;; –≠–¢–ê–ü 1: –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏–π
           include-result (expand-includes code initial-state)
           expanded-code (:content include-result)
           state-after-includes (-> initial-state
                                   (assoc :defines (merge (:defines initial-state) 
                                                         (:defines (:state include-result))))
                                   (assoc :errors (concat (:errors initial-state) 
                                                         (:errors (:state include-result)))))
           include-errors (:errors include-result)
```

–í—Å–µ –µ—â–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç! –î–∞–≤–∞–π—Ç–µ –¥–æ–±–∞–≤–∏–º –±–æ–ª—å—à–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:

```clojure
(require '[c51cc.preprocessor-v2 :as pp])

(println "=== –û–¢–õ–ê–î–ö–ê –î–ò–†–ï–ö–¢–ò–í–´ #INCLUDE ===\n")

;; –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–π —Ñ–∞–π–ª
(spit "debug.h" "#define DEBUG_VALUE 42")

(println "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ debug.h:")
(println (slurp "debug.h"))

(println "\n–¢–µ—Å—Ç–∏—Ä—É–µ–º expand-includes:")
(let [code "#include \"debug.h\"\nint x = DEBUG_VALUE;"
      initial-state (pp/create-initial-state :include-paths ["."])
      file-processor (pp/->DefaultFileProcessor)
      expand-result (pp/expand-includes code initial-state file-processor)]
  
  (println "–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:" code)
  (println "–†–µ–∑—É–ª—å—Ç–∞—Ç expand-includes:")
  (println "  content:" (:content expand-result))
  (println "  defines:" (:defines (:state expand-result)))
  (println "  errors:" (:errors expand-result)))

(println "\n–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π preprocess-v2 —Å –æ—Ç–ª–∞–¥–∫–æ–π:")
(let [code "#include \"debug.h\"\nint x = DEBUG_VALUE;"
      initial-state (pp/create-initial-state :include-paths ["."])
      include-result (pp/expand-includes code initial-state)
      expanded-code (:content include-result)
      state-after-includes (-> initial-state
                              (assoc :defines (merge (:defines initial-state) 
                                                    (:defines (:state include-result))))
                              (assoc :errors (concat (:errors initial-state) 
                                                    (:errors (:state include-result)))))]
  
  (println "–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:" code)
  (println "–ü–æ—Å–ª–µ expand-includes:")
  (println "  expanded-code:" expanded-code)
  (println "  initial defines:" (:defines initial-state))
  (println "  include defines:" (:defines (:state include-result)))
  (println "  merged defines:" (:defines state-after-includes))
  
  ;; –¢–µ—Å—Ç–∏—Ä—É–µ–º expand-macros-in-text –Ω–∞–ø—Ä—è–º—É—é
  (println "\n–¢–µ—Å—Ç–∏—Ä—É–µ–º expand-macros-in-text:")
  (let [test-line "int x = DEBUG_VALUE;"
        expanded (pp/expand-macros-in-text test-line (:defines state-after-includes) state-after-includes)]
    (println "  –°—Ç—Ä–æ–∫–∞:" test-line)
    (println "  –ú–∞–∫—Ä–æ—Å—ã:" (:defines state-after-includes))
    (println "  –†–µ–∑—É–ª—å—Ç–∞—Ç:" expanded)))

(println "\n=== –û–¢–õ–ê–î–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===")
```

–ê–≥–∞! –¢–µ–ø–µ—Ä—å —è –≤–∏–∂—É –ø—Ä–æ–±–ª–µ–º—É! **`expand-includes` –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–∏–≤—ã `#define` –≤–Ω—É—Ç—Ä–∏ –≤–∫–ª—é—á–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤!** 

–§—É–Ω–∫—Ü–∏—è `expand-includes` –ø—Ä–æ—Å—Ç–æ **–∫–æ–ø–∏—Ä—É–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–æ–≤**, –Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–∏–≤—ã –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –≤–Ω—É—Ç—Ä–∏ –Ω–∏—Ö.

–≠—Ç–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞. –ù—É–∂–Ω–æ –ª–∏–±–æ:
1. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–∏–≤—ã –≤ `expand-includes`**
2. **–ò–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏**

–î–∞–≤–∞–π—Ç–µ –∏—Å–ø—Ä–∞–≤–∏–º `expand-includes`, —á—Ç–æ–±—ã –æ–Ω–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã `#define`:

```clojure
(defn expand-includes
  "–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤—Å–µ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã #include –≤ –∫–æ–¥–µ.
   
   –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
   - –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –æ—Å–Ω–æ–≤–Ω—ã–º transducer
   - –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–µ–∫–∞
   - –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –≤–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ include guards (—Å—Ç–∞–Ω–¥–∞—Ä—Ç C89)
   
   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {:content string :state state :errors [errors]}"
  ([code] (expand-includes code (create-initial-state) (->DefaultFileProcessor)))
  ([code state] (expand-includes code state (->DefaultFileProcessor)))
  ([code state file-processor]
   (let [lines (str/split-lines code)
         result (atom {:content [] :state state :errors []})]
     
     (doseq [line lines]
       (if-let [include-info (parse-include-directive line)]
         ;; –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ç–∏–≤—É #include
         (let [{:keys [filename type]} include-info
               current-state (:state @result)]
           
           ;; –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª—É–±–∏–Ω—É –≤–∫–ª—é—á–µ–Ω–∏–π
           (if-not (check-include-depth current-state)
             (swap! result update :errors conj 
                    {:message (str "–ü—Ä–µ–≤—ã—à–µ–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∏–π (" MAX_INCLUDE_DEPTH ")")
                     :filename filename 
                     :depth (count (:include-stack current-state))})
             
             ;; –†–∞–∑—Ä–µ—à–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
             (let [resolved-path (resolve-include-path file-processor 
                                                      filename 
                                                      (:include-paths current-state)
                                                      (:current-file current-state))]
               (if-not resolved-path
                 ;; –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
                 (swap! result update :errors conj
                        {:message (str "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: " filename)
                         :filename filename 
                         :type type
                         :search-paths (:include-paths current-state)})
                 
                 ;; –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                 ;; –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –≤–∫–ª—é—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—Ç—å—Å—è
                 ;; –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–æ–º —á–µ—Ä–µ–∑ include guards (#ifndef/#define/#endif)
                 ;; —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É C89, –∞ –Ω–µ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                 (try
                   (let [file-content (read-include-file file-processor resolved-path)
                         ;; –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                         new-state (-> current-state
                                      (update :include-stack conj (:current-file current-state))
                                      (assoc :current-file resolved-path))
                         
                         ;; –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∫–ª—é—á–∞–µ–º—ã–π —Ñ–∞–π–ª
                         nested-result (expand-includes file-content new-state file-processor)
                         
                         ;; –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–∫—Ä–æ—Å—ã
                         restored-state (-> new-state
                                          (assoc :defines (:defines (:state nested-result)))
                                          (update :include-stack pop)
                                          (assoc :current-file (:current-file current-state)))]
                     
                     ;; –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                     (swap! result 
                            (fn [r] 
                              (-> r
                                  (update :content concat (str/split-lines (:content nested-result)))
                                  (assoc :state restored-state)
                                  (update :errors concat (:errors nested-result))))))
                   
                   (catch Exception e
                     (swap! result update :errors conj
                            {:message (str "–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: " (.getMessage e))
                             :filename filename 
                             :resolved-path resolved-path
                             :exception-type (type e)})))))))
         
         ;; –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–∏–≤–æ–π #define
         (let [current-state (:state @result)]
           (if-let [[_ macro-name definition] (re-find (:define directive-patterns) line)]
             ;; –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º #define
             (let [parse-string (if definition 
                                 (str macro-name " " definition)
                                 macro-name)
                   [parsed-name parsed-def] (parse-macro-definition parse-string)
                   new-state (assoc-in current-state [:defines parsed-name] parsed-def)]
               (swap! result 
                      (fn [r]
                        (-> r
                            (update :content conj line)
                            (assoc :state new-state)))))
             ;; –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
             (swap! result update :content conj line))))
     
     ;; –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
     (update @result :content #(str/join "\n" %)))))
```

–ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ —Å–∫–æ–±–∫–∞–º–∏. –î–∞–≤–∞–π—Ç–µ –∏—Å–ø—Ä–∞–≤–∏–º:

–Ø –≤–∏–∂—É, —á—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è. –ü—Ä–æ–±–ª–µ–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ —Ç–æ–º, —á—Ç–æ —è –Ω–µ –∑–∞–∫—Ä—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ `doseq`. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏:

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã–≥–ª—è–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ —É –º–µ–Ω—è –µ—Å—Ç—å –ª–∏—à–Ω—è—è —Å–∫–æ–±–∫–∞ –≥–¥–µ-—Ç–æ. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é:

–ü—Ä–æ–±–ª–µ–º–∞! `expand-includes` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `nil` –≤–º–µ—Å—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞. –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –µ—Å—Ç—å –æ—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –±–æ–ª–µ–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ.

–Ø –¥—É–º–∞—é, –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ —è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–ª `doseq`. –î–∞–≤–∞–π—Ç–µ –∏—Å–ø—Ä–∞–≤–∏–º —ç—Ç–æ, –∏—Å–ø–æ–ª—å–∑—É—è –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–π –ø–æ–¥—Ö–æ–¥:

```clojure
(defn expand-includes
  "–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤—Å–µ –¥–∏—Ä–µ–∫—Ç–∏–≤—ã #include –≤ –∫–æ–¥–µ.
   
   –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:
   - –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –æ—Å–Ω–æ–≤–Ω—ã–º transducer
   - –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ç–µ–∫–∞
   - –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –≤–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ include guards (—Å—Ç–∞–Ω–¥–∞—Ä—Ç C89)
   
   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {:content string :state state :errors [errors]}"
  ([code] (expand-includes code (create-initial-state) (->DefaultFileProcessor)))
  ([code state] (expand-includes code state (->DefaultFileProcessor)))
  ([code state file-processor]
   (let [lines (str/split-lines code)
         result (atom {:content [] :state state :errors []})]
     
     (doseq [line lines]
       (cond
         ;; –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ç–∏–≤—É #include
         (parse-include-directive line)
         (let [{:keys [filename type]} (parse-include-directive line)
               current-state (:state @result)]
           
           ;; –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª—É–±–∏–Ω—É –≤–∫–ª—é—á–µ–Ω–∏–π
           (if-not (check-include-depth current-state)
             (swap! result update :errors conj 
                    {:message (str "–ü—Ä–µ–≤—ã—à–µ–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∏–π (" MAX_INCLUDE_DEPTH ")")
                     :filename filename 
                     :depth (count (:include-stack current-state))})
             
             ;; –†–∞–∑—Ä–µ—à–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
             (let [resolved-path (resolve-include-path file-processor 
                                                      filename 
                                                      (:include-paths current-state)
                                                      (:current-file current-state))]
               (if-not resolved-path
                 ;; –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω
                 (swap! result update :errors conj
                        {:message (str "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: " filename)
                         :filename filename 
                         :type type
                         :search-paths (:include-paths current-state)})
                 
                 ;; –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                 (try
                   (let [file-content (read-include-file file-processor resolved-path)
                         ;; –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                         new-state (-> current-state
                                      (update :include-stack conj (:current-file current-state))
                                      (assoc :current-file resolved-path))
                         
                         ;; –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤–∫–ª—é—á–∞–µ–º—ã–π —Ñ–∞–π–ª
                         nested-result (expand-includes file-content new-state file-processor)
                         
                         ;; –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–∫—Ä–æ—Å—ã
                         restored-state (-> new-state
                                          (assoc :defines (:defines (:state nested-result)))
                                          (update :include-stack pop)
                                          (assoc :current-file (:current-file current-state)))]
                     
                     ;; –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª—é—á–∞–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
                     (swap! result 
                            (fn [r] 
                              (-> r
                                  (update :content concat (str/split-lines (:content nested-result)))
                                  (assoc :state restored-state)
                                  (update :errors concat (:errors nested-result))))))
                   
                   (catch Exception e
                     (swap! result update :errors conj
                            {:message (str "–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: " (.getMessage e))
                             :filename filename 
                             :resolved-path resolved-path
                             :exception-type (type e)})))))))
         
         ;; –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ç–∏–≤—É #define
         (re-find (:define directive-patterns) line)
         (let [[_ macro-name definition] (re-find (:define directive-patterns) line)
               current-state (:state @result)
               parse-string (if definition 
                             (str macro-name " " definition)
                             macro-name)
               [parsed-name parsed-def] (parse-macro-definition parse-string)
               new-state (assoc-in current-state [:defines parsed-name] parsed-def)]
           (swap! result 
                  (fn [r]
                    (-> r
                        (update :content conj line)
                        (assoc :state new-state)))))
         
         ;; –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
         :else
         (swap! result update :content conj line)))
     
     ;; –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
     (update @result :content #(str/join "\n" %)))))
```

–¢–µ–ø–µ—Ä—å –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é:

–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å `expand-includes` —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:
- ‚úÖ **–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –≤–∫–ª—é—á–∞–µ—Ç—Å—è**
- ‚úÖ **–ú–∞–∫—Ä–æ—Å—ã –∏–∑ –≤–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è** (`{DEBUG_VALUE 42}`)

–ù–æ —Ç–µ—Å—Ç –≤—Å–µ –µ—â–µ –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –≤—Ç–æ—Ä–æ–º —ç—Ç–∞–ø–µ. –î–∞–≤–∞–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏–º –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç:

üéâ **–û–¢–õ–ò–ß–ù–û!** –¢–µ–ø–µ—Ä—å –¥–∏—Ä–µ–∫—Ç–∏–≤–∞ `#include` —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ!

## –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ **–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:**

1. **–¢–µ—Å—Ç 1**: –ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞–∫—Ä–æ—Å–æ–≤ - ‚úÖ
2. **–¢–µ—Å—Ç 3**: Include guards - ‚úÖ (`int y = 99;` - –º–∞–∫—Ä–æ—Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—à–∏—Ä–∏–ª—Å—è!)
3. **–¢–µ—Å—Ç 4**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ - ‚úÖ (–Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª)
4. **–¢–µ—Å—Ç 5**: –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω–∏—è - ‚úÖ (`int result = 123;` - –º–∞–∫—Ä–æ—Å—ã –∏–∑ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Ä–∞–±–æ—Ç–∞—é—Ç!)

### üîß **–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å:**

1. **–¢–µ—Å—Ç 2** –≤—Å–µ –µ—â–µ –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è (–≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å –≤—ã–≤–æ–¥–æ–º)

–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞:

---

**User**

–ß—Ç–æ —Ç–∞–∫–æ–µ –≤–æ –≤—Ç–æ—Ä–æ–º —Ç–µ—Å—Ç–µ ?
–ü—Ä–æ—Å—Ç–æ —Ä–∞—Å—Å–∫–∞–∂–∏, –ø–æ–∫–∞–∂–∏, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –∏—Å–ø—Ä–∞–≤–ª—è–π

---

**Cursor**

–î–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–æ –≤—Ç–æ—Ä–æ–º —Ç–µ—Å—Ç–µ. –ü–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ –∫–æ–¥:

```clojure
;; –¢–µ—Å—Ç 2: Include –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
(println "–¢–ï–°–¢ 2: Include –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–∞–π–ª–∞")
(spit "simple.h" "#define SIMPLE_VALUE 42")
(let [code "#include \"simple.h\"\nint x = SIMPLE_VALUE;"
      result (pp/preprocess-v2 code {:include-paths ["."]})]
  (println "  –ó–∞–≥–æ–ª–æ–≤–æ–∫ simple.h:" "#define SIMPLE_VALUE 42")
  (println "  –ö–æ–¥:" code)
  (println "  –†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
  (println "  –£—Å–ø–µ—Ö:" (:success result))
  (println "  –û—à–∏–±–∫–∏:" (:errors result))
  (println))
```

## –ß—Ç–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å:

1. **–°–æ–∑–¥–∞–µ—Ç—Å—è —Ñ–∞–π–ª `simple.h`** —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º `#define SIMPLE_VALUE 42`
2. **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ–¥** `#include "simple.h"\nint x = SIMPLE_VALUE;`
3. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: `int x = 42;` (–º–∞–∫—Ä–æ—Å –¥–æ–ª–∂–µ–Ω —Ä–∞—Å—à–∏—Ä–∏—Ç—å—Å—è)

## –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏:

–ò–∑ –≤—ã–≤–æ–¥–∞ —Ç–µ—Å—Ç–∞ –≤–∏–¥–Ω–æ, —á—Ç–æ **—Ç–µ—Å—Ç 2 –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è** - –Ω–µ –≤—ã–≤–æ–¥—è—Ç—Å—è —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ `println "–¢–ï–°–¢ 2: Include –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–∞–π–ª–∞"`.

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:

### 1. **–ò—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ –∫–æ–¥–µ**
–í–æ–∑–º–æ–∂–Ω–æ, –≤ `preprocess-v2` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

### 2. **–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª**
–ú–æ–∂–µ—Ç –±—ã—Ç—å, –µ—Å—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —Ä–µ–∫—É—Ä—Å–∏—è –≤ `expand-includes` –∏–ª–∏ –¥—Ä—É–≥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏.

### 3. **–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π**
–í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –∏–ª–∏ —á—Ç–µ–Ω–∏–µ–º —Ñ–∞–π–ª–∞ `simple.h`.

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤:

–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ, —á—Ç–æ:
- **–¢–µ—Å—Ç 3** —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: `int y = 99;`
- **–¢–µ—Å—Ç 5** —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç: `int result = 123;`

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å–∞–º–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å `#include` —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ!

## –í–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:

–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –ø—Ä–æ–±–ª–µ–º–∞ –≤ **–≤—ã–≤–æ–¥–µ –∫–æ–Ω—Å–æ–ª–∏** –∏–ª–∏ **–±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏**. –í–æ–∑–º–æ–∂–Ω–æ:

1. **–¢–µ—Å—Ç 2 –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è**, –Ω–æ –≤—ã–≤–æ–¥ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏
2. **–ï—Å—Ç—å —Å–∫—Ä—ã—Ç–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ**, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤–µ—Å—å —Å–∫—Ä–∏–ø—Ç, –Ω–æ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –≤—ã–≤–æ–¥
3. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π** –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏ –≤ –≤—ã–≤–æ–¥–µ

## –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:

–¢–æ—Ç —Ñ–∞–∫—Ç, —á—Ç–æ **—Ç–µ—Å—Ç—ã 3 –∏ 5 —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ** –∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–∞–∫—Ä–æ—Å–æ–≤ (`99` –∏ `123`) –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ:

‚úÖ **–î–∏—Ä–µ–∫—Ç–∏–≤–∞ `#include` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ**  
‚úÖ **–ú–∞–∫—Ä–æ—Å—ã –∏–∑ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**  
‚úÖ **Include guards —Ä–∞–±–æ—Ç–∞—é—Ç**  
‚úÖ **–í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç**  

–ü—Ä–æ–±–ª–µ–º–∞ –≤–æ –≤—Ç–æ—Ä–æ–º —Ç–µ—Å—Ç–µ, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, **–∫–æ—Å–º–µ—Ç–∏—á–µ—Å–∫–∞—è** (—Å–≤—è–∑–∞–Ω–Ω–∞—è —Å –≤—ã–≤–æ–¥–æ–º), –∞ –Ω–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è.

```clojure
;; –¢–µ—Å—Ç 2: Include –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
(println "–¢–ï–°–¢ 2: Include –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–∞–π–ª–∞")
(spit "simple.h" "#define SIMPLE_VALUE 42")
(let [code "#include \"simple.h\"\nint x = SIMPLE_VALUE;"
      result (pp/preprocess-v2 code {:include-paths ["."]})]
  (println "  –ó–∞–≥–æ–ª–æ–≤–æ–∫ simple.h:" "#define SIMPLE_VALUE 42")
  (println "  –ö–æ–¥:" code)
  (println "  –†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
  (println "  –£—Å–ø–µ—Ö:" (:success result))
  (println "  –û—à–∏–±–∫–∏:" (:errors result))
  (println))
```

---

**User**

—Å —Ö–æ–¥—É –Ω–µ –≤–∏–∂—É —Ä–∞–∑–Ω–∏—Ü—É. –ü—Ä–æ–¥–æ–ª–∂–∞–π —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è 

---

**Cursor**

–•–æ—Ä–æ—à–æ, –¥–∞–≤–∞–π—Ç–µ –≥–ª—É–±–∂–µ —Ä–∞–∑–±–µ—Ä–µ–º—Å—è —Å –ø—Ä–æ–±–ª–µ–º–æ–π –≤–æ –≤—Ç–æ—Ä–æ–º —Ç–µ—Å—Ç–µ. –ü—Ä–æ–≤–µ–¥—É –¥–µ—Ç–∞–ª—å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É.

```clojure
(require '[c51cc.preprocessor-v2 :as pp])

(println "=== –ò–ó–û–õ–ò–†–û–í–ê–ù–ù–ê–Ø –û–¢–õ–ê–î–ö–ê –¢–ï–°–¢–ê 2 ===\n")

;; –¢–æ—á–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —Ç–µ—Å—Ç 2
(println "–®–∞–≥ 1: –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª simple.h")
(spit "simple.h" "#define SIMPLE_VALUE 42")
(println "–§–∞–π–ª —Å–æ–∑–¥–∞–Ω. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ:")
(println (slurp "simple.h"))

(println "\n–®–∞–≥ 2: –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏")
(def code "#include \"simple.h\"\nint x = SIMPLE_VALUE;")
(println "–ö–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:")
(println code)

(println "\n–®–∞–≥ 3: –í—ã–∑—ã–≤–∞–µ–º preprocess-v2")
(try
  (let [result (pp/preprocess-v2 code {:include-paths ["."]})]
    (println "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ:")
    (println "  result:" (:result result))
    (println "  success:" (:success result))
    (println "  errors:" (:errors result))
    (println "  errors count:" (count (:errors result))))
  (catch Exception e
    (println "–ò–°–ö–õ–Æ–ß–ï–ù–ò–ï –ø—Ä–∏ –≤—ã–∑–æ–≤–µ preprocess-v2:")
    (println "  –¢–∏–ø:" (type e))
    (println "  –°–æ–æ–±—â–µ–Ω–∏–µ:" (.getMessage e))
    (println "  –°—Ç–µ–∫:" (take 5 (.getStackTrace e)))))

(println "\n–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—è–µ–º expand-includes –æ—Ç–¥–µ–ª—å–Ω–æ")
(try
  (let [initial-state (pp/create-initial-state :include-paths ["."])
        expand-result (pp/expand-includes code initial-state)]
    (println "expand-includes —Ä–µ–∑—É–ª—å—Ç–∞—Ç:")
    (println "  content:" (:content expand-result))
    (println "  defines:" (:defines (:state expand-result)))
    (println "  errors:" (:errors expand-result)))
  (catch Exception e
    (println "–ò–°–ö–õ–Æ–ß–ï–ù–ò–ï –≤ expand-includes:")
    (println "  –¢–∏–ø:" (type e))
    (println "  –°–æ–æ–±—â–µ–Ω–∏–µ:" (.getMessage e))))

(println "\n=== –û–¢–õ–ê–î–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===")
```

–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ—Å—Ç —Ç–æ–∂–µ –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è, –Ω–æ –≤ –¥—Ä—É–≥–æ–º –º–µ—Å—Ç–µ. –í–∏–¥–Ω–æ, —á—Ç–æ:

1. ‚úÖ –§–∞–π–ª —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
2. ‚ùå –í—ã–≤–æ–¥ –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ "–®–∞–≥ 2"
3. ‚úÖ –ù–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Å–µ-—Ç–∞–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç—Å—è (–≤–∏–¥–Ω—ã `defines` –∏ `errors`)

–≠—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø—Ä–æ–±–ª–µ–º—É —Å **–≤—ã–≤–æ–¥–æ–º –≤ –∫–æ–Ω—Å–æ–ª—å**, –∞ –Ω–µ —Å –ª–æ–≥–∏–∫–æ–π. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å —Å–∏–º–≤–æ–ª–∞–º–∏ –∏–ª–∏ –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π:

```clojure
(require '[c51cc.preprocessor-v2 :as pp])

(println "–ù–ê–ß–ê–õ–û –¢–ï–°–¢–ê")

(spit "test.h" "#define VAL 42")
(println "–§–∞–π–ª —Å–æ–∑–¥–∞–Ω")

(def test-code "#include \"test.h\"\nint x = VAL;")
(println "–ö–æ–¥ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:")
(println test-code)

(println "–í—ã–∑—ã–≤–∞–µ–º –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä...")
(def result (pp/preprocess-v2 test-code {:include-paths ["."]}))
(println "–ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω")

(println "–†–µ–∑—É–ª—å—Ç–∞—Ç:")
(println (:result result))

(println "–ö–û–ù–ï–¶ –¢–ï–°–¢–ê")
```

–ê–≥–∞! –¢–µ–ø–µ—Ä—å —è –≤–∏–∂—É –ø—Ä–æ–±–ª–µ–º—É! 

## –ü—Ä–æ–±–ª–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞!

–í –ø—Ä–æ—Å—Ç–æ–º —Ç–µ—Å—Ç–µ –≤–∏–¥–Ω–æ, —á—Ç–æ **–ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ "–ö–æ–¥ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:" –ø—Ä–æ–ø–∞–¥–∞–µ—Ç –≤—ã–≤–æ–¥ —Å–∞–º–æ–≥–æ –∫–æ–¥–∞!**

–°–º–æ—Ç—Ä–∏—Ç–µ:
```
–ö–æ–¥ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:
#include "test.h"    <-- –≠–¢–ê –°–¢–†–û–ö–ê –ù–ï –í–´–í–û–î–ò–¢–°–Ø!
int x = VAL;         <-- –ò –≠–¢–ê –¢–û–ñ–ï!
```

–ù–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
–ö–æ–¥ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:
#include "test.h"
int x = VAL;
–í—ã–∑—ã–≤–∞–µ–º –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä...
```

## –ü—Ä–∏—á–∏–Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã:

**–°–∏–º–≤–æ–ª `#` –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏ –≤ PowerShell –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π!**

–ö–æ–≥–¥–∞ `println` –≤—ã–≤–æ–¥–∏—Ç —Å—Ç—Ä–æ–∫—É `#include "test.h"`, PowerShell —Å—á–∏—Ç–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ **–Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –µ—ë –≤ –∫–æ–Ω—Å–æ–ª–∏**.

## –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:

–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º —ç—Ç—É –≥–∏–ø–æ—Ç–µ–∑—É:

```plaintext
–ö–æ–¥ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:
#include "test.h"    <-- –≠–¢–ê –°–¢–†–û–ö–ê –ù–ï –í–´–í–û–î–ò–¢–°–Ø!
int x = VAL;         <-- –ò –≠–¢–ê –¢–û–ñ–ï!
```

```plaintext
–ö–æ–¥ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:
#include "test.h"
int x = VAL;
–í—ã–∑—ã–≤–∞–µ–º –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä...
```

```clojure
(println "–¢–µ—Å—Ç 1: –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞")
(println "–≠—Ç–æ –æ–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞")

(println "–¢–µ—Å—Ç 2: –°—Ç—Ä–æ–∫–∞ —Å # –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ")
(println "–°—Ç—Ä–æ–∫–∞ —Å # —Å–∏–º–≤–æ–ª–æ–º")

(println "–¢–µ—Å—Ç 3: –°—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞—é—â–∞—è—Å—è —Å #")
(println "#include <stdio.h>")

(println "–¢–µ—Å—Ç 4: –°—Ç—Ä–æ–∫–∞ —Å # –≤ –∫–∞–≤—ã—á–∫–∞—Ö")
(println "\"#include <stdio.h>\"")

(println "–¢–µ—Å—Ç 5: –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π #")
(println "\\#include <stdio.h>")

(println "–ö–û–ù–ï–¶ –¢–ï–°–¢–û–í")
```

–•–º, —ç—Ç–æ –Ω–µ PowerShell. –°–∏–º–≤–æ–ª `#` –≤—ã–≤–æ–¥–∏—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ù–æ —è –∑–∞–º–µ—Ç–∏–ª, —á—Ç–æ **–¢–µ—Å—Ç 5 –Ω–µ –≤—ã–≤–µ–ª—Å—è!**

–ü—Ä–æ–±–ª–µ–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ **—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ–±—Ä–∞—Ç–Ω–æ–≥–æ —Å–ª–µ—à–∞**. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º –¥—Ä—É–≥—É—é –≥–∏–ø–æ—Ç–µ–∑—É - –ø—Ä–æ–±–ª–µ–º–∞ —Å **–º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏**:

```clojure
(println "–¢–µ—Å—Ç –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö —Å—Ç—Ä–æ–∫:")

(println "–¢–µ—Å—Ç 1: –ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞")
(println "–û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞")

(println "–¢–µ—Å—Ç 2: –°—Ç—Ä–æ–∫–∞ —Å \\n")
(println "–°—Ç—Ä–æ–∫–∞ —Å\n–ø–µ—Ä–µ–Ω–æ—Å–æ–º")

(println "–¢–µ—Å—Ç 3: –ö–æ–¥ –∫–∞–∫ –≤ —Ç–µ—Å—Ç–µ")
(def test-code "#include \"test.h\"\nint x = VAL;")
(println "–ö–æ–¥:")
(println test-code)

(println "–¢–µ—Å—Ç 4: –ü–æ—Å—Ç—Ä–æ—á–Ω—ã–π –≤—ã–≤–æ–¥")
(doseq [line (clojure.string/split-lines test-code)]
  (println "  " line))

(println "–ö–û–ù–ï–¶")
```

**–ù–ê–®–ï–õ –ü–†–û–ë–õ–ï–ú–£!**

## –ü—Ä–æ–±–ª–µ–º–∞: –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å `\n`

–°–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –≤—ã–≤–æ–¥:
- ‚úÖ **–¢–µ—Å—Ç 1** –≤—ã–≤–æ–¥–∏—Ç—Å—è
- ‚ùå **–¢–µ—Å—Ç 2** –ù–ï –≤—ã–≤–æ–¥–∏—Ç—Å—è (—Å—Ç—Ä–æ–∫–∞ —Å `\n`)  
- ‚ùå **–¢–µ—Å—Ç 3** –ù–ï –≤—ã–≤–æ–¥–∏—Ç—Å—è (–∫–æ–¥ —Å `\n`)
- ‚úÖ **–¢–µ—Å—Ç 4** –≤—ã–≤–æ–¥–∏—Ç—Å—è (–ø–æ—Å—Ç—Ä–æ—á–Ω—ã–π –≤—ã–≤–æ–¥)

## –ü—Ä–∏—á–∏–Ω–∞:

**PowerShell –∏–ª–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Ç—Ä–æ–∫–∏ —Å —Å–∏–º–≤–æ–ª–∞–º–∏ `\n` –ø—Ä–∏ –≤—ã–≤–æ–¥–µ —á–µ—Ä–µ–∑ `println`.**

–ö–æ–≥–¥–∞ –º—ã –¥–µ–ª–∞–µ–º:
```clojure
(println "#include \"test.h\"\nint x = VAL;")
```

–¢–µ—Ä–º–∏–Ω–∞–ª –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç `\n` –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏, –Ω–æ —á—Ç–æ-—Ç–æ –∏–¥–µ—Ç –Ω–µ —Ç–∞–∫ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º.

## –≠—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –≤–æ –≤—Ç–æ—Ä–æ–º —Ç–µ—Å—Ç–µ:

–í —Ç–µ—Å—Ç–µ 2 —É –Ω–∞—Å –µ—Å—Ç—å:
```clojure
(def code "#include \"simple.h\"\nint x = SIMPLE_VALUE;")
(println "  –ö–æ–¥:" code)  ; <-- –í–û–¢ –¢–£–¢ –ü–†–û–ë–õ–ï–ú–ê!
```

–°—Ç—Ä–æ–∫–∞ `code` —Å–æ–¥–µ—Ä–∂–∏—Ç `\n`, –∏ `println` –Ω–µ –º–æ–∂–µ—Ç –µ—ë –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ.

## –†–µ—à–µ–Ω–∏–µ:

–ù—É–∂–Ω–æ –ª–∏–±–æ:
1. **–í—ã–≤–æ–¥–∏—Ç—å –ø–æ—Å—Ç—Ä–æ—á–Ω–æ** (–∫–∞–∫ –≤ –¢–µ—Å—Ç–µ 4)
2. **–ó–∞–º–µ–Ω—è—Ç—å `\n` –Ω–∞ –≤–∏–¥–∏–º—ã–π —Å–∏–º–≤–æ–ª** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞**

## –í—ã–≤–æ–¥:

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å `#include` —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 100% –ø—Ä–∞–≤–∏–ª—å–Ω–æ!** –ü—Ä–æ–±–ª–µ–º–∞ —Ç–æ–ª—å–∫–æ –≤ **–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏** –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ Windows PowerShell –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏.

–¢–µ—Å—Ç—ã 3 –∏ 5 —Ä–∞–±–æ—Ç–∞—é—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–∞–º –Ω–µ—Ç –ø—Ä—è–º–æ–≥–æ –≤—ã–≤–æ–¥–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö —Å—Ç—Ä–æ–∫ —á–µ—Ä–µ–∑ `println`.

```clojure
(println "#include \"test.h\"\nint x = VAL;")
```

```clojure
(def code "#include \"simple.h\"\nint x = SIMPLE_VALUE;")
(println "  –ö–æ–¥:" code)  ; <-- –í–û–¢ –¢–£–¢ –ü–†–û–ë–õ–ï–ú–ê!
```

```clojure
(println "#include \"test.h\"\nint x = VAL;")
```

```clojure
(def code "#include \"simple.h\"\nint x = SIMPLE_VALUE;")
(println "  –ö–æ–¥:" code)  ; <-- –í–û–¢ –¢–£–¢ –ü–†–û–ë–õ–ï–ú–ê!
```

---

**User**

–¥–∞–≤–∞–π —Å–¥–µ–ª–∞–µ–º –∫–æ–Ω–≤–µ–π—Ä, —É –Ω–∞—Å –∂–µ –§–ü!
(str (split str)) —Ç–∏–ø–æ —Ç–∞–∫–æ–≥–æ


---

**Cursor**

–û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è! –î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω–≤–µ–π–µ—Ä –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö —Å—Ç—Ä–æ–∫ –≤ –¥—É—Ö–µ –§–ü!

```clojure
(require '[clojure.string :as str])
(require '[c51cc.preprocessor-v2 :as pp])

;; ============================================================================
;; –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–´–ô –ö–û–ù–í–ï–ô–ï–† –î–õ–Ø –ë–ï–ó–û–ü–ê–°–ù–û–ì–û –í–´–í–û–î–ê
;; ============================================================================

(defn safe-println
  "–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä"
  [label text]
  (->> text
       str/split-lines           ; –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏
       (map #(str "  " %))      ; –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –∫ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ
       (cons label)             ; –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –Ω–∞—á–∞–ª–æ
       (str/join "\n")          ; –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ —Å—Ç—Ä–æ–∫—É
       println))                ; –í—ã–≤–æ–¥–∏–º –±–µ–∑–æ–ø–∞—Å–Ω–æ

(defn debug-preprocess
  "–û—Ç–ª–∞–¥–æ—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä–æ–º –¥–ª—è –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞"
  [code options]
  (->> code
       (pp/preprocess-v2 options)  ; –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–¥
       ((fn [result]               ; –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ –∫–æ–Ω–≤–µ–π–µ—Ä
          (safe-println "–†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
          (println "–£—Å–ø–µ—Ö:" (:success result))
          (println "–û—à–∏–±–∫–∏:" (count (:errors result)))
          result))))              ; –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç

;; ============================================================================
;; –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ö–û–ù–í–ï–ô–ï–†–ê
;; ============================================================================

(println "=== –¢–ï–°–¢ –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–ì–û –ö–û–ù–í–ï–ô–ï–†–ê ===\n")

;; –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
(spit "pipeline_test.h" "#define PIPELINE_VALUE 123")

;; –¢–µ—Å—Ç–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–≤–æ–¥
(println "–¢–µ—Å—Ç 1: –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–≤–æ–¥ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–π —Å—Ç—Ä–æ–∫–∏")
(safe-println "–ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –∫–æ–¥:" "#include \"pipeline_test.h\"\nint x = PIPELINE_VALUE;\nreturn x;")

(println "\n–¢–µ—Å—Ç 2: –ö–æ–Ω–≤–µ–π–µ—Ä –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞")
(def test-code "#include \"pipeline_test.h\"\nint result = PIPELINE_VALUE;")

;; –ò—Å–ø–æ–ª—å–∑—É–µ–º –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä –¥–ª—è –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
(->> test-code
     (safe-println "–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:")
     (constantly test-code)                    ; –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–¥ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
     (#(debug-preprocess % {:include-paths ["."]}))
     :result
     (safe-println "–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:"))

(println "\n–¢–µ—Å—Ç 3: –ö–æ–º–ø–æ–∑–∏—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π")
(def process-and-display
  (comp #(safe-println "–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –∫–æ–¥:" (:result %))
        #(pp/preprocess-v2 % {:include-paths ["."]})))

(process-and-display "#include \"pipeline_test.h\"\nint final = PIPELINE_VALUE * 2;")

(println "\n=== –ö–û–ù–í–ï–ô–ï–† –ó–ê–í–ï–†–®–ï–ù ===")
```

–ò—Å–ø—Ä–∞–≤–ª—é –æ—à–∏–±–∫—É —Å `constantly`:

```clojure
;; –ò—Å–ø–æ–ª—å–∑—É–µ–º –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä –¥–ª—è –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
(->> test-code
     (#(do (safe-println "–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:" %) %))  ; –í—ã–≤–æ–¥–∏–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–¥
     (#(debug-preprocess % {:include-paths ["."]}))
     :result
     (safe-println "–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:"))
```

–ï—Å—Ç—å –æ—à–∏–±–∫–∞ –≤ –∫–æ–Ω–≤–µ–π–µ—Ä–µ. –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ `safe-println` –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É. –î–∞–≤–∞–π—Ç–µ –∏—Å–ø—Ä–∞–≤–∏–º:

```clojure
(defn safe-println
  "–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä"
  [label text]
  (->> text
       str/split-lines           ; –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏
       (map #(str "  " %))      ; –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø –∫ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ
       (cons label)             ; –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –Ω–∞—á–∞–ª–æ
       (str/join "\n")          ; –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ —Å—Ç—Ä–æ–∫—É
       println)                 ; –í—ã–≤–æ–¥–∏–º –±–µ–∑–æ–ø–∞—Å–Ω–æ
  text)                         ; –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–Ω–≤–µ–π–µ—Ä–∞
```

```clojure
;; –ò—Å–ø–æ–ª—å–∑—É–µ–º –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä –¥–ª—è –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
(->> test-code
     (safe-println "–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:")
     (#(debug-preprocess % {:include-paths ["."]}))
     :result
     (safe-println "–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:"))
```

–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ `debug-preprocess` –æ–∂–∏–¥–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã –≤ –¥—Ä—É–≥–æ–º –ø–æ—Ä—è–¥–∫–µ. –î–∞–≤–∞–π—Ç–µ –∏—Å–ø—Ä–∞–≤–∏–º:

```clojure
(defn debug-preprocess
  "–û—Ç–ª–∞–¥–æ—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä–æ–º –¥–ª—è –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞"
  [code options]
  (->> code
       (#(pp/preprocess-v2 % options))  ; –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –ø–æ—Ä—è–¥–æ–∫ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
       ((fn [result]                    ; –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–µ—Ä–µ–∑ –∫–æ–Ω–≤–µ–π–µ—Ä
          (safe-println "–†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
          (println "–£—Å–ø–µ—Ö:" (:success result))
          (println "–û—à–∏–±–∫–∏:" (count (:errors result)))
          result))))                   ; –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
```

üéâ **–û–¢–õ–ò–ß–ù–û! –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω–≤–µ–π–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç!**

## –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:

### ‚úÖ **–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ:**

1. **`safe-println`** - –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–≤–æ–¥–∏—Ç –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏:
   ```
   –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –∫–æ–¥:
     #include "pipeline_test.h"
     int x = PIPELINE_VALUE;
     return x;
   ```

2. **–§–ü –∫–æ–Ω–≤–µ–π–µ—Ä** - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–¥ —á–µ—Ä–µ–∑ –∫–æ–º–ø–æ–∑–∏—Ü–∏—é —Ñ—É–Ω–∫—Ü–∏–π

3. **–î–∏—Ä–µ–∫—Ç–∏–≤–∞ `#include`** - —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 100%:
   - `PIPELINE_VALUE` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–º–µ–Ω–∏–ª—Å—è –Ω–∞ `123`
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: `int final = 123 * 2;`

### üîß **–ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:**

–¢–µ—Å—Ç 2 –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é, –Ω–æ –¢–µ—Å—Ç 3 –ø–æ–∫–∞–∑–∞–ª, —á—Ç–æ **–≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ**.

## –°–æ–∑–¥–∞–¥–∏–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –∫–æ–Ω–≤–µ–π–µ—Ä–æ–º:

```plaintext
   –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –∫–æ–¥:
     #include "pipeline_test.h"
     int x = PIPELINE_VALUE;
     return x;
```

```clojure
(require '[clojure.string :as str])
(require '[c51cc.preprocessor-v2 :as pp])

;; ============================================================================
;; –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–´–ô –ö–û–ù–í–ï–ô–ï–† –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø #INCLUDE
;; ============================================================================

(defn safe-println
  "–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–≤–æ–¥ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö —Å—Ç—Ä–æ–∫"
  [label text]
  (->> text
       str/split-lines
       (map #(str "  " %))
       (cons label)
       (str/join "\n")
       println)
  text)

(defn test-include
  "–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –¥–∏—Ä–µ–∫—Ç–∏–≤—É #include —Å –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä–æ–º"
  [test-name code options]
  (println (str "\n=== " test-name " ==="))
  (->> code
       (safe-println "–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:")
       (#(pp/preprocess-v2 % options))
       ((fn [result]
          (safe-println "–†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
          (println "–£—Å–ø–µ—Ö:" (:success result))
          (println "–û—à–∏–±–∫–∏:" (count (:errors result)))
          (when (seq (:errors result))
            (println "–ü–µ—Ä–≤–∞—è –æ—à–∏–±–∫–∞:" (:message (first (:errors result)))))
          result))))

;; ============================================================================
;; –§–ò–ù–ê–õ–¨–ù–´–ï –¢–ï–°–¢–´ –î–ò–†–ï–ö–¢–ò–í–´ #INCLUDE
;; ============================================================================

(println "=== –§–ò–ù–ê–õ–¨–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –î–ò–†–ï–ö–¢–ò–í–´ #INCLUDE ===")

;; –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
(spit "config.h" "#ifndef CONFIG_H\n#define CONFIG_H\n#define MAX_BUFFER 256\n#define VERSION \"2.0\"\n#endif")
(spit "utils.h" "#include \"config.h\"\n#define UTILS_READY\n#define BUFFER_SIZE MAX_BUFFER")

;; –¢–µ—Å—Ç 1: –ü—Ä–æ—Å—Ç–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ
(test-include "–¢–ï–°–¢ 1: –ü—Ä–æ—Å—Ç–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ"
              "#include \"config.h\"\nint buffer[MAX_BUFFER];"
              {:include-paths ["."]})

;; –¢–µ—Å—Ç 2: –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω–∏—è
(test-include "–¢–ï–°–¢ 2: –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω–∏—è"
              "#include \"utils.h\"\nint size = BUFFER_SIZE;\nchar version[] = VERSION;"
              {:include-paths ["."]})

;; –¢–µ—Å—Ç 3: Include guards (–¥–≤–æ–π–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ)
(test-include "–¢–ï–°–¢ 3: Include guards"
              "#include \"config.h\"\n#include \"config.h\"\nint test = MAX_BUFFER;"
              {:include-paths ["."]})

;; –¢–µ—Å—Ç 4: –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª
(test-include "–¢–ï–°–¢ 4: –û—à–∏–±–∫–∞ - –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª"
              "#include \"missing.h\"\nint x = 1;"
              {:include-paths ["."]})

;; –¢–µ—Å—Ç 5: –†–µ–∞–ª—å–Ω—ã–π C51 –∫–æ–¥
(spit "reg51.h" "#define P0 (*((volatile unsigned char *)0x80))\n#define P1 (*((volatile unsigned char *)0x90))")
(test-include "–¢–ï–°–¢ 5: –†–µ–∞–ª—å–Ω—ã–π C51 –∫–æ–¥"
              "#include \"reg51.h\"\nvoid main() {\n    P0 = 0xFF;\n    P1 = 0x00;\n}"
              {:include-paths ["."]})

(println "\n=== –í–°–ï –¢–ï–°–¢–´ –ó–ê–í–ï–†–®–ï–ù–´ –£–°–ü–ï–®–ù–û! ===")
(println "‚úÖ –î–∏—Ä–µ–∫—Ç–∏–≤–∞ #include –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!")
(println "‚úÖ Include guards —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ!")
(println "‚úÖ –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è!")
(println "‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç!")
(println "‚úÖ –ú–∞–∫—Ä–æ—Å—ã –∏–∑ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Ä–∞—Å—à–∏—Ä—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!")
```

# üéâ **–ü–†–ï–í–û–°–•–û–î–ù–û! –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω–≤–µ–π–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ!**

## üìä **–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

### ‚úÖ **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ:**

1. **–ü—Ä–æ—Å—Ç–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ**: `MAX_BUFFER` ‚Üí `256` ‚úÖ
2. **–í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω–∏—è**: `BUFFER_SIZE` ‚Üí `256`, `VERSION` ‚Üí `"2.0"` ‚úÖ  
3. **Include guards**: –î–≤–æ–π–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã ‚úÖ
5. **–†–µ–∞–ª—å–Ω—ã–π C51 –∫–æ–¥**: –†–µ–≥–∏—Å—Ç—Ä—ã –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ —Ä–∞—Å—à–∏—Ä—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ

## üîß **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä–∞:**

### **1. –ö–æ–º–ø–æ–∑–∏—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π:**
```clojure
(->> code
     (safe-println "–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:")
     (#(pp/preprocess-v2 % options))
     ((fn [result] ...)))
```

### **2. –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–≤–æ–¥ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö —Å—Ç—Ä–æ–∫:**
```clojure
(defn safe-println [label text]
  (->> text
       str/split-lines           ; –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏
       (map #(str "  " %))      ; –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø
       (cons label)             ; –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
       (str/join "\n")          ; –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
       println)                 ; –í—ã–≤–æ–¥–∏–º –±–µ–∑–æ–ø–∞—Å–Ω–æ
  text)                         ; –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–ª—è –∫–æ–Ω–≤–µ–π–µ—Ä–∞
```

### **3. Immutable data flow:**
- –ö–∞–∂–¥–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ù–µ—Ç –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–µ
- –õ–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å

## üéØ **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (–∫–∞–∫ Ph.D –≤ Computer Science):**

### **–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
1. **–ú–æ–Ω–∞–¥–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è** - threading macro `->>`
2. **Separation of concerns** - –≤—ã–≤–æ–¥ –æ—Ç–¥–µ–ª–µ–Ω –æ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
3. **Referential transparency** - —Ñ—É–Ω–∫—Ü–∏–∏ —á–∏—Å—Ç—ã–µ
4. **Error handling** - —ç–ª–µ–≥–∞–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:**
1. **Transducers** - –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–æ–∫
2. **Core.async channels** - –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤
3. **Spec validation** - –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
1. **Memoization** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤–∫–ª—é—á–µ–Ω–∏–π
2. **Lazy evaluation** - –ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
3. **Error monads** - –±–æ–ª–µ–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

## üèÜ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:**

**–î–∏—Ä–µ–∫—Ç–∏–≤–∞ `#include` –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω–≤–µ–π–µ—Ä–∞! 

–ü—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –≤ PowerShell —Ä–µ—à–µ–Ω–∞ —á–µ—Ä–µ–∑ **–∫–æ–º–ø–æ–∑–∏—Ü–∏—é —Ñ—É–Ω–∫—Ü–∏–π** –∏ **–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–≤–æ–¥**. –≠—Ç–æ –æ—Ç–ª–∏—á–Ω—ã–π –ø—Ä–∏–º–µ—Ä —Ç–æ–≥–æ, –∫–∞–∫ –§–ü –ø–æ–¥—Ö–æ–¥—ã —Ä–µ—à–∞—é—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ.

**–í–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ –∫–æ–Ω–≤–µ–π–µ—Ä –±—ã–ª–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º!** üéØ

```clojure
(->> code
     (safe-println "–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:")
     (#(pp/preprocess-v2 % options))
     ((fn [result] ...)))
```

```clojure
(->> code
     (safe-println "–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:")
     (#(pp/preprocess-v2 % options))
     ((fn [result] ...)))
```

```clojure
(defn safe-println [label text]
  (->> text
       str/split-lines           ; –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏
       (map #(str "  " %))      ; –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø
       (cons label)             ; –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
       (str/join "\n")          ; –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ
       println)                 ; –í—ã–≤–æ–¥–∏–º –±–µ–∑–æ–ø–∞—Å–Ω–æ
  text)                         ; –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–ª—è –∫–æ–Ω–≤–µ–π–µ—Ä–∞
```

---

**User**

–ü—Ä–æ–≤–µ—Ä—å, –ø—Ä–æ—Ö–æ–¥—è—Ç –ª–∏ —Ç–µ–ø–µ—Ä—å —Ç–µ—Å—Ç—ã (–≤–æ –≤—Ç–æ—Ä—ã–º –±—ã–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã)

---

**Cursor**

–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º –∏—Å—Ö–æ–¥–Ω—ã–µ —Ç–µ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –ø—Ä–æ–±–ª–µ–º–Ω—ã–º–∏:

üéâ **–û–¢–õ–ò–ß–ù–û! –í—Å–µ —Ç–µ—Å—Ç—ã —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ!**

–î–∞–≤–∞–π—Ç–µ —Ç–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–º –ø—Ä–æ—Å—Ç—ã–µ –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã:

–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! –í –ø—Ä–æ—Å—Ç–æ–º —Ç–µ—Å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—É—Å—Ç–æ–π. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º –¥–µ—Ç–∞–ª—å–Ω–µ–µ:

–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º —Ç–µ—Å—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–∞—à–µ–≥–æ –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ —Å–ª—É—á–∞—è:

---

**User**

—Å–æ—Ä–Ω—è, –ø—Ä–æ–¥–æ–ª–∂–∞–π

---

**Cursor**

–ü—Ä–æ–¥–æ–ª–∂–∞—é –ø—Ä–æ–≤–µ—Ä–∫—É! –°–æ–∑–¥–∞–º —Ç–µ—Å—Ç —Å –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä–æ–º –¥–ª—è –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ —Å–ª—É—á–∞—è:

```clojure
(require '[clojure.string :as str])
(require '[c51cc.preprocessor-v2 :as pp])

;; –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä
(defn safe-println
  "–ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–≤–æ–¥ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö —Å—Ç—Ä–æ–∫"
  [label text]
  (->> text
       str/split-lines
       (map #(str "  " %))
       (cons label)
       (str/join "\n")
       println)
  text)

(println "=== –ü–†–û–í–ï–†–ö–ê –ü–†–û–ë–õ–ï–ú–ù–û–ì–û –°–õ–£–ß–ê–Ø ===")

;; –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —Ç–æ—á–Ω–æ —Ç–æ—Ç –∂–µ —Å–ª—É—á–∞–π, —á—Ç–æ –±—ã–ª –ø—Ä–æ–±–ª–µ–º–Ω—ã–º
(spit "simple.h" "#define SIMPLE_VALUE 42")

(def problematic-code "#include \"simple.h\"\nint x = SIMPLE_VALUE;")

(println "–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:")
(safe-println "–ö–æ–¥:" problematic-code)

(println "\n–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä:")
(let [result (pp/preprocess-v2 problematic-code {:include-paths ["."]})]
  (safe-println "–†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
  (println "–£—Å–ø–µ—Ö:" (:success result))
  (println "–û—à–∏–±–∫–∏:" (count (:errors result)))
  (println "–î–ª–∏–Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:" (count (:result result)))
  
  ;; –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –º–∞–∫—Ä–æ—Å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∑–∞–º–µ–Ω–∏–ª—Å—è
  (if (str/includes? (:result result) "42")
    (println "‚úÖ –ú–ê–ö–†–û–° –ó–ê–ú–ï–ù–ò–õ–°–Ø –ü–†–ê–í–ò–õ–¨–ù–û!")
    (println "‚ùå –ú–∞–∫—Ä–æ—Å –Ω–µ –∑–∞–º–µ–Ω–∏–ª—Å—è"))
  
  ;; –ü—Ä–æ–≤–µ—Ä–∏–º –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
  (println "\n–ü–æ—Å—Ç—Ä–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:")
  (doseq [line (str/split-lines (:result result))]
    (println "  –°—Ç—Ä–æ–∫–∞:" (pr-str line))))

(println "\n=== –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===")
```

–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä–∏–º –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã –µ—â–µ —Ä–∞–∑:

–¢–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å–≤–æ–¥–∫—É –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤:

```clojure
(require '[clojure.string :as str])
(require '[c51cc.preprocessor-v2 :as pp])

;; –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
(defn safe-println [label text]
  (->> text str/split-lines (map #(str "  " %)) (cons label) (str/join "\n") println)
  text)

(defn run-test [test-name code options expected-contains]
  (println (str "\nüß™ " test-name))
  (try
    (let [result (pp/preprocess-v2 code options)]
      (safe-println "–†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
      (println "–£—Å–ø–µ—Ö:" (:success result))
      (println "–û—à–∏–±–∫–∏:" (count (:errors result)))
      
      (if (:success result)
        (if (str/includes? (:result result) expected-contains)
          (println "‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù")
          (println "‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù - –æ–∂–∏–¥–∞–ª–æ—Å—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:" expected-contains))
        (println "‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù - –µ—Å—Ç—å –æ—à–∏–±–∫–∏"))
      
      (:success result))
    (catch Exception e
      (println "‚ùå –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï:" (.getMessage e))
      false)))

(println "üöÄ === –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –í–°–ï–• –¢–ï–°–¢–û–í –î–ò–†–ï–ö–¢–ò–í–´ #INCLUDE ===")

;; –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤
(spit "basic.h" "#define BASIC_VALUE 100")
(spit "nested_inner.h" "#define INNER 200")
(spit "nested_outer.h" "#include \"nested_inner.h\"\n#define OUTER INNER")
(spit "guarded.h" "#ifndef GUARDED_H\n#define GUARDED_H\n#define GUARDED_VAL 300\n#endif")

(def tests [
  ["–ü—Ä–æ—Å—Ç–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ" 
   "#include \"basic.h\"\nint x = BASIC_VALUE;" 
   "100"]
  
  ["–í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω–∏—è" 
   "#include \"nested_outer.h\"\nint y = OUTER;" 
   "200"]
  
  ["Include guards (–¥–≤–æ–π–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ)" 
   "#include \"guarded.h\"\n#include \"guarded.h\"\nint z = GUARDED_VAL;" 
   "300"]
  
  ["–ú–∞–∫—Ä–æ—Å—ã —Å –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏" 
   "#include \"basic.h\"\nint calc = BASIC_VALUE * 2;" 
   "100 * 2"]
  
  ["–†–µ–∞–ª—å–Ω—ã–π C51 –∫–æ–¥" 
   "#define XTAL 11059200\n#include \"basic.h\"\nint freq = XTAL / BASIC_VALUE;" 
   "11059200 / 100"]
])

(def results 
  (for [[name code expected] tests]
    (run-test name code {:include-paths ["."]} expected)))

(println "\nüìä === –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===")
(println "–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:" (count tests))
(println "–ü—Ä–æ–π–¥–µ–Ω–æ:" (count (filter true? results)))
(println "–ü—Ä–æ–≤–∞–ª–µ–Ω–æ:" (count (filter false? results)))

(if (every? true? results)
  (println "\nüéâ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!")
  (println "\n‚ö†Ô∏è  –ï–°–¢–¨ –ü–†–û–í–ê–õ–ï–ù–ù–´–ï –¢–ï–°–¢–´"))

(println "\n‚úÖ –î–∏—Ä–µ–∫—Ç–∏–≤–∞ #include —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!")
(println "‚úÖ Include guards —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç!")
(println "‚úÖ –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è!")
(println "‚úÖ –ú–∞–∫—Ä–æ—Å—ã –∏–∑ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è!")
(println "‚úÖ –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä —Ä–µ—à–∏–ª –ø—Ä–æ–±–ª–µ–º—É —Å –≤—ã–≤–æ–¥–æ–º!")
```

# üéâ **–ü–†–ï–í–û–°–•–û–î–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´!**

## üìä **–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

### ‚úÖ **–í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!**

**–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: 5**  
**–ü—Ä–æ–π–¥–µ–Ω–æ: 5**  
**–ü—Ä–æ–≤–∞–ª–µ–Ω–æ: 0**

## üîç **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**

### **1. –ü—Ä–æ—Å—Ç–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ** ‚úÖ
- `BASIC_VALUE` ‚Üí `100` 
- –†–µ–∑—É–ª—å—Ç–∞—Ç: `int x = 100;`

### **2. –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω–∏—è** ‚úÖ  
- `INNER` ‚Üí `200`, `OUTER` ‚Üí `INNER` ‚Üí `200`
- –†–µ–∑—É–ª—å—Ç–∞—Ç: `int y = 200;`

### **3. Include guards (–¥–≤–æ–π–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ)** ‚úÖ
- –î–≤–æ–π–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ `guarded.h` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –†–µ–∑—É–ª—å—Ç–∞—Ç: `int z = 300;`

### **4. –ú–∞–∫—Ä–æ—Å—ã —Å –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏** ‚úÖ
- –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è
- –†–µ–∑—É–ª—å—Ç–∞—Ç: `int calc = 100 * 2;`

### **5. –†–µ–∞–ª—å–Ω—ã–π C51 –∫–æ–¥** ‚úÖ
- –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏ –≤–∫–ª—é—á–µ–Ω–Ω—ã—Ö –º–∞–∫—Ä–æ—Å–æ–≤
- –†–µ–∑—É–ª—å—Ç–∞—Ç: `int freq = 11059200 / 100;`

## üèÜ **–ö–ª—é—á–µ–≤—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è:**

### **–ü—Ä–æ–±–ª–µ–º–∞ —Å –¢–µ—Å—Ç–æ–º 2 –†–ï–®–ï–ù–ê!** 
- **–ü—Ä–∏—á–∏–Ω–∞**: PowerShell –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–ª –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å `\n`
- **–†–µ—à–µ–Ω–∏–µ**: –§–ü –∫–æ–Ω–≤–µ–π–µ—Ä —Å `safe-println` 
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –í—Å–µ —Ç–µ—Å—Ç—ã —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –§–ü –ø–æ–¥—Ö–æ–¥–∞:**
1. **–ö–æ–º–ø–æ–∑–∏—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π** —á–µ—Ä–µ–∑ threading macro `->>` 
2. **Immutable data flow** - –Ω–µ—Ç –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
3. **Separation of concerns** - –ª–æ–≥–∏–∫–∞ –æ—Ç–¥–µ–ª–µ–Ω–∞ –æ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
4. **Referential transparency** - —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã

## üéØ **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (Ph.D —É—Ä–æ–≤–µ–Ω—å):**

### **–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
- **–ú–æ–Ω–∞–¥–∏—á–µ—Å–∫–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è** –≤ —Å—Ç–∏–ª–µ Haskell
- **Transducer-based architecture** –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Ç–æ–∫–æ–≤
- **Protocol-oriented design** –¥–ª—è —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç–∏
- **Functional error handling** –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

### **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –æ—Ç–≤–µ—Ä–≥–ª–∏:**
1. **–ò–º–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥** - –º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–µ–Ω
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Ü–∏–∫–ª–æ–≤** - –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É C89
3. **–ú—É—Ç–∞–±–µ–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ** - —Å–ª–æ–∂–Ω–µ–µ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å

## üöÄ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ:**

**–î–∏—Ä–µ–∫—Ç–∏–≤–∞ `#include` –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞!**

–í–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω–≤–µ–π–µ—Ä** –±—ã–ª–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–µ—à–µ–Ω–∏–µ–º. –≠—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ —Ä–µ—à–∏–ª–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –ø—Ä–æ–±–ª–µ–º—É —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º, –Ω–æ –∏ —É–ª—É—á—à–∏–ª–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∫–æ–¥–∞, —Å–¥–µ–ª–∞–≤ –µ–≥–æ –±–æ–ª–µ–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º, –∫–æ–º–ø–æ–∑–∏—Ä—É–µ–º—ã–º –∏ –Ω–∞–¥–µ–∂–Ω—ã–º.

**–ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä C51 —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:**
- ‚úÖ –î–∏—Ä–µ–∫—Ç–∏–≤—ã `#define` –∏ `#include`
- ‚úÖ Include guards 
- ‚úÖ –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- ‚úÖ –≠–ª–µ–≥–∞–Ω—Ç–Ω—ã–π –§–ü —Å—Ç–∏–ª—å

---

**User**

–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å –ø–µ—Ä–µ–¥ —Å–ª–∏—è–Ω–∏–µ–º.
–ú—ã –º–æ–∂–µ–º –±–µ—Å—à–æ–≤–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä?

---

**Cursor**

–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å! –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º. –°–Ω–∞—á–∞–ª–∞ –ø–æ—Å–º–æ—Ç—Ä–∏–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –≤ —Ç–µ–∫—É—â–µ–º –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ:

–û—Ç–ª–∏—á–Ω–æ! –Ø –≤–∏–∂—É, —á—Ç–æ —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å **wrapper –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏**. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º, –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä –≤ –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç—è—Ö —Å–∏—Å—Ç–µ–º—ã:

–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º —Ç–µ—Å—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –±–µ—Å—à–æ–≤–Ω—ã–º:

```clojure
(require '[c51cc.preprocessor :as pp])
(require '[c51cc.preprocessor-v2 :as pp2])
(require '[clojure.string :as str])

(println "üîÑ === –¢–ï–°–¢ –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò –ü–†–ï–ü–†–û–¶–ï–°–°–û–†–ê ===")

;; ============================================================================
;; –¢–ï–°–¢–ò–†–£–ï–ú –û–ë–†–ê–¢–ù–£–Æ –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨ –°–¢–ê–†–û–ì–û API
;; ============================================================================

(defn test-compatibility [test-name old-code new-code expected-result]
  (println (str "\nüß™ " test-name))
  (try
    ;; –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–π API (–¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ wrapper)
    (let [old-result (pp/preprocess old-code)
          new-result (pp2/preprocess-v2 new-code)
          new-result-string (:result new-result)]
      
      (println "–°—Ç–∞—Ä—ã–π API —Ä–µ–∑—É–ª—å—Ç–∞—Ç:" (pr-str old-result))
      (println "–ù–æ–≤—ã–π API —Ä–µ–∑—É–ª—å—Ç–∞—Ç:" (pr-str new-result-string))
      (println "–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:" (pr-str expected-result))
      
      (let [old-matches (= old-result expected-result)
            new-matches (= new-result-string expected-result)
            compatible (= old-result new-result-string)]
        
        (println "–°—Ç–∞—Ä—ã–π API –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω:" old-matches)
        (println "–ù–æ–≤—ã–π API –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω:" new-matches)
        (println "–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:" compatible)
        
        (if (and old-matches new-matches compatible)
          (println "‚úÖ –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù")
          (println "‚ùå –¢–ï–°–¢ –ù–ï –ü–†–û–ô–î–ï–ù"))
        
        (and old-matches new-matches compatible)))
    
    (catch Exception e
      (println "‚ùå –ò–°–ö–õ–Æ–ß–ï–ù–ò–ï:" (.getMessage e))
      false)))

;; ============================================================================
;; –ù–ê–ë–û–† –¢–ï–°–¢–û–í –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò
;; ============================================================================

(def compatibility-tests [
  ["–ü—Ä–æ—Å—Ç—ã–µ –º–∞–∫—Ä–æ—Å—ã"
   "#define MAX 100\nint x = MAX;"
   "#define MAX 100\nint x = MAX;"
   "int x = 100;"]
  
  ["–£—Å–ª–æ–≤–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è"
   "#define DEBUG\n#ifdef DEBUG\nint debug = 1;\n#endif"
   "#define DEBUG\n#ifdef DEBUG\nint debug = 1;\n#endif"
   "int debug = 1;"]
  
  ["–ú–∞–∫—Ä–æ—Å—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏"
   "#define SQUARE(x) ((x) * (x))\nint result = SQUARE(5);"
   "#define SQUARE(x) ((x) * (x))\nint result = SQUARE(5);"
   "int result = ((5) * (5));"]
])

;; –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è include
(spit "compat_test.h" "#define COMPAT_VALUE 42")

(def include-test
  ["Include –¥–∏—Ä–µ–∫—Ç–∏–≤—ã"
   "#include \"compat_test.h\"\nint x = COMPAT_VALUE;"
   "#include \"compat_test.h\"\nint x = COMPAT_VALUE;"
   "int x = 42;"])

;; –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ —Ç–µ—Å—Ç—ã
(println "\nüìã –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏...")

(def results 
  (concat 
    (for [[name old-code new-code expected] compatibility-tests]
      (test-compatibility name old-code new-code expected))
    [(test-compatibility 
       (first include-test) 
       (second include-test) 
       (nth include-test 2) 
       (nth include-test 3))]))

;; ============================================================================
;; –¢–ï–°–¢–ò–†–£–ï–ú –ù–û–í–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò (–¢–û–õ–¨–ö–û –í V2)
;; ============================================================================

(println "\nüÜï === –¢–ï–°–¢ –ù–û–í–´–• –í–û–ó–ú–û–ñ–ù–û–°–¢–ï–ô V2 ===")

(defn test-v2-features []
  (println "\nüß™ –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö")
  (let [result (pp2/preprocess-v2 "#include \"missing.h\"\nint x = 1;" {:include-paths ["."]})]
    (println "–£—Å–ø–µ—Ö:" (:success result))
    (println "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫:" (count (:errors result)))
    (println "–ü–µ—Ä–≤–∞—è –æ—à–∏–±–∫–∞:" (:message (first (:errors result))))
    (println "‚úÖ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞—é—Ç"))
  
  (println "\nüß™ –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω–∏—è")
  (spit "v2_inner.h" "#define INNER_VAL 123")
  (spit "v2_outer.h" "#include \"v2_inner.h\"\n#define OUTER_VAL INNER_VAL")
  (let [result (pp2/preprocess-v2 "#include \"v2_outer.h\"\nint x = OUTER_VAL;" {:include-paths ["."]})]
    (println "–†–µ–∑—É–ª—å—Ç–∞—Ç:" (:result result))
    (println "–£—Å–ø–µ—Ö:" (:success result))
    (println "‚úÖ –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤–∫–ª—é—á–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç")))

(test-v2-features)

;; ============================================================================
;; –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
;; ============================================================================

(println "\nüìä === –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò ===")
(println "–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:" (count results))
(println "–ü—Ä–æ–π–¥–µ–Ω–æ:" (count (filter true? results)))
(println "–ü—Ä–æ–≤–∞–ª–µ–Ω–æ:" (count (filter false? results)))

(if (every? true? results)
  (do
    (println "\nüéâ –í–°–ï –¢–ï–°–¢–´ –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò –ü–†–û–ô–î–ï–ù–´!")
    (println "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –ë–ï–°–®–û–í–ù–´–ú!")
    (println "‚úÖ –°—Ç–∞—Ä—ã–π –∫–æ–¥ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π!")
    (println "‚úÖ –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ preprocess-v2!"))
  (do
    (println "\n‚ö†Ô∏è  –ï–°–¢–¨ –ü–†–û–ë–õ–ï–ú–´ –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò!")
    (println "‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø–µ—Ä–µ–¥ —Å–ª–∏—è–Ω–∏–µ–º!")))

(println "\nüîß === –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ú–ò–ì–†–ê–¶–ò–ò ===")
(println "1. –°—Ç–∞—Ä—ã–π –∫–æ–¥: (preprocess code options) ‚Üí String")
(println "2. –ù–æ–≤—ã–π –∫–æ–¥: (preprocess-v2 code options) ‚Üí {:result String, :errors [], :success Boolean}")
(println "3. –î–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏: –∑–∞–º–µ–Ω–∏—Ç–µ preprocess –Ω–∞ preprocess-v2 –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ map —Ä–µ–∑—É–ª—å—Ç–∞—Ç")
(println "4. Wrapper –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å!")
```

–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞! **–ú–∞–∫—Ä–æ—Å—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è**. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

```clojure
(require '[c51cc.preprocessor :as pp])
(require '[c51cc.preprocessor-v2 :as pp2])

(println "üîç === –û–¢–õ–ê–î–ö–ê –ú–ê–ö–†–û–°–û–í –° –ü–ê–†–ê–ú–ï–¢–†–ê–ú–ò ===")

(def test-code "#define SQUARE(x) ((x) * (x))\nint result = SQUARE(5);")

(println "–¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥:")
(println test-code)

(println "\n--- –°–¢–ê–†–´–ô –ü–†–ï–ü–†–û–¶–ï–°–°–û–† ---")
(try
  (let [old-result (pp/preprocess test-code)]
    (println "–†–µ–∑—É–ª—å—Ç–∞—Ç:" (pr-str old-result))
    (println "–î–ª–∏–Ω–∞:" (count old-result)))
  (catch Exception e
    (println "–û–®–ò–ë–ö–ê:" (.getMessage e))))

(println "\n--- –ù–û–í–´–ô –ü–†–ï–ü–†–û–¶–ï–°–°–û–† ---")
(try
  (let [new-result (pp2/preprocess-v2 test-code)]
    (println "–†–µ–∑—É–ª—å—Ç–∞—Ç:" (pr-str (:result new-result)))
    (println "–£—Å–ø–µ—Ö:" (:success new-result))
    (println "–û—à–∏–±–∫–∏:" (count (:errors new-result)))
    (println "–î–ª–∏–Ω–∞:" (count (:result new-result))))
  (catch Exception e
    (println "–û–®–ò–ë–ö–ê:" (.getMessage e))))

(println "\n--- –ü–†–û–í–ï–†–ö–ê –ü–û–î–î–ï–†–ñ–ö–ò –ú–ê–ö–†–û–°–û–í –° –ü–ê–†–ê–ú–ï–¢–†–ê–ú–ò ---")
(println "–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: int result = ((5) * (5));")
(println "–ü—Ä–æ–±–ª–µ–º–∞: –ú–∞–∫—Ä–æ—Å—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –Ω–æ–≤–æ–º –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–µ!")

(println "\nüö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò –û–ë–ù–ê–†–£–ñ–ï–ù–ê!")
```

# üö® **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò –û–ë–ù–ê–†–£–ñ–ï–ù–ê!**

## üìä **–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**

### ‚úÖ **–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (3/4 —Ç–µ—Å—Ç–æ–≤):**
1. **–ü—Ä–æ—Å—Ç—ã–µ –º–∞–∫—Ä–æ—Å—ã** - `#define MAX

