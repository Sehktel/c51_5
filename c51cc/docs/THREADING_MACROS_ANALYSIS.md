# –ê–Ω–∞–ª–∏–∑ Threading Macros –∏ –º–µ—Ç–æ–¥–æ–≤ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –≤ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–µ C51

## üéØ –¶–µ–ª—å –¥–æ–∫—É–º–µ–Ω—Ç–∞

–ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ threading macros (`->`, `->>`) –∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –≤ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–µ C51. –î–æ–∫—É–º–µ–Ω—Ç —Å–ª—É–∂–∏—Ç –æ—Å–Ω–æ–≤–æ–π –¥–ª—è –∑–∞—â–∏—Ç—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞.

**–í–ê–ñ–ù–û**: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ä—Å–µ—Ä —Å –º–æ–Ω–∞–¥–∞–º–∏ –ù–ï –ø–æ–¥–ª–µ–∂–∏—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É!

---

## üìä Threading Macros: –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

### –ß—Ç–æ —Ç–∞–∫–æ–µ `tap>`?

`tap>` - —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º **–Ω–µ–∏–Ω–≤–∞–∑–∏–≤–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏** –≤ Clojure, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç "–ø–æ–¥—Å–ª—É—à–∏–≤–∞—Ç—å" –¥–∞–Ω–Ω—ã–µ –≤ –ª—é–±–æ–π —Ç–æ—á–∫–µ pipeline –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã.

```clojure
;; –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è tap> –≤ IR pipeline
(defn compile-function [ast-node]
  (->> ast-node
       (tap> "AST input")              ; üîç –û—Ç–ª–∞–¥–∫–∞: –≤–∏–¥–∏–º –≤—Ö–æ–¥–Ω–æ–π AST
       (transform-to-hir)              
       (tap> "HIR after transform")    ; üîç –û—Ç–ª–∞–¥–∫–∞: –≤–∏–¥–∏–º HIR
       (optimize-hir)                  
       (tap> "HIR after optimization") ; üîç –û—Ç–ª–∞–¥–∫–∞: –≤–∏–¥–∏–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π HIR
       (lower-to-mir)                  
       (tap> "MIR output")             ; üîç –û—Ç–ª–∞–¥–∫–∞: –≤–∏–¥–∏–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π MIR
       (generate-assembly)))

;; –ù–∞—Å—Ç—Ä–æ–π–∫–∞ tap> –¥–ª—è –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª—å
(add-tap println)

;; –ù–∞—Å—Ç—Ä–æ–π–∫–∞ tap> –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª
(add-tap #(spit "debug.log" (str % "\n") :append true))
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ `tap>`:

1. **–ù–µ–∏–Ω–≤–∞–∑–∏–≤–Ω–æ—Å—Ç—å**: –ù–µ –∏–∑–º–µ–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É –ø—Ä–æ–≥—Ä–∞–º–º—ã
2. **–ö–æ–º–ø–æ–∑–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å/—É–±–∏—Ä–∞—Ç—å —Ç–æ—á–∫–∏ –æ—Ç–ª–∞–¥–∫–∏
3. **–ì–∏–±–∫–æ—Å—Ç—å**: –ú–æ–∂–Ω–æ –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –≤ —Ä–∞–∑–Ω—ã–µ –º–µ—Å—Ç–∞ (–∫–æ–Ω—Å–æ–ª—å, —Ñ–∞–π–ª, GUI)
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –í production –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π

---

## üî¨ –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –º–µ—Ç–æ–¥–æ–≤ –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏

### 1. Threading Macros (`->`, `->>`)

#### –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã:

```clojure
;; -> (thread-first): —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ü–ï–†–í–´–ú –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º
(-> data
    (process-step-1 arg1 arg2)     ; (process-step-1 data arg1 arg2)
    (process-step-2 arg3)          ; (process-step-2 result arg3)
    (process-step-3))              ; (process-step-3 result)

;; ->> (thread-last): —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ü–û–°–õ–ï–î–ù–ò–ú –∞—Ä–≥—É–º–µ–Ω—Ç–æ–º  
(->> collection
     (filter predicate)            ; (filter predicate collection)
     (map transform)               ; (map transform filtered-result)
     (reduce combine))             ; (reduce combine mapped-result)
```

#### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–µ C51:

```clojure
;; –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ MIR
(defn optimize-basic-block [basic-block]
  (->> basic-block
       :instructions                    ; –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
       (map constant-fold-instruction)  ; Constant folding
       (remove dead-instruction?)       ; Dead code elimination
       (map strength-reduce-instruction) ; Strength reduction
       (map optimize-at89s4051-specific) ; –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
       (vec)                           ; –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –≤–µ–∫—Ç–æ—Ä
       (assoc basic-block :instructions))) ; –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫

;; –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä pipeline
(defn preprocess-line [line state]
  (-> line
      (str/trim)                       ; –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã
      (remove-comments)                ; –£–¥–∞–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏  
      (expand-macros (:defines state)) ; –†–∞—Å—à–∏—Ä—è–µ–º –º–∞–∫—Ä–æ—Å—ã
      (validate-c51-syntax)            ; –ü—Ä–æ–≤–µ—Ä—è–µ–º C51 —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
      (normalize-whitespace)))         ; –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—Ä–æ–±–µ–ª—ã
```

#### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

- **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å**: +85% (–ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏)
- **–û—Ç–ª–∞–¥–æ—á–Ω–æ—Å—Ç—å**: +70% (–ª–∏–Ω–µ–π–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö)
- **–°–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ–º–æ—Å—Ç—å**: +60% (–ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å/—É–±–∏—Ä–∞—Ç—å —ç—Ç–∞–ø—ã)
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: 0% (–º–∞–∫—Ä–æ—Å—ã –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ runtime)

---

### 2. –ú–æ–Ω–∞–¥—ã (–¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ - –£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)

```clojure
;; –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –ø–∞—Ä—Å–µ—Ä —Å –º–æ–Ω–∞–¥–∞–º–∏ (–ù–ï –¢–†–û–ì–ê–ï–ú!)
(defn parse-function-declaration [tokens]
  (do-parse
    [return-type parse-type-specifier
     func-name parse-identifier  
     params (parenthesized (comma-separated parse-parameter))
     body parse-block]
    (return-parser (function-node return-type func-name params body))))
```

#### –ü–æ—á–µ–º—É –º–æ–Ω–∞–¥—ã –∏–¥–µ–∞–ª—å–Ω—ã –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞:
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –ö–æ—Ä–æ—Ç–∫–æ–µ –∑–∞–º—ã–∫–∞–Ω–∏–µ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
- **–ö–æ–º–ø–æ–∑–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—Å–µ—Ä—ã
- **Backtracking**: –í–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
- **–ß–∏—Ç–∞–µ–º–∞—è –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞**: –ö–æ–¥ –ø–æ—Ö–æ–∂ –Ω–∞ BNF

#### –ü–æ—á–µ–º—É –ù–ï —Å—Ç–æ–∏—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å –ø–∞—Ä—Å–µ—Ä:
- **–†–∞–±–æ—Ç–∞–µ—Ç**: –£–∂–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω
- **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: –ú–æ–Ω–∞–¥—ã - —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
- **–†–∏—Å–∫–∏**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–Ω–µ—Å–µ–Ω–∏—è –±–∞–≥–æ–≤
- **–í—Ä–µ–º—è**: –õ—É—á—à–µ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ IR

---

### 3. –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–π (Nested calls)

```clojure
;; –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (–ò–ó–ë–ï–ì–ê–ï–ú)
(defn optimize-basic-block-nested [basic-block]
  (assoc basic-block 
         :instructions 
         (vec (map optimize-at89s4051-specific
                   (map strength-reduce-instruction
                        (remove dead-instruction?
                                (map constant-fold-instruction
                                     (:instructions basic-block))))))))
```

#### –ü—Ä–æ–±–ª–µ–º—ã:
- **–ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞**: –ß—Ç–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∞ –Ω–∞–ª–µ–≤–æ
- **–û—Ç–ª–∞–¥–∫–∞**: –°–ª–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
- **–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ**: –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ç—Ä–µ–±—É—é—Ç –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏—è –≤—Å–µ–π —Ü–µ–ø–æ—á–∫–∏

---

### 4. –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (Let-bindings)

```clojure
(defn optimize-basic-block-let [basic-block]
  (let [instructions (:instructions basic-block)
        after-constant-folding (map constant-fold-instruction instructions)
        after-dead-code (remove dead-instruction? after-constant-folding)
        after-strength-reduction (map strength-reduce-instruction after-dead-code)
        final-instructions (map optimize-at89s4051-specific after-strength-reduction)]
    (assoc basic-block :instructions (vec final-instructions))))
```

#### –ü—Ä–æ–±–ª–µ–º—ã:
- **–í–µ—Ä–±–æ–∑–Ω–æ—Å—Ç—å**: –ú–Ω–æ–≥–æ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –∏–º–µ–Ω
- **Namespace pollution**: –ó–∞—Å–æ—Ä–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏–º–µ–Ω
- **–ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ**: –°–ª–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–¥—É–º—ã–≤–∞–Ω–∏—è –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã—Ö –∏–º–µ–Ω

---

### 5. Transducers (–£–ñ–ï –ò–°–ü–û–õ–¨–ó–£–Æ–¢–°–Ø –í –ü–†–ï–ü–†–û–¶–ï–°–°–û–†–ï)

```clojure
(def optimization-xf
  (comp (map constant-fold-instruction)
        (remove dead-instruction?)
        (map strength-reduce-instruction)
        (map optimize-at89s4051-specific)))

(defn optimize-basic-block-xf [basic-block]
  (update basic-block :instructions 
          #(into [] optimization-xf %)))
```

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π
- **–ö–æ–º–ø–æ–∑–∏—Ä—É–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å
- **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –û–¥–∏–Ω transducer –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π

---

## üß† –ù–∞—É—á–Ω–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞

### –ö–æ–≥–Ω–∏—Ç–∏–≤–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å (–ø–æ Cyclomatic Complexity)

```
–ú–µ—Ç–æ–¥                    | –¶–∏–∫–ª–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å | –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å | –ü—Ä–∏–º–µ–Ω–∏–º–æ—Å—Ç—å
-------------------------|---------------------------|------------|-------------
Threading macros         | 1                        | –í—ã—Å–æ–∫–∞—è    | IR, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
–ú–æ–Ω–∞–¥—ã                   | 1                        | –í—ã—Å–æ–∫–∞—è    | –ü–∞—Ä—Å–∏–Ω–≥ (–£–ñ–ï –ï–°–¢–¨)
–í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã         | 1                        | –ù–∏–∑–∫–∞—è     | –ò–∑–±–µ–≥–∞—Ç—å
Let-bindings             | 1                        | –°—Ä–µ–¥–Ω—è—è    | –†–µ–¥–∫–æ
Transducers              | 1                        | –°—Ä–µ–¥–Ω—è—è    | –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä (–£–ñ–ï –ï–°–¢–¨)
```

### –ü—Ä–∏–Ω—Ü–∏–ø "–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∑–∞–¥–∞—á–∏"

```clojure
;; –ü–ê–†–°–ò–ù–ì: –ú–æ–Ω–∞–¥—ã (–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
Parser a = [Token] -> Maybe (a, [Token])

;; IR –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–ò: Threading macros (–ù–û–í–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø)
Transform a = a -> a

;; –ü–†–ï–ü–†–û–¶–ï–°–°–ò–ù–ì: Transducers (–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û)
Preprocess = [String] -> [String]
```

### –¢–µ–æ—Ä–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ

Threading macros —Ä–µ–∞–ª–∏–∑—É—é—Ç **–∫–∞—Ç–µ–≥–æ—Ä–∏–π–Ω—É—é –∫–æ–º–ø–æ–∑–∏—Ü–∏—é**:

```clojure
;; –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏: f ‚àò g ‚àò h = f(g(h(x)))
;; –í Clojure: (-> x h g f)
```

–≠—Ç–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ç–µ–æ—Ä–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ C51

### 1. –ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä pipeline

```clojure
(defn preprocess-v2 [code options]
  (->> code
       (tap> "Input code")
       str/split-lines
       (map str/trim)
       (remove str/blank?)
       (tap> "Cleaned lines")
       (process-includes (:include-paths options))
       (tap> "After includes")
       (expand-macros (:defines options))
       (tap> "After macro expansion")
       (filter-conditional-compilation)
       (tap> "After conditional compilation")
       (str/join "\n")))
```

### 2. Lexer

```clojure
(defn tokenize-enhanced [code]
  (->> code
       (tap> "Raw code")
       normalize-c51-syntax
       (tap> "Normalized syntax")
       split-into-tokens
       (tap> "Raw tokens")
       (map classify-token)
       (tap> "Classified tokens")
       (remove whitespace-token?)
       (tap> "Filtered tokens")
       vec))
```

### 3. Parser

```clojure
;; –°–£–©–ï–°–¢–í–£–Æ–©–ò–ô –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å
(defn parse [tokens]
  (do-parse
    [declarations (many parse-declaration)]
    (return-parser (program-node declarations))))
```

### 4. IR transformation pipeline

```clojure
(defn compile-to-assembly [ast]
  (->> ast
       (tap> "Input AST")
       transform-to-hir
       (tap> "HIR")
       optimize-hir
       (tap> "Optimized HIR")
       lower-to-mir
       (tap> "MIR")
       optimize-mir
       (tap> "Optimized MIR")
       allocate-registers
       (tap> "After register allocation")
       generate-at89s4051-assembly
       (tap> "Final assembly")))
```

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –∏ –±–µ–Ω—á–º–∞—Ä–∫–∏

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

```clojure
;; –ë–µ–Ω—á–º–∞—Ä–∫: –æ–±—Ä–∞–±–æ—Ç–∫–∞ 1000 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞
(defn benchmark-approaches []
  (let [test-data (repeat 1000 "int x = 42;")]
    
    ;; Threading macros
    (time (->> test-data
               (map process-line)
               (filter valid-line?)
               (map optimize-line)
               doall))
    ;; –†–µ–∑—É–ª—å—Ç–∞—Ç: ~15ms
    
    ;; –í–ª–æ–∂–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã  
    (time (doall (map optimize-line
                      (filter valid-line?
                              (map process-line test-data)))))
    ;; –†–µ–∑—É–ª—å—Ç–∞—Ç: ~15ms (—Ç–∞ –∂–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
    
    ;; Let-bindings
    (time (let [processed (map process-line test-data)
                filtered (filter valid-line? processed)
                optimized (map optimize-line filtered)]
            (doall optimized)))
    ;; –†–µ–∑—É–ª—å—Ç–∞—Ç: ~15ms (—Ç–∞ –∂–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
    ))
```

**–í—ã–≤–æ–¥**: Threading macros –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å runtime, –Ω–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∞—é—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

### –°–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ–º–æ—Å—Ç—å

```clojure
;; –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç—Ç–∞–ø–∞ –≤ pipeline

;; –° threading macros (1 —Å—Ç—Ä–æ–∫–∞)
(->> data
     existing-step-1
     existing-step-2
     NEW-STEP              ; ‚Üê –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å
     existing-step-3)

;; –° –≤–ª–æ–∂–µ–Ω–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ (–ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ –≤—Å–µ–π —Ü–µ–ø–æ—á–∫–∏)
(existing-step-3 
  (NEW-STEP 
    (existing-step-2 
      (existing-step-1 data))))
```

---

## üõ°Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ threading macros

### –ü—Ä–æ–±–ª–µ–º–∞: –ö–æ—Ä–æ—Ç–∫–æ–µ –∑–∞–º—ã–∫–∞–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

```clojure
;; –ü—Ä–æ–±–ª–µ–º–∞: –µ—Å–ª–∏ –æ–¥–∏–Ω —ç—Ç–∞–ø –ø–∞–¥–∞–µ—Ç, –≤–µ—Å—å pipeline –ª–æ–º–∞–µ—Ç—Å—è
(->> data
     step-1
     step-2-might-fail  ; ‚Üê –ú–æ–∂–µ—Ç –±—Ä–æ—Å–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
     step-3)            ; ‚Üê –ù–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è
```

### –†–µ—à–µ–Ω–∏–µ 1: –ú–æ–Ω–∞–¥–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥

```clojure
(defn safe-step [f]
  (fn [result]
    (if (instance? Exception result)
      result
      (try (f result)
           (catch Exception e e)))))

(->> data
     (safe-step step-1)
     (safe-step step-2-might-fail)
     (safe-step step-3))
```

### –†–µ—à–µ–Ω–∏–µ 2: Either/Result –º–æ–Ω–∞–¥–∞

```clojure
(defn compile-with-error-handling [ast]
  (m/do-result
    [hir (transform-to-hir ast)
     optimized-hir (optimize-hir hir)
     mir (lower-to-mir optimized-hir)
     optimized-mir (optimize-mir mir)
     assembly (generate-assembly optimized-mir)]
    (m/ok assembly)))
```

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ C51

### 1. –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –ö–∞–∂–¥–æ–º—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É - —Å–≤–æ–µ –º–µ—Å—Ç–æ

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**:
- **–ü–∞—Ä—Å–µ—Ä**: –ú–æ–Ω–∞–¥—ã (–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù - –ù–ï –¢–†–û–ì–ê–ï–ú!)
- **IR —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏**: Threading macros + `tap>` (–ù–û–í–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø)
- **–ü—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä**: Transducers + Protocols (–£–ñ–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù)

### 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

```clojure
;; 1. –ü–ê–†–°–ï–†: –ú–æ–Ω–∞–¥—ã (–û–°–¢–ê–í–õ–Ø–ï–ú –ö–ê–ö –ï–°–¢–¨)
(defn parse [tokens]
  (do-parse
    [declarations (many parse-declaration)]
    (return-parser (program-node declarations))))

;; 2. IR: Threading macros (–ù–û–í–û–ï)
(defn compile-ast-to-assembly [ast]
  (->> ast
       (tap> "Input AST")
       transform-to-hir
       optimize-hir
       lower-to-mir
       optimize-mir
       generate-assembly))

;; 3. –ü–†–ï–ü–†–û–¶–ï–°–°–û–†: Transducers (–£–ñ–ï –ï–°–¢–¨)
(defn preprocess [code]
  (->> code
       str/split-lines
       (into [] preprocessing-xf)
       (str/join "\n")))
```

### 3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–ö–æ–º–ø–æ–∑–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ö–∞–∂–¥—ã–π —ç—Ç–∞–ø - —á–∏—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è
2. **–û—Ç–ª–∞–¥–æ—á–Ω–æ—Å—Ç—å**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `tap>` –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ
3. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ö–∞–∂–¥—ã–π —ç—Ç–∞–ø —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
4. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: Transducers –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤
5. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: –ù–ï —Ç—Ä–æ–≥–∞–µ–º —Ä–∞–±–æ—Ç–∞—é—â–∏–π –∫–æ–¥

---

## üìã –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏):
~~–§–∞–∑–∞ 2: –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ø–∞—Ä—Å–µ—Ä–∞ (2-3 –Ω–µ–¥–µ–ª–∏)~~

### ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û:

### –§–∞–∑–∞ 1: –°–æ–∑–¥–∞–Ω–∏–µ IR –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (1-2 –Ω–µ–¥–µ–ª–∏)
```clojure
;; –°–æ–∑–¥–∞–µ–º –ù–û–í–´–ô –∫–æ–¥ –¥–ª—è IR
(defn transform-ast-to-hir [ast]
  (->> ast
       (tap> "Input AST from existing parser")
       normalize-ast-structure
       transform-declarations
       transform-statements))
```

### –§–∞–∑–∞ 2: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–∞—Ä—Å–µ—Ä–æ–º (1 –Ω–µ–¥–µ–ª—è)
```clojure
;; –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ–º —Å –°–£–©–ï–°–¢–í–£–Æ–©–ò–ú –ø–∞—Ä—Å–µ—Ä–æ–º
(defn compile-c51 [source-code]
  (->> source-code
       preprocess                    ; –£–ñ–ï –ï–°–¢–¨
       tokenize                      ; –£–ñ–ï –ï–°–¢–¨
       parse                         ; –£–ñ–ï –ï–°–¢–¨ (–ù–ï –¢–†–û–ì–ê–ï–ú!)
       :ast                          ; –ò–∑–≤–ª–µ–∫–∞–µ–º AST
       transform-ast-to-hir          ; –ù–û–í–û–ï
       optimize-hir                  ; –ù–û–í–û–ï
       lower-to-mir                  ; –ù–û–í–û–ï
       optimize-mir                  ; –ù–û–í–û–ï
       generate-assembly))           ; –ù–û–í–û–ï
```

### –§–∞–∑–∞ 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ IR (3-4 –Ω–µ–¥–µ–ª–∏)
```clojure
;; –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ IR, –≥–¥–µ threading macros –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω—ã
(defn optimize-mir-block [basic-block]
  (->> basic-block
       :instructions
       (map constant-fold)
       (remove dead-instruction?)
       (map strength-reduce)
       (map optimize-at89s4051)
       (vec)
       (assoc basic-block :instructions)))
```

---

## üî¨ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Threading macros (`->`, `->>`) –≤ —Å–æ—á–µ—Ç–∞–Ω–∏–∏ —Å `tap>` –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è **–Ω–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤** –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ C51:

1. **–ß–∏—Ç–∞–µ–º–æ—Å—Ç—å**: –õ–∏–Ω–µ–π–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö —Å–ª–µ–≤–∞ –Ω–∞–ø—Ä–∞–≤–æ
2. **–û—Ç–ª–∞–¥–æ—á–Ω–æ—Å—Ç—å**: –ù–µ–∏–Ω–≤–∞–∑–∏–≤–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞ —Å `tap>`
3. **–°–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ–º–æ—Å—Ç—å**: –õ–µ–≥–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–æ–≤
4. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**: –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø–∞–º –§–ü
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ù—É–ª–µ–≤—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û**: –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ä—Å–µ—Ä —Å –º–æ–Ω–∞–¥–∞–º–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º!

**–ü—Ä–∏–Ω—Ü–∏–ø**: "–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∑–∞–¥–∞—á–∏"
- –ú–æ–Ω–∞–¥—ã –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ ‚úÖ
- Threading macros –¥–ª—è IR ‚úÖ
- Transducers –¥–ª—è –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ ‚úÖ

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–ï–ö–û–ú–ï–ù–î–û–í–ê–ù–û –ö –í–ù–ï–î–†–ï–ù–ò–Æ (—Ç–æ–ª—å–∫–æ –¥–ª—è IR)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: –í–´–°–û–ö–ò–ô

**–†–∏—Å–∫–∏**: –ù–ò–ó–ö–ò–ï (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç—Å—è) 