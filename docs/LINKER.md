# Линковщик HCL

## Обзор

Линковщик HCL (HCL.Linker) - это критически важный компонент компилятора HCL, который объединяет объектные файлы в единый исполняемый образ для микроконтроллера AT89S4051. Линковщик выполняет следующие основные функции:

- **Объединение объектных файлов** в единый образ программы
- **Разрешение символов** между модулями
- **Размещение кода и данных** в памяти микроконтроллера
- **Генерация финальных форматов** (Intel HEX, двоичные файлы, листинги)
- **Проверка ограничений памяти** AT89S4051

## Архитектура

### Основные компоненты

1. **Загрузчик объектных файлов** - парсит и валидирует объектные файлы
2. **Таблица символов** - управляет глобальными и локальными символами
3. **Система перемещений** - разрешает адреса символов
4. **Менеджер памяти** - размещает сегменты в памяти микроконтроллера
5. **Генераторы выходных форматов** - создают финальные файлы

### Карта памяти AT89S4051

```
0x0000 - 0x07FF  Flash память (2KB) - код программы
0x0000 - 0x002F  Векторы прерываний
0x0030 - 0x007F  RAM (80 байт) - данные и стек
0x0080 - 0x00FF  SFR (Special Function Registers)
```

## Использование

### Базовое использование

```bash
# Компиляция с линковкой
hcl-exe program.c -o program.hex --hex

# Генерация различных форматов
hcl-exe program.c --format hex -o program
hcl-exe program.c --format bin -o program  
hcl-exe program.c --format lst -o program
```

### Опции командной строки

- `--hex` - генерировать Intel HEX файл
- `--bin` - генерировать двоичный файл
- `--lst` - генерировать листинг с картой памяти
- `--format FORMAT` - указать формат выходного файла
- `-v, --verbose` - подробный вывод процесса линковки

### Фазы компиляции

```bash
# Остановиться после генерации кода (без линковки)
hcl-exe program.c --stop-after codegen

# Выполнить полную компиляцию с линковкой
hcl-exe program.c --stop-after link
```

## Конфигурация линковщика

### LinkerConfig

```haskell
data LinkerConfig = LinkerConfig
  { lcTargetDevice :: Text           -- "AT89S4051"
  , lcCodeStartAddress :: Word16     -- 0x0000
  , lcDataStartAddress :: Word16     -- 0x0030  
  , lcStackStartAddress :: Word16    -- 0x007F
  , lcMaxCodeSize :: Word16          -- 2048 байт
  , lcMaxDataSize :: Word16          -- 128 байт
  , lcEntryPoint :: Text             -- "main"
  , lcOutputFormats :: [OutputFormat]
  , lcOptimizeLayout :: Bool         -- оптимизация размещения
  , lcGenerateMap :: Bool            -- генерация карты памяти
  , lcVerbose :: Bool               -- подробный вывод
  }
```

### Конфигурация по умолчанию

```haskell
defaultLinkerConfig :: LinkerConfig
defaultLinkerConfig = LinkerConfig
  { lcTargetDevice = "AT89S4051"
  , lcCodeStartAddress = 0x0000
  , lcDataStartAddress = 0x0030
  , lcStackStartAddress = 0x007F
  , lcMaxCodeSize = 2048        -- 2KB Flash
  , lcMaxDataSize = 128         -- 128 байт RAM
  , lcEntryPoint = "main"
  , lcOutputFormats = [FormatHex, FormatListing]
  , lcOptimizeLayout = True
  , lcGenerateMap = True
  , lcVerbose = False
  }
```

## Форматы выходных файлов

### Intel HEX (.hex)

Стандартный формат для программирования микроконтроллеров:

```
:020000040000FA
:10000000020030E4F6D8FD7581070200E493A3F8E4
:10001000937581070200E4937581070200E4937581
:00000001FF
```

### Двоичный файл (.bin)

Прямой образ памяти микроконтроллера для эмуляторов и отладчиков.

### Листинг (.lst)

Подробный листинг с адресами, кодом и символами:

```
HCL Linker - Листинг программы
================================

Карта памяти:
Код:   0x0000-0x07FF (156/2048 байт)
Данные: 0x0030-0x007F (12/80 байт)
Стек:   0x007F-0x007F (0/32 байт)
SFR:    0x0080-0x00FF (0/128 байт)

Таблица символов:
main                 0x0030     24 function  global   .text
delay                0x0048     16 function  global   .text
counter              0x0030      2 variable  global   .data
```

### Карта памяти (.map)

Детальная карта размещения символов и сегментов в памяти.

## Обработка ошибок

### Типы ошибок линковщика

```haskell
data LinkerError
  = UndefinedSymbol Text              -- неопределённый символ
  | DuplicateSymbol Text              -- дублирование символа
  | InvalidObjectFile Text Text       -- некорректный объектный файл
  | MemoryOverflow Text Word16 Word16  -- переполнение памяти
  | InvalidRelocation Text Text       -- некорректное перемещение
  | CircularDependency [Text]         -- циклическая зависимость
  | IncompatibleArchitecture Text Text -- несовместимая архитектура
  | InvalidMemoryLayout Text          -- некорректное размещение
```

### Примеры ошибок

```
Ошибка линковщика: Неопределённые символы: printf, malloc
Ошибка линковщика: Превышен размер кода: 2156 > 2048
Ошибка линковщика: Дублирование символа: main
```

## Оптимизации

### Оптимизация размещения

Линковщик может оптимизировать размещение сегментов для:
- Минимизации фрагментации памяти
- Улучшения производительности доступа
- Соблюдения требований выравнивания

### Удаление неиспользуемого кода

Автоматическое удаление функций и данных, которые не используются в программе.

## Интеграция с компилятором

### Последовательность фаз

1. **Препроцессор** - обработка директив
2. **Лексический анализ** - токенизация
3. **Синтаксический анализ** - построение AST
4. **Семантический анализ** - проверка типов, генерация HIR
5. **Оптимизация** - оптимизация HIR
6. **Генерация кода** - создание ассемблерного кода
7. **Линковка** - объединение в исполняемый образ

### Интерфейс с генератором кода

Генератор кода создаёт ассемблерные файлы, которые затем обрабатываются линковщиком:

```haskell
-- Генерация кода
assemblyCode <- runCodeGeneration opts optimizedHir
TIO.writeFile tempAsmFile assemblyCode

-- Линковка
linkerResult <- runLinker opts [tempAsmFile]
```

## Примеры использования

### Простая программа

```c
// blink.c
#include <at89s4051.h>

void delay(unsigned int ms) {
    unsigned int i, j;
    for(i = 0; i < ms; i++)
        for(j = 0; j < 120; j++);
}

void main() {
    while(1) {
        P1 = 0xFF;  // Включить светодиоды
        delay(500);
        P1 = 0x00;  // Выключить светодиоды  
        delay(500);
    }
}
```

### Компиляция

```bash
# Полная компиляция с генерацией HEX
hcl-exe blink.c -o blink.hex --hex -v

# Генерация всех форматов
hcl-exe blink.c --format hex -o blink
hcl-exe blink.c --format bin -o blink
hcl-exe blink.c --format lst -o blink
```

### Результат

```
=== Линковка ===
Загрузка объектных файлов...
Построение таблицы символов...
Проверка неопределённых символов...
Размещение сегментов в памяти...
Разрешение символов...
Проверка ограничений памяти...
Линковка завершена успешно!

=== Результат линковки ===
Результат линковки:
==================
Статус: Успешно

Код:   156/2048 байт (7.6%)
Данные: 12/80 байт (15.0%)
Стек:   0/32 байт (0.0%)

Символы: 3
Диагностика: 0

Сгенерирован HEX файл: blink.hex
Компиляция и линковка завершены успешно!
```

## Расширение и настройка

### Добавление новых форматов

Для добавления нового формата выходного файла:

1. Добавить новый конструктор в `OutputFormat`
2. Реализовать функцию генерации
3. Обновить `generateOutputFormat`

### Поддержка других микроконтроллеров

Для поддержки других микроконтроллеров семейства 8051:

1. Создать новую конфигурацию памяти
2. Адаптировать генераторы выходных форматов
3. Обновить проверки ограничений

## Отладка и диагностика

### Подробный вывод

```bash
hcl-exe program.c -v --format lst -o program
```

Выводит детальную информацию о процессе линковки:
- Загружаемые объектные файлы
- Найденные символы
- Размещение сегментов
- Применённые перемещения
- Использование памяти

### Анализ карты памяти

Файл `.map` содержит подробную информацию о размещении всех символов и сегментов в памяти микроконтроллера.

### Диагностические сообщения

Линковщик генерирует диагностические сообщения трёх уровней:
- **Ошибки** - критические проблемы, препятствующие линковке
- **Предупреждения** - потенциальные проблемы
- **Информация** - полезная информация о процессе

## Заключение

Линковщик HCL обеспечивает надёжное и эффективное объединение объектных файлов в исполняемые образы для микроконтроллера AT89S4051. Он поддерживает все необходимые форматы выходных файлов, выполняет тщательную проверку ограничений памяти и предоставляет подробную диагностику для отладки.

Модульная архитектура линковщика позволяет легко расширять его функциональность для поддержки новых форматов файлов и других микроконтроллеров семейства 8051. 