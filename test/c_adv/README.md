# Тесты C51 для AT89S4051

Набор тестовых файлов для демонстрации продвинутых возможностей программирования микроконтроллера AT89S4051 на языке C51.

## Описание файлов

### Заголовочные файлы
- **common.h** - Общий заголовочный файл с макросами, константами и объявлениями функций

### Тестовые модули

#### test_memory_types.c
Демонстрирует работу с различными типами памяти C51:
- `data` - внутренняя RAM (прямая адресация)
- `idata` - внутренняя RAM (косвенная адресация) 
- `xdata` - внешняя RAM
- `code` - программная память
- Работа с указателями на разные типы памяти
- Оптимизация использования памяти

#### test_bit_operations.c
Тестирует битовые операции и переменные:
- Установка, сброс, инверсия битов
- Битовые переменные C51 (тип `bit`)
- Работа с битами регистров SFR
- Битовые маски и операции

#### test_timer_operations.c
Работа с таймерами 8051:
- Инициализация Timer0 и Timer1
- Различные режимы работы таймеров
- Обработка переполнений
- Генерация точных задержек
- Чтение значений таймеров

#### test_port_operations.c
Операции с портами ввода-вывода:
- Чтение и запись портов
- Работа с отдельными битами портов
- Сканирование портов (бегущий огонек)
- Маскирование и фильтрация сигналов

#### test_interrupt_setup.c
Настройка и обработка прерываний:
- Обработчики прерываний Timer0 и INT0
- Настройка приоритетов прерываний
- Маскирование прерываний
- Глобальное управление прерываниями

#### main_test.c
Главный файл, запускающий все тесты последовательно.

### Система конфигурации

#### compiler_options.json
Основной файл конфигурации с настройками:
- Путь к компилятору и параметры сборки
- Параметры компиляции (целевая платформа, оптимизация)
- Настройки тестирования (verbose режим, остановка на ошибках)
- Список тестовых файлов
- Цветовая схема вывода

#### compiler_options_examples.md
Примеры различных конфигураций для разных сценариев:
- Быстрая проверка синтаксиса
- Отладочная конфигурация
- Производственная сборка
- CI/CD конфигурация

## Компиляция и тестирование

### Автоматическое тестирование нашего компилятора
```powershell
.\compile_tests.ps1
```

### Использование альтернативных конфигураций
```powershell
# Быстрая проверка синтаксиса
Copy-Item "syntax_check_only.json" "compiler_options.json"
.\compile_tests.ps1

# Отладочный режим
Copy-Item "debug_verbose.json" "compiler_options.json"
.\compile_tests.ps1
```

### Настройка конфигурации

Отредактируйте `compiler_options.json` для изменения:

#### Параметры компилятора:
```json
{
  "compiler": {
    "executable": "..\\..\\app\\c51_compiler.exe",
    "timeout_seconds": 30
  },
  "compilation": {
    "target": "at89s4051",
    "optimize": "speed",
    "memory_model": "small",
    "debug": true
  }
}
```

#### Настройки тестирования:
```json
{
  "testing": {
    "syntax_check_only": false,
    "verbose_output": true,
    "stop_on_first_error": false,
    "generate_report": true
  }
}
```

## Требования

- Наш компилятор C51 (собирается автоматически)
- PowerShell 5.0+
- Микроконтроллер AT89S4051
- Файлы reg2051.h (должны быть скопированы в директорию)

## Особенности реализации

### Соответствие C89
Все файлы строго соответствуют стандарту C89:
- Объявления переменных только в начале блоков
- Только C-стиль комментариев (`/* */`)
- Простые макросы без сложных конструкций

### Оптимизация для 8051
- Минимальное использование стека
- Эффективное использование внутренней RAM (128 байт)
- Битовые переменные для экономии памяти
- Оптимизированные алгоритмы для 8-битной архитектуры

### Тестирование нашего компилятора
Скрипт автоматически:
- Проверяет наличие компилятора
- Собирает его при необходимости (`stack build`)
- Тестирует синтаксический анализ
- Компилирует тестовые файлы
- Генерирует отчеты о результатах

### Результаты тестирования
- Консольный вывод с цветовой индикацией
- Подробные отчеты в текстовых файлах
- Созданные HEX файлы для загрузки в микроконтроллер
- Логи ошибок компилятора

## Альтернативные решения

### Вместо сложных макросов:
```c
/* Вместо do-while макросов используются простые выражения */
#define SET_BIT(reg, bit) (reg |= (1 << bit))
```

### Вместо динамической памяти:
```c
/* Статические массивы вместо malloc/free */
unsigned char buffer[MAX_SIZE];
```

### Вместо стандартной библиотеки:
```c
/* Собственные функции вместо printf/scanf */
void debug_output(unsigned char value) {
    P1 = value;  /* Вывод через порт */
}
```

## Критический анализ

**Преимущества подхода:**
- Максимальная совместимость с C89
- Оптимизация под ограничения 8051
- Модульная структура тестов
- Гибкая система конфигурации
- Автоматизированное тестирование компилятора

**Недостатки:**
- Ограниченные возможности отладки без аппаратуры
- Зависимость от правильной настройки конфигурации
- Необходимость ручного копирования заголовочных файлов

**Рекомендации:**
1. Использовать симулятор для первичного тестирования
2. Создать автоматические тесты для различных конфигураций
3. Добавить проверки валидности конфигурационных файлов
4. Реализовать систему логирования через UART

## Структура файлов

```
test/c_adv/
├── common.h                     # Общие определения
├── test_*.c                     # Тестовые модули
├── main_test.c                  # Главный тест
├── compile_tests.ps1            # Скрипт тестирования
├── compiler_options.json        # Основная конфигурация
├── compiler_options_examples.md # Примеры конфигураций
└── README.md                    # Документация
``` 